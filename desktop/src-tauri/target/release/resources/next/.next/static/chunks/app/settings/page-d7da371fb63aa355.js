(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[662],{2374:(e,t,n)=>{"use strict";n.d(t,{J0:()=>s,TE:()=>o,aJ:()=>i,w9:()=>a,yl:()=>r});let i=220,s="moondream:route-fade:start",a="moondream:route-fade:end";function r(){window.dispatchEvent(new Event(s))}function o(){window.dispatchEvent(new Event(a))}},3321:(e,t,n)=>{"use strict";var i=n(4645);n.o(i,"useRouter")&&n.d(t,{useRouter:function(){return i.useRouter}}),n.o(i,"useSearchParams")&&n.d(t,{useSearchParams:function(){return i.useSearchParams}})},6943:(e,t,n)=>{Promise.resolve().then(n.bind(n,9689))},9689:(e,t,n)=>{"use strict";n.d(t,{default:()=>o});var i=n(5155),s=n(2115),a=n(3321),r=n(2374);function o(){let e=(0,a.useRouter)(),t=(0,a.useSearchParams)(),n=t?.get("projectId")??null,[o,c]=(0,s.useState)("enter"),d=(0,s.useRef)(null),l=(0,s.useRef)(!1),u=(0,s.useRef)(n),[x,m]=(0,s.useState)(!1),[p,h]=(0,s.useState)(!1),[g,v]=(0,s.useState)(!1),[f,b]=(0,s.useState)(null),[j,y]=(0,s.useState)(null),[N,z]=(0,s.useState)(!1),[w,k]=(0,s.useState)({storage:{mode:"local"},ai:{provider:"local_station"}}),[S,E]=(0,s.useState)({icloudDir:null,moondreamEndpoint:"http://127.0.0.1:2020",hfEndpointUrl:"https://api-inference.huggingface.co/models/moondream/moondream3-preview",hfTokenSet:!1}),[C,T]=(0,s.useState)(""),P=(0,s.useMemo)(()=>"icloud"!==w.storage.mode?null:w.storage.icloudPath||S.icloudDir,[w.storage.mode,w.storage.icloudPath,S.icloudDir]);(0,s.useEffect)(()=>{let e=!1;return(async()=>{let t=await fetch("/api/settings");if(!t.ok)return;let n=await t.json();e||(k(n.settings),E(n.defaults),m(!0))})().catch(()=>m(!0)),()=>{e=!0}},[]),(0,s.useEffect)(()=>{u.current=n},[n]),(0,s.useEffect)(()=>{(0,r.TE)()},[]),(0,s.useEffect)(()=>{let e=window.requestAnimationFrame(()=>c("entered"));return()=>window.cancelAnimationFrame(e)},[]);let R=()=>{l.current||(l.current=!0,(0,r.yl)(),c("exit"),d.current&&window.clearTimeout(d.current),d.current=window.setTimeout(()=>{let t,n;d.current=null,n=(t=u.current)?`/projects/${t}`:"/",e.push(n)},r.aJ))};(0,s.useEffect)(()=>()=>{d.current&&window.clearTimeout(d.current),d.current=null},[]),(0,s.useEffect)(()=>{let e=e=>{"Escape"===e.key&&(e.preventDefault(),R())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);let D=async e=>{h(!0),v(!1),b(null);try{let t=w.ai.provider,n=w.ai.endpoint?.trim()||void 0,i=C.trim(),s={storage:{mode:w.storage.mode,icloudPath:"icloud"===w.storage.mode&&w.storage.icloudPath?.trim()||void 0},ai:{provider:t,endpoint:n,...e?.clearHfToken?{hfToken:null}:i.length>0?{hfToken:i}:{}}};if(!(await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).ok)throw Error("Failed to save settings");v(!0),e?.clearHfToken?(E(e=>({...e,hfTokenSet:!1})),T("")):i.length>0&&(E(e=>({...e,hfTokenSet:!0})),T(""))}catch(e){b(e.message)}finally{h(!1)}};return(0,i.jsxs)("div",{className:"fixed inset-0 overflow-auto text-zinc-50",children:[(0,i.jsx)("div",{className:`pointer-events-none fixed inset-0 bg-black transition-opacity duration-200 ease-out motion-reduce:transition-none ${"entered"===o||"exit"===o?"opacity-100":"opacity-0"}`}),(0,i.jsxs)("div",{className:`relative mx-auto max-w-3xl px-6 py-10 transition-[opacity,transform] duration-200 ease-out motion-reduce:transition-none ${"entered"===o?"opacity-100 translate-y-0":"opacity-0 translate-y-1"}`,children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-lg font-semibold",children:"Settings"}),(0,i.jsx)("div",{className:"mt-1 text-sm text-zinc-500",children:"Desktop settings apply after restart."})]}),(0,i.jsx)("button",{onClick:()=>{R()},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900",children:"Back"})]}),(0,i.jsxs)("div",{className:"mt-8 rounded-xl border border-zinc-800 bg-zinc-950 p-4",children:[(0,i.jsx)("div",{className:"text-sm font-medium",children:"Storage"}),(0,i.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:"Default is local. Switching storage will move your library (DB + assets) on next app launch. iCloud sync is convenient but SQLite can misbehave if you open the app on two Macs at the same time."}),(0,i.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"storage",checked:"local"===w.storage.mode,onChange:()=>k(e=>({...e,storage:{...e.storage,mode:"local"}})),className:"mt-1"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"Local (recommended)"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Stores data in Application Support on this Mac."})]})]}),(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"storage",checked:"icloud"===w.storage.mode,onChange:()=>{k(e=>({...e,storage:{...e.storage,mode:"icloud",icloudPath:(e.storage.icloudPath??S.icloudDir??void 0)||void 0}}))},className:"mt-1"}),(0,i.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"iCloud Drive"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Stores data in iCloud Drive for syncing between Macs (avoid running on two Macs concurrently)."}),(0,i.jsxs)("div",{className:"mt-3",children:[(0,i.jsx)("div",{className:"text-xs text-zinc-500 mb-1",children:"iCloud path"}),(0,i.jsx)("input",{disabled:"icloud"!==w.storage.mode,value:w.storage.icloudPath??"",onChange:e=>k(t=>({...t,storage:{...t.storage,icloudPath:e.target.value}})),placeholder:S.icloudDir??"iCloud Drive path",className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none disabled:opacity-60"}),(0,i.jsxs)("div",{className:"mt-2 text-[11px] text-zinc-600",children:["Leave blank to use the default: ",(0,i.jsx)("span",{className:"text-zinc-400",children:S.icloudDir??"N/A"})]})]})]})]})]}),f?(0,i.jsx)("div",{className:"mt-4 text-sm text-red-400",children:f}):null,g?(0,i.jsx)("div",{className:"mt-4 rounded-lg border border-amber-900/40 bg-amber-950/20 px-3 py-2 text-sm text-amber-200",children:"Saved. Close and reopen the app to apply storage changes (and move your library if you changed storage)."}):null,(0,i.jsxs)("div",{className:"mt-4 flex items-center gap-3",children:[(0,i.jsx)("button",{disabled:!x||p,onClick:()=>D(),className:"rounded-lg bg-zinc-50 px-4 py-2 text-sm font-medium text-zinc-950 disabled:opacity-60",children:p?"Saving…":"Save"}),"icloud"===w.storage.mode&&P?(0,i.jsxs)("div",{className:"text-xs text-zinc-500",children:["Effective path: ",(0,i.jsx)("span",{className:"text-zinc-300",children:P})]}):null]})]}),(0,i.jsxs)("div",{className:"mt-8 rounded-xl border border-zinc-800 bg-zinc-950 p-4",children:[(0,i.jsx)("div",{className:"text-sm font-medium",children:"AI"}),(0,i.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:"Configure the AI endpoint used by the bundled worker. If you see “failed”, it often means the app couldn’t reach the endpoint at the time."}),(0,i.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"mb-2 text-xs text-zinc-500",children:"Provider"}),(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"ai_provider",checked:"local_station"===w.ai.provider,onChange:()=>k(e=>({...e,ai:{...e.ai,provider:"local_station"}})),className:"mt-1"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"Local Station"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Uses Moondream Station running on your machine."})]})]}),(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"ai_provider",checked:"huggingface"===w.ai.provider,onChange:()=>k(e=>({...e,ai:{...e.ai,provider:"huggingface",endpoint:(e.ai.endpoint||"").trim()?e.ai.endpoint:S.hfEndpointUrl}})),className:"mt-1"}),(0,i.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"Hugging Face Endpoint"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Uses a Hugging Face Inference Endpoint (requires endpoint URL + API token)."})]})]})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"mb-1 text-xs text-zinc-500",children:"huggingface"===w.ai.provider?"Hugging Face endpoint URL":"Moondream Station endpoint"}),(0,i.jsx)("input",{value:w.ai.endpoint??"",onChange:e=>k(t=>({...t,ai:{...t.ai,endpoint:e.target.value}})),placeholder:"huggingface"===w.ai.provider?S.hfEndpointUrl:S.moondreamEndpoint,className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none"}),(0,i.jsx)("div",{className:"mt-2 text-[11px] text-zinc-600",children:"huggingface"===w.ai.provider?(0,i.jsx)(i.Fragment,{children:"Paste the full endpoint URL for your Hugging Face Inference Endpoint."}):(0,i.jsxs)(i.Fragment,{children:["Examples: ",(0,i.jsx)("span",{className:"text-zinc-400",children:"http://127.0.0.1:2021/v1"})," or"," ",(0,i.jsx)("span",{className:"text-zinc-400",children:"http://127.0.0.1:2020"})," (the worker accepts both and normalizes). If ",(0,i.jsx)("span",{className:"text-zinc-400",children:"localhost"})," gives issues, prefer"," ",(0,i.jsx)("span",{className:"text-zinc-400",children:"127.0.0.1"}),"."]})})]}),"huggingface"===w.ai.provider?(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{className:"mb-1 flex items-center justify-between",children:[(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Hugging Face API token"}),S.hfTokenSet?(0,i.jsx)("div",{className:"text-[11px] text-zinc-500",children:"Token saved"}):null]}),(0,i.jsx)("input",{value:C,onChange:e=>T(e.target.value),placeholder:S.hfTokenSet?"•••••••••• (leave blank to keep existing)":"hf_...",type:"password",autoComplete:"off",className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none"}),(0,i.jsx)("div",{className:"mt-2 text-[11px] text-zinc-600",children:"Stored locally in your app settings. The worker uses it as a Bearer token."}),S.hfTokenSet?(0,i.jsx)("div",{className:"mt-2",children:(0,i.jsx)("button",{disabled:!x||p,onClick:()=>D({clearHfToken:!0}),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:"Clear saved token"})}):null]}):null,(0,i.jsxs)("div",{className:"flex items-center gap-3",children:[(0,i.jsx)("button",{disabled:!x||p,onClick:()=>D(),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:p?"Saving…":"Save endpoint"}),(0,i.jsx)("button",{disabled:!n,onClick:async()=>{if(n){b(null),y(null),z(!0);try{let e=await fetch(`/api/projects/${n}/ai/retry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!e.ok)throw Error("Retry failed");let t=await e.json().catch(()=>null),i=t?.changes??0;y(i>0?`Retried ${i} asset(s).`:"No failed assets to retry.")}catch(e){b(e.message)}finally{z(!1)}}},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:N?"Retrying…":"Retry failed AI (this project)"}),n?null:(0,i.jsx)("div",{className:"text-xs text-zinc-600",children:"Open Settings from inside a project to enable this."})]}),j?(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:j}):null]})]})]})]})}}},e=>{e.O(0,[441,794,358],()=>e(e.s=6943)),_N_E=e.O()}]);