(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{2374:(e,t,r)=>{"use strict";r.d(t,{J0:()=>i,TE:()=>o,aJ:()=>n,w9:()=>a,yl:()=>l});let n=220,i="moondream:route-fade:start",a="moondream:route-fade:end";function l(){window.dispatchEvent(new Event(i))}function o(){window.dispatchEvent(new Event(a))}},3135:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,8500,23)),Promise.resolve().then(r.bind(r,4319))},4319:(e,t,r)=>{"use strict";r.d(t,{ProjectWorkspace:()=>$});var n=r(5155),i=r(2115),a=r(3321),l=r(6878);let o="96, 165, 250";function s(e){if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}}function c(e){let{asset:t,projectId:r,onClose:a}=e,l=!!t.mime_type&&t.mime_type.startsWith("video/"),[c,u]=(0,i.useState)(!1),[d,h]=(0,i.useState)(!!e.originRect),f=(0,i.useRef)(!1),m=(0,i.useRef)(null),p=(0,i.useRef)(null),[x,w]=(0,i.useState)(null),[v,g]=(0,i.useState)(null),[y,b]=(0,i.useState)(null),[j,M]=(0,i.useState)("translate(0px,0px) scale(1,1)"),R=(0,i.useRef)(null);(0,i.useMemo)(()=>(function(e){if(!e)return[];try{let t=JSON.parse(e);if(!Array.isArray(t))return[];return t.map(e=>String(e)).filter(Boolean)}catch{return[]}})(t.ai_tags_json),[t.ai_tags_json]);let C=(0,i.useRef)(null),[_,z]=(0,i.useState)(null),N=(0,i.useMemo)(()=>v?x?.find(e=>e.tag===v)??null:null,[x,v]);(0,i.useEffect)(()=>{let e=window.setTimeout(()=>u(!0),0);return()=>window.clearTimeout(e)},[]),(0,i.useEffect)(()=>()=>{m.current&&window.clearTimeout(m.current),p.current&&window.clearTimeout(p.current)},[]);let k=(0,i.useCallback)(()=>{if(f.current)return;f.current=!0,p.current&&(window.clearTimeout(p.current),p.current=null),u(!1);let t=e.originRect??null;if(!t)return void a();let r=(()=>{let e=document.querySelector("[data-asset-lightbox-target='true']");if(!e)return R.current;let t=e.getBoundingClientRect();return t.width>2&&t.height>2?{left:t.left,top:t.top,width:t.width,height:t.height}:R.current})();if(!r)return void a();h(!0),b({position:"fixed",left:r.left,top:r.top,width:r.width,height:r.height,zIndex:1e4,pointerEvents:"none",transition:"transform 240ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 140ms ease-out",transformOrigin:"center center",opacity:1}),M("translate(0px, 0px) scale(1, 1)");let n=t.left+t.width/2,i=t.top+t.height/2,l=r.left+r.width/2,o=r.top+r.height/2,s=n-l,c=i-o,d=t.width/r.width,x=t.height/r.height;requestAnimationFrame(()=>{requestAnimationFrame(()=>M(`translate(${s}px, ${c}px) scale(${d}, ${x})`))}),m.current=window.setTimeout(()=>a(),260)},[a,e.originRect]);(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&k()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[k]),(0,i.useEffect)(()=>{let e=!1;return w(null),g(null),fetch(`/api/projects/${r}/assets/${t.id}/segments`).then(e=>e.ok?e.json():null).then(t=>{if(e)return;let r=t?.segments??null;w(Array.isArray(r)?r:[])}).catch(()=>{e||w([])}),()=>{e=!0}},[t.id,r]);let S=(0,i.useCallback)(()=>{let e=C.current;if(!e)return;let r=e.clientWidth,n=e.clientHeight,i=e.naturalWidth||t.width||0,a=e.naturalHeight||t.height||0;if(!(r>2&&n>2&&i>2&&a>2))return void z(null);let l=Math.min(r/i,n/a),o=i*l,s=a*l;z({offsetX:(r-o)/2,offsetY:(n-s)/2,drawW:o,drawH:s,scale:l})},[t.height,t.width]);return(0,i.useEffect)(()=>{S();let e=()=>S();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[S]),(0,i.useEffect)(()=>{let e=C.current;if(!e)return;let t=new ResizeObserver(()=>S());return t.observe(e),()=>t.disconnect()},[S]),(0,i.useEffect)(()=>{let t=e.originRect??null;if(!t){h(!1),b(null);return}let r=window.setTimeout(()=>{let e=document.querySelector("[data-asset-lightbox-target='true']");if(!e)return void h(!1);let r=e.getBoundingClientRect();if(!(r.width>2&&r.height>2))return void h(!1);let n={left:r.left,top:r.top,width:r.width,height:r.height};R.current=n,b({position:"fixed",left:n.left,top:n.top,width:n.width,height:n.height,zIndex:1e4,pointerEvents:"none",transition:"transform 240ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 140ms ease-out",transformOrigin:"center center",opacity:1});let i=t.left+t.width/2,a=t.top+t.height/2,l=n.left+n.width/2,o=n.top+n.height/2,s=t.width/n.width,c=t.height/n.height;M(`translate(${i-l}px, ${a-o}px) scale(${s}, ${c})`),requestAnimationFrame(()=>{requestAnimationFrame(()=>M("translate(0px, 0px) scale(1, 1)"))}),p.current=window.setTimeout(()=>{h(!1),b(null),p.current=null},260)},0);return()=>window.clearTimeout(r)},[e.originRect,t.id]),(0,n.jsxs)("div",{className:"fixed inset-0 z-[9999] bg-black/80 backdrop-blur transition-opacity duration-200 "+(c?"opacity-100":"opacity-0"),onClick:()=>k(),"aria-modal":"true",role:"dialog",children:[y?(0,n.jsx)("div",{style:{...y,transform:j},children:l?(0,n.jsx)("video",{src:t.storage_url,className:"h-full w-full object-contain",muted:!0,playsInline:!0}):(0,n.jsx)("img",{src:t.storage_url,alt:"",className:"h-full w-full object-contain",draggable:!1})}):null,(0,n.jsxs)("div",{className:"flex h-full w-full flex-col md:flex-row md:gap-0 transition-transform duration-200 ease-out "+(c?"scale-100":"scale-[0.985]"),onClick:e=>e.stopPropagation(),children:[(0,n.jsx)("div",{className:"flex min-h-0 flex-1 items-center justify-center p-4 md:p-8",children:(0,n.jsxs)("div",{className:"relative h-full w-full max-w-[min(1100px,100%)]",children:[l?(0,n.jsx)("video",{"data-asset-lightbox-target":"true",src:t.storage_url,controls:!0,playsInline:!0,className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100")}):(0,n.jsx)("img",{"data-asset-lightbox-target":"true",ref:C,src:t.storage_url,alt:t.original_name||"asset",className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100"),draggable:!1,onLoad:()=>S()}),!d&&N&&_?(0,n.jsxs)("div",{className:"pointer-events-none absolute inset-0",children:[N.svg&&N.svg.trim().startsWith("<svg")?(0,n.jsx)("img",{alt:"",draggable:!1,src:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(N.svg)}`,style:{position:"absolute",left:_.offsetX,top:_.offsetY,width:_.drawW,height:_.drawH,opacity:.22,mixBlendMode:"screen",filter:`drop-shadow(0px 0px 10px rgba(${o}, 0.65))`}}):null,s(N.bboxJson).map((e,t)=>{let r=e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5,i=r?e.x*_.drawW:e.x*_.scale,a=r?e.y*_.drawH:e.y*_.scale,l=r?e.w*_.drawW:e.w*_.scale,s=r?e.h*_.drawH:e.h*_.scale;return(0,n.jsx)("div",{style:{position:"absolute",left:_.offsetX+i,top:_.offsetY+a,width:l,height:s,borderColor:`rgba(${o}, 0.90)`,backgroundColor:`rgba(${o}, 0.10)`,boxShadow:`0 0 18px rgba(${o}, 0.55)`},className:"rounded-sm border-2"},`${N.tag}-${t}`)})]}):null]})}),(0,n.jsxs)("aside",{className:"w-full shrink-0 border-t border-white/10 bg-zinc-950/60 backdrop-blur md:w-[420px] md:border-l md:border-t-0",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between gap-3 border-b border-white/10 p-4",children:[(0,n.jsxs)("div",{className:"min-w-0",children:[(0,n.jsx)("div",{className:"truncate text-sm font-medium text-zinc-100",children:t.original_name}),(0,n.jsxs)("div",{className:"truncate text-xs text-zinc-400",children:[t.width&&t.height?`${t.width}\xd7${t.height}`:"",t.mime_type?t.width&&t.height?` \xb7 ${t.mime_type}`:t.mime_type:"",Number.isFinite(t.byte_size)?` \xb7 ${function(e){if(!Number.isFinite(e)||e<=0)return"0 B";let t=["B","KB","MB","GB","TB"],r=Math.min(t.length-1,Math.floor(Math.log(e)/Math.log(1024))),n=e/Math.pow(1024,r);return`${n.toFixed(n>=10||0===r?0:1)} ${t[r]}`}(t.byte_size)}`:""]})]}),(0,n.jsx)("button",{onClick:()=>k(),className:"inline-flex h-10 w-10 shrink-0 items-center justify-center rounded-full border border-white/10 bg-black/30 text-zinc-200 hover:bg-black/50 focus:outline-none focus:ring-2",style:{"--md-accent-ring":`rgba(${o}, 0.50)`},onFocus:e=>{e.currentTarget.style.boxShadow="0 0 0 2px var(--md-accent-ring)"},onBlur:e=>{e.currentTarget.style.boxShadow=""},"aria-label":"Close",children:(0,n.jsx)("span",{"aria-hidden":"true",className:"text-lg leading-none",children:"\xd7"})})]}),(0,n.jsx)("div",{className:"max-h-[45vh] overflow-auto p-4 md:max-h-none md:h-[calc(100%-57px)]",children:(0,n.jsxs)("div",{className:"space-y-5",children:[(0,n.jsx)("section",{children:(0,n.jsx)("div",{className:"mt-2 space-y-2 text-sm text-zinc-100",children:t.ai_caption?(0,n.jsx)("div",{className:"rounded-lg border border-white/10 bg-black/20 p-3 text-sm text-zinc-100",children:t.ai_caption}):null})}),x?.length?(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"Segments"}),(0,n.jsxs)("div",{className:"mt-2",children:[(0,n.jsxs)("div",{className:"mb-2 flex items-center justify-between gap-2",children:[(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"Click a tag to highlight it on the image."}),v?(0,n.jsx)("button",{onClick:()=>g(null),className:"rounded-md border border-white/10 bg-black/30 px-2 py-1 text-[11px] text-zinc-200 hover:bg-black/50",children:"Clear"}):null]}),(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:x.slice(0,80).map(e=>{let t=e.tag===v;return(0,n.jsx)("button",{type:"button",onClick:()=>g(t=>t===e.tag?null:e.tag),className:"rounded-full border px-2 py-1 text-xs "+(t?"text-zinc-100":"border-white/10 bg-black/20 text-zinc-200 hover:bg-black/30"),style:t?{borderColor:`rgba(${o}, 0.60)`,backgroundColor:`rgba(${o}, 0.15)`}:void 0,title:e.updatedAt,children:e.tag},e.tag)})}),!v||N?.svg||s(N?.bboxJson??null).length?null:(0,n.jsxs)("div",{className:"mt-2 text-xs text-zinc-500",children:["No overlay data cached for"," ",(0,n.jsx)("span",{className:"text-zinc-300",children:v}),"."]})]})]}):null,(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"File"}),(0,n.jsxs)("div",{className:"mt-2 space-y-2 text-xs text-zinc-300",children:[(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"Created:"})," ",t.created_at]}),t.ai_updated_at?(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"AI Updated:"})," ",t.ai_updated_at]}):null]})]})]})})]})]})]})}let u="projectDrafts",d=new Map,h=new Set,f=null;function m(){return f||(f=new Promise((e,t)=>{let r=indexedDB.open("moondream",1);r.onupgradeneeded=()=>{let e=r.result;e.objectStoreNames.contains(u)||e.createObjectStore(u,{keyPath:"projectId"})},r.onsuccess=()=>e(r.result),r.onerror=()=>{let e=r.error??Error("indexedDB.open failed");f=null,t(e)}}))}function p(e){return new Promise((t,r)=>{e.oncomplete=()=>t(),e.onerror=()=>r(e.error??Error("IDB transaction failed")),e.onabort=()=>r(e.error??Error("IDB transaction aborted"))})}async function x(e){var t,r;let n,i,a=d.get(e)??null;if(h.has(e))return a;let l=(await m()).transaction(u,"readonly"),o=l.objectStore(u).get(e),s=await new Promise((e,t)=>{o.onsuccess=()=>e(o.result??null),o.onerror=()=>t(o.error??Error("IDB get failed"))});if(await p(l),h.add(e),!s)return a;if(!a)return d.set(e,s),s;let c=(t=s,n=(r=a).canvas??t.canvas,i=r.view??t.view,{...t,...r,projectId:r.projectId,updatedAt:Math.max(t.updatedAt,r.updatedAt),canvas:n,view:i,dirtyCanvas:null===r.canvas?t.dirtyCanvas:r.dirtyCanvas,dirtyView:null===r.view?t.dirtyView:r.dirtyView,serverCanvasRev:"number"==typeof r.serverCanvasRev?r.serverCanvasRev:t.serverCanvasRev??0,serverViewRev:"number"==typeof r.serverViewRev?r.serverViewRev:t.serverViewRev??0});return d.set(e,c),c}async function w(e){d.set(e.projectId,e);let t=(await m()).transaction(u,"readwrite");t.objectStore(u).put(e),await p(t)}let v=new Map,g=globalThis.requestIdleCallback??((e,t)=>globalThis.setTimeout(()=>e({didTimeout:!0,timeRemaining:()=>0}),Math.max(0,t?.timeout??200)));async function y(e){let t=v.get(e);if(t&&!t.inFlight){t.inFlight=!0;try{let r=t.next;if(await w(r),t.inFlight=!1,t.next===r){t.resolve(r),v.delete(e);return}t.scheduled||(t.scheduled=!0,g(()=>{let t=v.get(e);t&&(t.scheduled=!1,y(e))},{timeout:t.timeoutMs}))}catch(r){t.inFlight=!1,t.reject(r),v.delete(e)}}}async function b(e,t){return await function(e,t,r){let n={...d.get(e)??{projectId:e,updatedAt:0,canvas:null,view:null,dirtyCanvas:!1,dirtyView:!1,serverCanvasRev:0,serverViewRev:0},...t,projectId:e,updatedAt:t.updatedAt??Date.now()};d.set(e,n);let i=v.get(e);if(i)i.next=n,i.timeoutMs=r?.timeoutMs??i.timeoutMs;else{let t,a,l=new Promise((e,r)=>{t=e,a=r});i={next:n,timeoutMs:r?.timeoutMs??300,scheduled:!1,inFlight:!1,promise:l,resolve:t,reject:a},v.set(e,i)}return i.scheduled||i.inFlight||(i.scheduled=!0,g(()=>{(i=v.get(e))&&(i.scheduled=!1),y(e)},{timeout:i.timeoutMs})),i.promise}(e,t,{timeoutMs:300})}let j="#0a0a0a",M={bgHex:592139,bgAlpha:.88,strokeHex:0xffffff,strokeAlpha:.1,shadeAlpha:.28};function R(e,t,r){return Math.max(t,Math.min(r,e))}function C(e){for(let t of[e?.source?.resource,e?.source?.resource?.source,e?.source?.resource?.domElement,e?.baseTexture?.resource,e?.baseTexture?.resource?.source,e?.baseTexture?.resource?.domElement,e?.baseTexture?.source?.resource,e?.baseTexture?.source?.resource?.source])if(t){if("undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement)return t;if("undefined"!=typeof HTMLVideoElement&&t?.source instanceof HTMLVideoElement)return t.source;if("undefined"!=typeof HTMLVideoElement&&t?.domElement instanceof HTMLVideoElement)return t.domElement;if("undefined"!=typeof HTMLVideoElement&&t?.element instanceof HTMLVideoElement)return t.element}return null}function _(e,t){e.clear(),e.roundRect(0,0,220,160,10),e.fill({color:t.bgHex,alpha:t.bgAlpha}),e.stroke({color:t.strokeHex,width:1,alpha:t.strokeAlpha})}function z(e,t,r,n){let i=e.texture?.orig?.width??0,a=e.texture?.orig?.height??0;if(i<=0||a<=0||t<=0||r<=0)return null;let l=Math.abs(i*(e.scale?.x??1)),o=Math.abs(a*(e.scale?.y??1));if(l<=0||o<=0)return null;let s=e.rotation??0,c=Math.abs(Math.cos(s)),u=Math.abs(Math.sin(s)),d=c*l+u*o,h=u*l+c*o;if(d<=0||h<=0)return null;let f=R(n,.1,.98);return R(Math.min(t*f/d,r*f/h),.01,1)}function N(e){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)return;let n=Math.min(22,t/2,r/2),i=e.__roundMask;i||((i=new l.A1g).eventMode="none",i.visible=!0,e.__roundMask=i,e.addChild(i),e.mask=i),i.clear(),i.roundRect(-t/2,-r/2,t,r,n),i.fill(0xffffff)}function k(e,t,r,n,i){e.clear();let a=R(i,0,1),l=.1+.06*a,o=6+4*a,s=18+10*a;for(let i=0;i<8;i++){let a=i/7,c=s*(.2+1.05*a),u=(1-a)*(1-a)*l*.45,d=Math.min(n+c,(t+2*c)/2,(r+2*c)/2);e.roundRect(-t/2-c+o,-r/2-c+o,t+2*c,r+2*c,d),e.fill({color:0,alpha:u})}}function S(e){let t=e.projectId,r=e.initialObjects,a=e.initialView??null,o=e.onObjectsChange,s=e.initialSync??null,u=(0,i.useRef)(null),d=(0,i.useRef)(null),h=(0,i.useRef)(null),f=(0,i.useRef)(null),m=(0,i.useRef)(null),p=(0,i.useRef)(null),w=(0,i.useRef)(null),v=(0,i.useRef)(new Set),g=(0,i.useRef)(new Map),y=(0,i.useRef)(new Map),S=(0,i.useRef)(new Map),T=(0,i.useRef)(new Map),E=(0,i.useRef)(new Map),I=(0,i.useRef)(new Set),A=(0,i.useRef)(new Map),F=(0,i.useRef)(null),L=(0,i.useRef)(!1),O=(0,i.useRef)(null),$=(0,i.useRef)(new Map),D=(0,i.useRef)([]),B=(0,i.useRef)(new Map),V=(0,i.useRef)(new Map),P=(0,i.useRef)(new Set),U=(0,i.useRef)(null),H=(0,i.useRef)(0),W=(0,i.useRef)(null),X=(0,i.useRef)(new Map),q=(0,i.useRef)(new Map),K=(0,i.useRef)(new Set),J=(0,i.useRef)(null),Y=(0,i.useRef)(null),G=(0,i.useRef)(null),Z=(0,i.useRef)({}),Q=(0,i.useRef)(null),ee=(0,i.useRef)(!1),et=(0,i.useRef)(null),er=(0,i.useRef)(null),en=(0,i.useRef)(null),ei=(0,i.useRef)(null),ea=()=>{ei.current=null},el=(e,t)=>{let r=h.current;if(!r)return!1;let n={x:r.position.x,y:r.position.y,zoom:r.scale.x||1},i=R(t?.durationMs??280,80,1200);return .01>Math.abs(n.x-e.x)&&.01>Math.abs(n.y-e.y)&&1e-6>Math.abs(n.zoom-e.zoom)?(r.position.set(e.x,e.y),r.scale.set(e.zoom),t?.onComplete?.()):ei.current={startMs:performance.now(),durationMs:i,from:n,to:e,onComplete:t?.onComplete},!0},eo=(e,t)=>Math.hypot(e.x-t.x,e.y-t.y,(e.zoom-t.zoom)*650),[es,ec]=(0,i.useState)(r),[eu,ed]=(0,i.useState)(e.initialAssets),[eh,ef]=(0,i.useState)([]),[em,ep]=(0,i.useState)(null),[ex,ew]=(0,i.useState)(null),[ev,eg]=(0,i.useState)([]),ey=(0,i.useRef)([]);ey.current=ev;let eb=(0,i.useRef)(e.initialAssets);(0,i.useEffect)(()=>{eb.current=eu},[eu]);let[ej,eM]=(0,i.useState)(null),eR=(0,i.useRef)(null),[eC,e_]=(0,i.useState)(!0),[ez,eN]=(0,i.useState)(!1),[ek,eS]=(0,i.useState)(()=>({online:!0,dirtyCanvas:!1,dirtyView:!1,syncing:!1})),eT=(0,i.useRef)(s?.canvasRev??0),eE=(0,i.useRef)(s?.viewRev??0),eI=(0,i.useRef)(null),eA=(0,i.useRef)(null),eF=(0,i.useRef)(null),eL=(0,i.useRef)(null);(0,i.useEffect)(()=>{eT.current=s?.canvasRev??0,eE.current=s?.viewRev??0,ew(null)},[t]),(0,i.useEffect)(()=>{eg([])},[t]);let eO=async()=>{let e=ey.current,t=e.length?e[e.length-1]:null;if(t&&(eg(e=>e.length?e.slice(0,-1):e),ef([]),ed(t.prevAssets),ec(t.prevObjects),e9(t.prevObjects),await tr(t.prevObjects),ti(),t.deletedAssetIds.length))for(let e of t.deletedAssetIds)await fetch(`/api/assets/${e}/restore`,{method:"POST"}).catch(()=>{})},e$=(0,i.useRef)(null);e$.current=eO;let eD=(0,i.useRef)({canvas:!1,view:!1}),eB=(0,i.useRef)(null),eV=(0,i.useRef)(null),eP=(0,i.useRef)(null),[eU,eH]=(0,i.useState)(null),eW=(e,t,r)=>{let n=d.current,i=f.current,a=U.current;if(!n||!i||!a)return;a.active=!0,a.timeSec=0,a.uniforms.uniforms.uTime=0,a.uniforms.uniforms.uCenter.set(.5,.5),a.uniforms.uniforms.uAspect=n.renderer.width/Math.max(1,n.renderer.height);let l="number"==typeof r?.amplitude&&Number.isFinite(r.amplitude)?r.amplitude:.0032,o="number"==typeof r?.durationSec&&Number.isFinite(r.durationSec)?r.durationSec:2.75;a.uniforms.uniforms.uAmplitude=R(l,5e-4,.02),a.uniforms.uniforms.uDuration=R(o,.25,10),a.uniforms.uniforms.uShapeAspect=R(Number(r?.shapeAspect??1)||1,.05,20),a.uniforms.uniforms.uShapeRotation=Number(r?.shapeRotation??0)||0,i.filters&&0!==i.filters.length?i.filters.includes(a.filter)||(i.filters=[a.filter,...i.filters]):i.filters=[a.filter]},eX=(e,t)=>{let r=W.current;if(!r||r.fired||(r.objectIds?.[0]??null)!==e)return;let n=Number(t?.orig?.width??0),i=Number(t?.orig?.height??0);if(!(n>0&&i>0))return;r.fired=!0;{let t=d.current,r=h.current,n=g.current.get(e);if(t&&r&&n){let e=z(n,t.renderer.width,t.renderer.height,.88)??r.scale.x,i=n.position,a=t.renderer.width/2-i.x*e,l=t.renderer.height/2-i.y*e;ea(),el({x:a,y:l,zoom:e},{durationMs:360,onComplete:()=>{let e=h.current;e&&(tn({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),ti())}})}}let a=w.current;if(a)for(let e of r.objectIds){let t=g.current.get(e);if(!t)continue;let r=y.current.get(e);r&&a.addChild(r),a.addChild(t),v.current.add(e)}(e=>{if(!e||0===e.length)return;let t=performance.now();for(let r of e)q.current.set(r,t),X.current.set(r,1),K.current.add(r)})(r.objectIds);let l=d.current;eW((l?.renderer?.width??0)/2,(l?.renderer?.height??0)/2,{shapeAspect:n/i,shapeRotation:0,amplitude:.0046,durationSec:3.4}),W.current=null},eq=(0,i.useRef)(r),eK=(0,i.useRef)(new Map);(0,i.useEffect)(()=>{eq.current=es;let e=new Map;for(let t of es)e.set(t.id,t);eK.current=e},[es]);let eJ=(0,i.useRef)(M),eY=(0,i.useRef)(M.shadeAlpha);(0,i.useEffect)(()=>{D.current=eh},[eh]),(0,i.useEffect)(()=>ed(e.initialAssets),[e.initialAssets]),(0,i.useEffect)(()=>{ec(r),eR.current=null,eD.current={canvas:!1,view:!1},e_(!0),eS(e=>({...e,dirtyCanvas:!1,dirtyView:!1,syncing:!1}))},[t]),(0,i.useEffect)(()=>{if(!eC)return void eN(!1);let e=window.setTimeout(()=>eN(!0),150);return()=>window.clearTimeout(e)},[eC,t]);let eG=e=>{eD.current.canvas!==e&&(eD.current.canvas=e,eS(t=>({...t,dirtyCanvas:e})))},eZ=e=>{eD.current.view!==e&&(eD.current.view=e,eS(t=>({...t,dirtyView:e})))};(0,i.useEffect)(()=>{let e=()=>eS(e=>({...e,online:navigator.onLine}));return e(),window.addEventListener("online",e),window.addEventListener("offline",e),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",e)}},[]),(0,i.useEffect)(()=>{let e=!1;return(async()=>{let n=!1;try{let i=await x(t);if(e)return;if(!i){eG(!1),eZ(!1),b(t,{canvas:r,view:a,dirtyCanvas:!1,dirtyView:!1,serverCanvasRev:eT.current,serverViewRev:eE.current}).catch(()=>{});return}eG(!!i.dirtyCanvas),eZ(!!i.dirtyView),n=(i.dirtyCanvas||i.dirtyView)&&"undefined"!=typeof navigator&&navigator.onLine;let l=Math.max(0,...r.map(e=>Date.parse(e.updated_at||e.created_at||"")).filter(e=>Number.isFinite(e)));if(i.canvas&&(i.dirtyCanvas||i.updatedAt>l)&&(ec(i.canvas),o?.(i.canvas)),i.view){eR.current=i.view;let e=h.current;if(e){e.position.set(i.view.world_x,i.view.world_y);let t=Number.isFinite(i.view.zoom)?i.view.zoom:1;e.scale.set(R(t,.01,1))}}"number"==typeof i.serverCanvasRev&&(eT.current=i.serverCanvasRev),"number"==typeof i.serverViewRev&&(eE.current=i.serverViewRev)}catch{}finally{if(!e&&n)try{await Promise.race([eQ(),new Promise(e=>window.setTimeout(e,250))])}catch{}e||e_(!1)}})(),()=>{e=!0}},[t,r,o]);let eQ=async()=>{if(eB.current)return eB.current;if(!("undefined"!=typeof navigator?navigator.onLine:ek.online))return;let e=(async()=>{eS(e=>({...e,syncing:!0}));try{let e=await x(t);if(!e)return;let r=!!e.dirtyCanvas,n=!!e.dirtyView;if(r&&e.canvas)try{await e7(e.canvas),r=!1,await b(t,{canvas:e.canvas,dirtyCanvas:!1}).catch(()=>{}),await b(t,{serverCanvasRev:eT.current}).catch(()=>{})}catch{}if(n&&e.view)try{await te(e.view),n=!1,await b(t,{view:e.view,dirtyView:!1}).catch(()=>{}),await b(t,{serverViewRev:eE.current}).catch(()=>{})}catch{}eG(r),eZ(n)}finally{eS(e=>({...e,syncing:!1})),eB.current=null}})();return eB.current=e,e};(0,i.useEffect)(()=>{if(!ek.online||!ek.dirtyCanvas&&!ek.dirtyView)return;eQ();let e=window.setInterval(()=>void eQ(),3e3);return()=>window.clearInterval(e)},[t,ek.online,ek.dirtyCanvas,ek.dirtyView]);let e0=(0,i.useRef)(null),e1=(0,i.useRef)(null),e2=(0,i.useRef)(null),e5=(0,i.useRef)(null),e3=(0,i.useRef)(null),e9=e=>{!o||(e3.current=e,e5.current||(e5.current=window.setTimeout(()=>{e5.current=null;let e=e3.current;e3.current=null,e&&o?.(e)},0)))},e4=()=>{window.setTimeout(()=>ew(null),3500)},e6=async()=>{try{let e=await fetch(`/api/projects/${t}/canvas`);if(!e.ok)return;let r=await e.json().catch(()=>null),n=r?.objects??[],i="number"==typeof r?.canvasRev?r.canvasRev:null;ec(n),e9(n),ti(),eG(!1),b(t,{canvas:n,dirtyCanvas:!1}).catch(()=>{}),null!==i&&(eT.current=i,b(t,{serverCanvasRev:i}).catch(()=>{})),ew("Synced latest board from disk (iCloud)."),e4()}catch{}},e8=async()=>{try{let e=await fetch(`/api/projects/${t}/view`);if(!e.ok)return;let r=await e.json().catch(()=>null),n=r?.view??null,i="number"==typeof r?.viewRev?r.viewRev:null;if(!n)return;eR.current=n;let a=h.current;if(a){a.position.set(n.world_x,n.world_y);let e=Number.isFinite(n.zoom)?n.zoom:1;a.scale.set(R(e,.01,1))}eZ(!1),b(t,{view:n,dirtyView:!1}).catch(()=>{}),null!==i&&(eE.current=i,b(t,{serverViewRev:i}).catch(()=>{})),ew("Synced latest view from disk (iCloud)."),e4()}catch{}},e7=async e=>{if(eI.current)return eA.current=e,eI.current;let r=(async()=>{let r=await fetch(`/api/projects/${t}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:e,baseCanvasRev:eT.current??0})});if(409===r.status){ew("Board is newer on iCloud. Reloading latest…"),await e6();return}if(!r.ok)throw Error(`canvas_save_failed:${r.status}`);let n=await r.json().catch(()=>null);n&&"number"==typeof n.canvasRev&&(eT.current=n.canvasRev,b(t,{serverCanvasRev:eT.current}).catch(()=>{}))})().catch(()=>{}).finally(()=>{eI.current=null});eI.current=r,await r;let n=eA.current;eA.current=null,n&&await e7(n)},te=async e=>{if(eF.current)return eL.current=e,eF.current;let r=(async()=>{let r=await fetch(`/api/projects/${t}/view`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,baseViewRev:eE.current??0})});if(409===r.status){ew("View is newer on iCloud. Reloading latest…"),await e8();return}if(!r.ok)throw Error(`view_save_failed:${r.status}`);let n=await r.json().catch(()=>null);n&&"number"==typeof n.viewRev&&(eE.current=n.viewRev,b(t,{serverViewRev:eE.current}).catch(()=>{}))})().catch(()=>{}).finally(()=>{eF.current=null});eF.current=r,await r;let n=eL.current;eL.current=null,n&&await te(n)},tt=e=>{eV.current&&window.clearTimeout(eV.current),eV.current=window.setTimeout(()=>{b(t,{canvas:e,dirtyCanvas:!0}).catch(()=>{})},40),eG(!0),e0.current&&window.clearTimeout(e0.current),e0.current=window.setTimeout(async()=>{try{await e7(e),b(t,{canvas:e,dirtyCanvas:!1}).catch(()=>{}),eG(!1)}catch{eG(!0)}},250),ti()},tr=async e=>{eV.current&&(window.clearTimeout(eV.current),eV.current=null),b(t,{canvas:e,dirtyCanvas:!0}).catch(()=>{}),eG(!0),e0.current&&(window.clearTimeout(e0.current),e0.current=null);try{await e7(e),b(t,{canvas:e,dirtyCanvas:!1}).catch(()=>{}),eG(!1)}catch{eG(!0)}},tn=e=>{eP.current&&window.clearTimeout(eP.current),eP.current=window.setTimeout(()=>{b(t,{view:e,dirtyView:!0}).catch(()=>{})},60),eZ(!0),e1.current&&window.clearTimeout(e1.current),e1.current=window.setTimeout(async()=>{try{await te(e),b(t,{view:e,dirtyView:!1}).catch(()=>{}),eZ(!1)}catch{eZ(!0)}},250)},ti=()=>{e2.current&&window.clearTimeout(e2.current),e2.current=window.setTimeout(async()=>{let t=d.current,r=J.current;if(!t||!r)return;let n=r.content,i=r.spriteById,a=1/0,o=1/0,s=-1/0,c=-1/0;for(let e of g.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;a=Math.min(a,e.position.x-n),s=Math.max(s,e.position.x+n),o=Math.min(o,e.position.y-i),c=Math.max(c,e.position.y+i)}if(!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(s)||!Number.isFinite(c))return;let u=Math.max(Math.max(1,s-a),Math.max(1,c-o)),h=Math.max(24,.08*u),f=(a+s)/2,m=(o+c)/2,p=new Set;for(let e of g.current.values()){let t=e.__objectId;if(!t)continue;let r=e.texture,a=r?.orig?.width??0,o=r?.orig?.height??0;if(a<=0||o<=0)continue;p.add(t);let s=i.get(t);s?s.texture!==r&&(s.texture=r):((s=new l.kxk(r)).anchor.set(.5),s.eventMode="none",n.addChild(s),i.set(t,s)),s.position.copyFrom(e.position),s.scale.copyFrom(e.scale),s.rotation=e.rotation,s.alpha=1}for(let[e,t]of i.entries())p.has(e)||(t.destroy({children:!0,texture:!1}),i.delete(e));let x=256/(u+2*h);n.scale.set(x),n.position.set(128-f*x,128-m*x),t.renderer.render({container:r.root,target:r.rt,clear:!0,clearColor:657930});let w=t.renderer.extract.canvas({target:r.rt}),v=null;if(w?.convertToBlob?(v=await w.convertToBlob({type:"image/webp",quality:.75}).catch(()=>null))||(v=await w.convertToBlob({type:"image/png"}).catch(()=>null)):w?.toBlob&&(v=await new Promise(e=>w.toBlob(e,"image/webp",.75))??await new Promise(e=>w.toBlob(e,"image/png"))),!v)return;let y=await v.arrayBuffer();await fetch(`/api/projects/${e.projectId}/preview`,{method:"PUT",headers:{"Content-Type":v.type||"image/webp"},body:y}).catch(()=>{})},1200)},ta=(0,i.useMemo)(()=>{let e=new Map;for(let t of eu)e.set(t.id,t);return e},[eu]);(0,i.useMemo)(()=>new Set(eh),[eh]),1===eh.length&&eh[0];let tl=e=>{let t=F.current;if(t!==e){if(F.current=e,t){let e=A.current.get(t);e&&(e.visible=!1)}if(e){let t=A.current.get(e);t&&(t.visible=!0)}}},to=()=>{for(let[e,t]of B.current.entries()){try{t.destroy({children:!0})}catch{}B.current.delete(e)}},ts=(e,t)=>{let r=R(t,0,1);for(let t of e){let e=V.current.get(t)??{current:0,target:0};e.target=r,V.current.set(t,e),P.current.add(t)}},tc=(t,r)=>{let n=g.current.get(t);if(!n)return;let i=e.highlightOverlay;if(!i||i.assetId!==r)return;let a=n.texture?.orig?.width??0,o=n.texture?.orig?.height??0;if((a<=0||o<=0)&&ta.get(r)){let e=ta.get(r);a=e.width??0,o=e.height??0}if(a<=0||o<=0)return;let s=new l.mcf;if(s.eventMode="none",i.svg&&i.svg.trim().startsWith("<svg")){let e=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(i.svg)}`,t=l.gPd.from(e),r=new l.kxk(t);r.anchor.set(.5),r.width=a,r.height=o,r.alpha=.22,r.tint=6333946,r.blendMode="screen",s.addChild(r)}let c=(e=>{if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}})(i.bboxJson);if(c.length){let e=c.every(e=>e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5),t=new l.A1g;for(let r of(t.eventMode="none",c)){let n=e?r.x*a:r.x,i=e?r.y*o:r.y,l=e?r.w*a:r.w,s=e?r.h*o:r.h,c=-a/2+n,u=-o/2+i;t.rect(c,u,l,s),t.fill({color:6333946,alpha:.1}),t.stroke({color:6333946,alpha:.85,width:3})}s.addChild(t)}n.addChild(s),B.current.set(t,s)};(0,i.useEffect)(()=>{to();let t=e.highlightOverlay;if(t){for(let e of es)"image"===e.type&&e.asset_id&&e.asset_id===t.assetId&&tc(e.id,e.asset_id);return()=>{to()}}},[e.highlightOverlay,es,ta]),(0,i.useEffect)(()=>{let e=()=>{let e=document.activeElement;return!!(e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.isContentEditable))},t=()=>{let e=d.current,t=h.current;if(!e||!t)return;let r=new l.bRX(e.renderer.width/2,e.renderer.height/2),n=t.toLocal(r),i=R(.1,.01,1),a=r.x-n.x*i,o=r.y-n.y*i;ea(),el({x:a,y:o,zoom:i},{durationMs:260,onComplete:()=>{let e=h.current;e&&(tn({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),ti())}})},r=e=>{let t=d.current,r=h.current;if(!t||!r||e.requireHover&&!L.current)return;let n=1===D.current.length?D.current[0]:null;if(!n)return;let i=g.current.get(n);if(!i)return;let a=r.scale.x||1,o=R(Math.max(1.6*a,z(i,t.renderer.width,t.renderer.height,.88)??null??0,a),.01,1),s=i.position,c=t.renderer.width/2-s.x*o,u=t.renderer.height/2-s.y*o,f={x:r.position.x,y:r.position.y,zoom:r.scale.x||1},m={x:c,y:u,zoom:o},p=new l.bRX(t.renderer.width/2,t.renderer.height/2),x=r.toLocal(p),w=R(.1,.01,1),v={x:p.x-x.x*w,y:p.y-x.y*w,zoom:w},y=eo(f,m)<=eo(f,v)?v:m;ea(),el(y,{durationMs:320,onComplete:()=>{let e=h.current;e&&(tn({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),ti())}})},n=async()=>{let e=D.current;if(!e||0===e.length)return;let t=eq.current??[],r=[...t],n=[...eb.current??[]],i=new Set(e);ef([]);let a=t.filter(e=>!i.has(e.id)),l=new Set;for(let e of t)i.has(e.id)&&"image"===e.type&&e.asset_id&&l.add(e.asset_id);let o=new Set;for(let e of a)"image"===e.type&&e.asset_id&&o.add(e.asset_id);let s=[...l].filter(e=>!o.has(e));ec(a),e9(a),s.length&&ed(e=>e.filter(e=>!s.includes(e.id))),eg(t=>{let i=[...t,{deletedCount:e.length,deletedAssetIds:s,prevObjects:r,prevAssets:n}];return i.length>10?i.slice(i.length-10):i}),window.setTimeout(async()=>{if(await tr(a),ti(),s.length)for(let e of s)await fetch(`/api/assets/${e}`,{method:"DELETE"}).catch(()=>{})},0)},i=i=>{let a=e();if(!a&&("r"===i.key||"R"===i.key)){let e=d.current;if(!e)return;i.preventDefault();let t=f.current,r=t?.filterArea??e.screen;eW(Number(r?.x??0)+Number(r?.width??e.renderer.width)/2,Number(r?.y??0)+Number(r?.height??e.renderer.height)/2,{shapeAspect:3.2,shapeRotation:0});return}if(!a&&("m"===i.key||"M"===i.key)){i.preventDefault(),ee.current=!ee.current;let e=et.current;e&&(ee.current?(e.showUntilMs=1/0,e.targetAlpha=1,e.container.visible=!0):(e.showUntilMs=0,e.targetAlpha=0));return}if(!a&&("0"===i.key||"Digit0"===i.code||"Numpad0"===i.code)){i.preventDefault(),t();return}if(!a&&L.current&&("Space"===i.code||" "===i.key||"Spacebar"===i.key)){i.preventDefault(),r({requireHover:!0});return}if(!a){if((i.metaKey||i.ctrlKey)&&!i.altKey&&("z"===i.key||"Z"===i.key)){ey.current.length&&(i.preventDefault(),e$.current?.());return}if("ArrowLeft"===i.key||"ArrowRight"===i.key||"ArrowUp"===i.key||"ArrowDown"===i.key){i.preventDefault(),(e=>{let t=d.current,r=h.current;if(!t||!r)return;let n=1===D.current.length?D.current[0]:null;if(!n)return;let i=g.current.get(n);if(!i)return;let a=i.position.x,l=i.position.y,o=eq.current??[],s=null,c=1/0;for(let t of o){if(t.id===n)continue;let r=g.current.get(t.id);if(!r)continue;let i=r.position.x-a,o=r.position.y-l;if("left"===e&&!(i<-1e-6)||"right"===e&&!(i>1e-6)||"up"===e&&!(o<-1e-6)||"down"===e&&!(o>1e-6))continue;let u=("left"===e||"right"===e?Math.abs(i):Math.abs(o))+.45*("left"===e||"right"===e?Math.abs(o):Math.abs(i));u<c&&(c=u,s=t.id)}if(!s)return;let u=g.current.get(s);if(!u)return;ef([s]);let f=r.scale.x||1,m=z(u,t.renderer.width,t.renderer.height,.96)??null,p=m?Math.min(f,m):f,x=u.position,w=t.renderer.width/2-x.x*p,v=t.renderer.height/2-x.y*p;ea(),el({x:w,y:v,zoom:p},{durationMs:220,onComplete:()=>{let e=h.current;e&&(tn({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),ti())}})})("ArrowLeft"===i.key?"left":"ArrowRight"===i.key?"right":"ArrowUp"===i.key?"up":"down");return}("Backspace"===i.key||"Delete"===i.key)&&(i.preventDefault(),n())}};window.addEventListener("keydown",i);let a=()=>t(),o=()=>r({requireHover:!1}),s=()=>{e()||n()};return window.addEventListener("moondream:canvas:reset-zoom",a),window.addEventListener("moondream:canvas:focus-toggle",o),window.addEventListener("moondream:canvas:delete-selection",s),()=>{window.removeEventListener("keydown",i),window.removeEventListener("moondream:canvas:reset-zoom",a),window.removeEventListener("moondream:canvas:focus-toggle",o),window.removeEventListener("moondream:canvas:delete-selection",s)}},[]),(0,i.useEffect)(()=>{let e=u.current;if(!e||d.current)return;let t=new l.lgM;return d.current=t,(async()=>{e.style.backgroundColor=j,await t.init({resizeTo:e,background:j,antialias:!0,autoDensity:!0,resolution:window.devicePixelRatio||1}),e.appendChild(t.canvas);let r=new l.mcf;t.stage.addChild(r);let n=new l.mcf;f.current=n,n.filterArea=t.screen,r.addChild(n);let i=new l.mcf;r.addChild(i);let o=new l.mcf;o.sortableChildren=!0,h.current=o,n.addChild(o);let s=new l.mcf;s.sortableChildren=!0,p.current=s,o.addChild(s);let c=new l.mcf;c.sortableChildren=!0,m.current=c,i.addChild(c);let u=new l.mcf;u.sortableChildren=!0,w.current=u,c.addChild(u);let x=`in vec2 aPosition;
out vec2 vTextureCoord;
out vec2 vUvMax;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;

    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
    vUvMax = uOutputFrame.zw * uInputSize.zw;
}`,b=`
in vec2 vTextureCoord;
in vec2 vUvMax;
out vec4 finalColor;

uniform sampler2D uTexture;

uniform float uTime;
uniform vec2 uCenter;     // 0..1 within viewport
uniform float uAmplitude; // UV offset scale
uniform float uFrequency; // wave frequency
uniform float uSpeed;     // ring expansion speed (in UV/sec)
uniform float uWidth;     // ring thickness (in UV)
uniform float uDecay;     // spatial decay
uniform float uAspect;    // width/height
uniform float uShapeAspect;   // image aspect (w/h) for elliptical ripples
uniform float uShapeRotation; // radians (align ellipse to image rotation)
uniform float uDuration;  // seconds

float heightAt(float dist, float radius, float w, float timeFade, float distFade)
{
    float x = dist - radius;
    float frontBand = exp(-(x * x) / (w * w));
    float behindBand = step(x, 0.0) * exp(x / (w * 2.0));
    float aheadFade = smoothstep(w * 3.0, 0.0, x);
    float band = (0.25 * frontBand + 0.75 * behindBand) * aheadFade;
    float phase = x * uFrequency;
    float wave = sin(phase) + 0.35 * sin(phase * 2.15 + 1.3);
    return wave * band * timeFade * distFade * 0.35;
}

void main()
{
    vec2 uvMax = max(vUvMax, vec2(0.000001));
    vec2 uv01 = vTextureCoord / uvMax;
    vec2 pUv = uv01 - uCenter;

    vec2 pScreen = pUv;
    pScreen.x *= uAspect;

    float cs = cos(uShapeRotation);
    float sn = sin(uShapeRotation);
    mat2 rot = mat2(cs, -sn, sn, cs);
    vec2 pr = rot * pScreen;

    float sAspect = max(uShapeAspect, 0.0001);
    vec2 pm = vec2(pr.x / sAspect, pr.y);
    float dist = length(pm);

    float timeFade = clamp(1.0 - (uTime / max(uDuration, 0.001)), 0.0, 1.0);
    float distFade = exp(-uDecay * dist);

    float radius = uTime * uSpeed;
    float w = max(uWidth, 0.0005);

    vec2 dm = dist > 0.00001 ? (pm / dist) : vec2(0.0, 0.0);
    vec2 dr = vec2(dm.x * sAspect, dm.y);
    mat2 rotInv = mat2(cs, sn, -sn, cs);
    vec2 dScreen = rotInv * dr;
    vec2 dir = dScreen;
    dir.x /= max(uAspect, 0.00001);
    float dirLen = length(dir);
    dir = dirLen > 0.00001 ? (dir / dirLen) : vec2(0.0, 0.0);

    float eps = 0.004;
    float h0 = heightAt(dist, radius, w, timeFade, distFade);
    float h1 = heightAt(dist + eps, radius, w, timeFade, distFade);
    float h2 = heightAt(max(0.0, dist - eps), radius, w, timeFade, distFade);
    float dh = (h1 - h2) / (2.0 * eps);
    float dhClamped = clamp(dh, -1.0, 1.0);
    float hClamped = clamp(h0, -1.0, 1.0);

    vec2 perp = vec2(-dir.y, dir.x);
    vec2 disp = (dir * dhClamped + perp * (hClamped * 0.08)) * uAmplitude;

    vec2 uv2_01 = uv01 + disp;
    uv2_01 = clamp(uv2_01, vec2(0.0), vec2(1.0));
    vec2 uv2 = uv2_01 * uvMax;

    // Composite over the workspace background so the ripple remains visible even in "empty" regions
    // (important when the dropped card itself is rendered above the ripple).
    vec4 tex = texture(uTexture, uv2);
    vec3 bg = vec3(0.039215686, 0.039215686, 0.039215686); // #0a0a0a
    vec3 rgb = mix(bg, tex.rgb, tex.a);

    // Add a subtle luminance ripple mostly to background/empty areas (avoid over-wobbling images).
    float bgMask = clamp(1.0 - tex.a, 0.0, 1.0);
    float ring = clamp(abs(hClamped), 0.0, 1.0) * timeFade * distFade * bgMask;
    rgb += ring * 0.11;

    finalColor = vec4(clamp(rgb, 0.0, 1.0), 1.0);
}`,M=new l.k2S({uTime:{value:0,type:"f32"},uCenter:{value:new l.bRX(.5,.5),type:"vec2<f32>"},uAmplitude:{value:.0032,type:"f32"},uFrequency:{value:28,type:"f32"},uSpeed:{value:.36,type:"f32"},uWidth:{value:.18,type:"f32"},uDecay:{value:1.4,type:"f32"},uAspect:{value:1,type:"f32"},uShapeAspect:{value:1,type:"f32"},uShapeRotation:{value:0,type:"f32"},uDuration:{value:2.75,type:"f32"}});U.current={filter:new l.dJT({glProgram:l.M2g.from({vertex:x,fragment:b,name:"workspace-ripple-filter"}),resources:{rippleUniforms:M},padding:0}),uniforms:M,active:!1,timeSec:0};let C=new l.mcf,N=new l.mcf;C.addChild(N),J.current={rt:l.Y7R.create({width:256,height:256,resolution:1}),root:C,content:N,spriteById:new Map};let S=eR.current??a;if(S){o.position.set(S.world_x,S.world_y);let e=Number.isFinite(S.zoom)?S.zoom:1;o.scale.set(R(e,.01,1))}let T=new l.mcf;T.eventMode="none",T.visible=!1,T.alpha=0,t.stage.addChild(T);let B=new l.A1g;_(B,eJ.current),T.addChild(B);let H=new l.A1g;H.roundRect(0,0,220,160,10),H.fill(0xffffff),H.visible=!0,T.addChild(H);let W=new l.mcf;W.mask=H,T.addChild(W);let eo=new l.mcf;W.addChild(eo);let es=new l.A1g;W.addChild(es);let eu=new l.A1g;W.addChild(eu);let ed=new l.A1g;W.addChild(ed);let eh=new l.A1g;W.addChild(eh),et.current={container:T,bg:B,items:eo,spriteById:new Map,shade:es,overlay:eu,viewport:ed,interact:eh,map:null,showUntilMs:0,targetAlpha:0},_(B,eJ.current);let em=new l.mcf;em.zIndex=1e9,Y.current=em,c.addChild(em);let ep=new l.A1g;G.current=ep,em.addChild(ep);let ex=new l.A1g;ex.eventMode="none",ex.zIndex=0x3b9ac9ff,Q.current=ex,c.addChild(ex);let ew=e=>{let t=new l.A1g;return t.eventMode="static",t.cursor="nwse-resize",t.__handle={corner:e},em.addChild(t),t};Z.current={tl:ew("tl"),tr:ew("tr"),br:ew("br"),bl:ew("bl")};let ev=new l.bRX(0,0),eg=(e,r)=>{let n=t.canvas.getBoundingClientRect(),i=(e-n.left)*t.renderer.width/n.width,a=(r-n.top)*t.renderer.height/n.height;return new l.bRX(i,a)},ey=(e,t)=>({tl:new l.bRX(-e/2,-t/2),tr:new l.bRX(e/2,-t/2),br:new l.bRX(e/2,t/2),bl:new l.bRX(-e/2,t/2)});t.canvas.addEventListener("pointerdown",e=>{L.current=!0,ea(),t.canvas.setPointerCapture(e.pointerId),tl(null),ev=eg(e.clientX,e.clientY);{let e=et.current;if(e&&e.container.visible&&e.container.alpha>.25&&e.map){let t=ej(ev.x,ev.y);if(t&&t.x>=0&&t.y>=0&&t.x<=220&&t.y<=160){eb(),e.showUntilMs=performance.now()+1e4,er.current={kind:"minimap",start:t,cur:t},en.current=null,e_(t,t);return}}}let r=t.renderer.events.rootBoundary.hitTest(ev.x,ev.y);en.current={pointerId:e.pointerId,button:e.button??0,startRx:ev.x,startRy:ev.y,moved:!1,objectId:r&&!r.__handle&&r.__objectId?r.__objectId:null,isHandle:!!(r&&r.__handle),shift:e.shiftKey};let n=1===D.current.length?D.current[0]:null;if(r&&r.__handle&&n){let e=r.__handle.corner,t=g.current.get(n),i=t?.texture?.orig?.width??0,a=t?.texture?.orig?.height??0;if(t&&i>0&&a>0){let r=ey(i,a),o="tl"===e?"br":"tr"===e?"bl":"br"===e?"tl":"tr",s=r[e],c=r[o];er.current={kind:"resize",objectId:n,corner:e,fixedWorld:new l.bRX(t.position.x+t.scale.x*c.x,t.position.y+t.scale.y*c.y),localFixed:c,localHandle:s,baseW:i,baseH:a};return}}if(r&&r.__objectId){let t,n=r.__objectId,i=e.shiftKey,a=D.current??[];if(i){let e=new Set(a);e.has(n)?e.delete(n):e.add(n),t=Array.from(e)}else t=a.includes(n)&&a.length>1?a:[n];if(ef(t),ec(e=>{let r=function(e,t){if(!t.length)return e;let r=new Set(t),n=[...e].sort((e,t)=>e.z_index!==t.z_index?e.z_index-t.z_index:e.id.localeCompare(t.id)),i=[...n.filter(e=>!r.has(e.id)),...n.filter(e=>r.has(e.id))],a=new Date().toISOString();return i.map((e,t)=>e.z_index===t?e:{...e,z_index:t,updated_at:a})}(e,t);return e9(r),tt(r),r}),i||!t.length)return;er.current={kind:"move",objectIds:t,last:ev},ts(t,1);return}e.shiftKey||ef([]),er.current={kind:"pan",last:ev}}),t.canvas.addEventListener("pointermove",e=>{L.current=!0;let r=eg(e.clientX,e.clientY),n=en.current;n&&n.pointerId===e.pointerId&&!n.moved&&Math.hypot(r.x-n.startRx,r.y-n.startRy)>6&&(n.moved=!0);let i=er.current;if(!i){let e=t.renderer.events.rootBoundary.hitTest(r.x,r.y);if(e&&e.__handle)return void tl(null);let n=(e&&e.__objectId?e.__objectId:null)??null;return void(n&&I.current.has(n)?tl(n):tl(null))}if("minimap"===i.kind){eb();let e=et.current;if(!e||!e.map)return;e.showUntilMs=performance.now()+1e4;let t=ej(r.x,r.y);if(!t)return;let n={kind:"minimap",start:i.start,cur:t};er.current=n,e_(n.start,n.cur);return}if("pan"===i.kind){eb();let e=r.x-i.last.x,t=r.y-i.last.y;o.position.x+=e,o.position.y+=t,er.current={kind:"pan",last:r},tn({world_x:o.position.x,world_y:o.position.y,zoom:o.scale.x});return}if("move"===i.kind){let e=i.objectIds.map(e=>[e,g.current.get(e)]).filter(([,e])=>!!e);if(0===e.length)return;let t=r.x-i.last.x,n=r.y-i.last.y,a=1/(o.scale.x||1);for(let[r,i]of e){i.position.x+=t*a,i.position.y+=n*a;let e=y.current.get(r);e&&(e.position.x=i.position.x,e.position.y=i.position.y)}er.current={kind:"move",objectIds:i.objectIds,last:r},ec(t=>{let r=new Map(e),n=t.map(e=>{let t=r.get(e.id);return t?{...e,x:t.position.x,y:t.position.y,updated_at:new Date().toISOString()}:e});return e9(n),tt(n),n});return}if("resize"===i.kind){let e=g.current.get(i.objectId);if(!e)return;let t=o.toLocal(r),n=t.x-i.fixedWorld.x,a=t.y-i.fixedWorld.y,l=i.localHandle.x-i.localFixed.x,s=i.localHandle.y-i.localFixed.y,c=n/l,u=a/s,d=Math.max(Math.abs(c),Math.abs(u));c=d,u=d,c=Math.max(.05,c),u=Math.max(.05,u),e.scale.set(c,u),e.position.x=i.fixedWorld.x-c*i.localFixed.x,e.position.y=i.fixedWorld.y-u*i.localFixed.y,ec(t=>{let r=t.map(t=>t.id===i.objectId?{...t,x:e.position.x,y:e.position.y,scale_x:e.scale.x,scale_y:e.scale.y,width:i.baseW*e.scale.x,height:i.baseH*e.scale.y,updated_at:new Date().toISOString()}:t);return e9(r),tt(r),r})}}),t.canvas.addEventListener("pointerup",e=>{let t=er.current;if(t&&"move"===t.kind&&ts(t.objectIds,0),t&&"minimap"===t.kind){let e=et.current,r=h.current,n=d.current;if(e&&e.interact.clear(),e&&e.map&&r&&n){let i=t.start,a=t.cur,o=Math.abs(i.x-a.x),s=Math.abs(i.y-a.y),c=e.map,u=R(Math.min(i.x,a.x),c.pad,c.pad+c.innerW),d=R(Math.min(i.y,a.y),c.pad,c.pad+c.innerH),f=R(Math.max(i.x,a.x),c.pad,c.pad+c.innerW),m=R(Math.max(i.y,a.y),c.pad,c.pad+c.innerH),p=eC(new l.bRX(u,d)),x=eC(new l.bRX(f,m));if(p&&x){let e=Math.min(p.x,x.x),t=Math.max(p.x,x.x),i=Math.min(p.y,x.y),a=Math.max(p.y,x.y),l=Math.max(.001,t-e),c=Math.max(.001,a-i),u=o<10&&s<10,d=u?R(r.scale.x||1,.01,1):R(Math.min(.94*n.renderer.width/l,.94*n.renderer.height/c),.01,1),f=n.renderer.width/2-(e+t)/2*d,m=n.renderer.height/2-(i+a)/2*d;ea(),el({x:f,y:m,zoom:d},{durationMs:u?220:300,onComplete:()=>{let e=h.current;e&&(tn({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),ti())}})}}}er.current=null,ti();let r=en.current;if((en.current=null,r&&!r.moved&&0===r.button)&&!r.shift&&!r.objectId)return}),t.canvas.addEventListener("wheel",e=>{let t;L.current=!0,ea(),e.preventDefault(),eb();let r=eg(e.clientX,e.clientY),n=o.toLocal(r),i=Math.pow(1.16,(e.deltaY>0?-1:1)*R(Math.abs(1===e.deltaMode?16*e.deltaY:2===e.deltaMode?800*e.deltaY:e.deltaY)/100,.35,6)),a=o.scale.x,l=.12+(t=R(i>1?(1-a)/.99:(a-.01)/.99,0,1))*t*(3-2*t)*.88,s=R(a+(a*i-a)*l,.01,1);o.scale.set(s);let c=o.toLocal(r);o.position.x+=(c.x-n.x)*o.scale.x,o.position.y+=(c.y-n.y)*o.scale.y,tn({world_x:o.position.x,world_y:o.position.y,zoom:o.scale.x}),ti()},{passive:!1}),t.canvas.addEventListener("contextmenu",e=>e.preventDefault()),t.canvas.addEventListener("pointerenter",()=>{L.current=!0}),t.canvas.addEventListener("pointerleave",()=>{L.current=!1,tl(null)}),t.canvas.addEventListener("dblclick",e=>{if(er.current)return;let r=eg(e.clientX,e.clientY),n=t.renderer.events.rootBoundary.hitTest(r.x,r.y);if(!n||n.__handle)return;let i=n.__objectId;if(!i)return;let a=eq.current.find(e=>e.id===i);if(!a||"image"!==a.type||!a.asset_id)return;let l=h.current,o=l?.scale.x||1,s=g.current.get(i),c=s?z(s,t.renderer.width,t.renderer.height,.88)??null:null;if(o<(c?R(.75*c,.25,.75):.35))return;let u=t.canvas.getBoundingClientRect(),d=null;if(s&&u.width>0&&u.height>0&&t.renderer.width>0&&t.renderer.height>0)try{let e=s.getBounds(),r=u.left+e.x/t.renderer.width*u.width,n=u.top+e.y/t.renderer.height*u.height,i=e.width/t.renderer.width*u.width,a=e.height/t.renderer.height*u.height;Number.isFinite(r)&&Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(a)&&i>2&&a>2&&(d={left:r,top:n,width:i,height:a})}catch{d=null}eH(d),eM(a.asset_id)});let eb=()=>{let e=et.current;e&&(e.showUntilMs=performance.now()+2500,e.targetAlpha=1,e.container.visible=!0)},ej=(e,t)=>{let r=et.current;return r?new l.bRX(e-r.container.position.x,t-r.container.position.y):null},eC=e=>{let t=et.current;if(!t||!t.map)return null;let r=t.map,n=Math.max(1e-6,r.s),i=r.minX+(e.x-r.offsetX)/n,a=r.minY+(e.y-r.offsetY)/n;return new l.bRX(i,a)},e_=(e,t)=>{let r=et.current;if(!r||!r.map)return;let n=r.map,i=R(Math.min(e.x,t.x),n.pad,n.pad+n.innerW),a=R(Math.min(e.y,t.y),n.pad,n.pad+n.innerH),l=R(Math.max(e.x,t.x),n.pad,n.pad+n.innerW),o=R(Math.max(e.y,t.y),n.pad,n.pad+n.innerH),s=Math.max(0,l-i),c=Math.max(0,o-a);r.interact.clear(),s<=0||c<=0||(r.interact.beginFill(6333946,.1),r.interact.drawRect(i,a,s,c),r.interact.endFill(),r.interact.lineStyle(2,6333946,.95),r.interact.drawRect(i+1,a+1,Math.max(0,s-2),Math.max(0,c-2)))};t.ticker.add(e=>{var r,i,a;m.current&&(m.current.position.set(o.position.x,o.position.y),m.current.scale.set(o.scale.x,o.scale.y),m.current.rotation=o.rotation??0);let s=U.current;if(s&&s.active){s.timeSec+=(e.deltaMS??16.6667)/1e3,s.uniforms.uniforms.uTime=s.timeSec,s.uniforms.uniforms.uAspect=t.renderer.width/Math.max(1,t.renderer.height);let r=Number(s.uniforms.uniforms.uDuration)||1;if(s.timeSec>=r){s.active=!1,s.timeSec=0,n.filters&&n.filters.includes(s.filter)&&(n.filters=n.filters.filter(e=>e!==s.filter)),n.filters&&0===n.filters.length&&(n.filters=[]);let e=v.current,t=p.current;if(t&&e.size){for(let r of[...e]){let e=y.current.get(r),n=g.current.get(r);e&&t.addChild(e),n&&t.addChild(n)}e.clear()}}}let c=ei.current;if(c){let e,t=performance.now(),n=c.durationMs>0?(t-c.startMs)/c.durationMs:1,l=(e=R(n,0,1))*e*(3-2*e),s=(r=c.from.zoom,r+(c.to.zoom-r)*l);o.scale.set(s),o.position.x=(i=c.from.x,i+(c.to.x-i)*l),o.position.y=(a=c.from.y,a+(c.to.y-a)*l),n>=1&&(ei.current=null,c.onComplete?.())}let u=P.current;if(u.size)for(let e of[...u]){let t=V.current.get(e);if(!t){u.delete(e);continue}let r=t.target-t.current;t.current+=.12*r,.001>Math.abs(r)&&(t.current=t.target,u.delete(e));let n=g.current.get(e),i=y.current.get(e);if(!n||!i)continue;let a=n.texture?.orig?.width??0,l=n.texture?.orig?.height??0;if(a<=0||l<=0)continue;let o=Math.min(22,a/2,l/2);k(i,a,l,o,t.current)}let d=K.current;if(d.size){let e=performance.now(),t=e=>1+2.35*Math.pow(e-1,3)+1.35*Math.pow(e-1,2);for(let r of[...d]){let n=q.current.get(r);if(!n){d.delete(r),X.current.delete(r);continue}let i=e-n;if(i>=520)d.delete(r),q.current.delete(r),X.current.set(r,1);else{let e=1;if(i<=110){let t=R(i/110,0,1);e=1+(.92-1)*(1-Math.pow(1-R(t,0,1),3))}else e=.92+.07999999999999996*t(R((i-110)/410,0,1));e=R(e,.6,1.25),X.current.set(r,e)}let a=eK.current.get(r),l=g.current.get(r),o=y.current.get(r),s=X.current.get(r)??1;a&&l&&l.scale.set(a.scale_x*s,a.scale_y*s),a&&o&&o.scale.set(a.scale_x*s,a.scale_y*s)}}(()=>{let e=Y.current,t=G.current;if(!e||!t)return;let r=Z.current,n=D.current,i=1===n.length?n[0]:null,a=i?g.current.get(i):null,l=a?.texture?.orig?.width??0,o=a?.texture?.orig?.height??0;if(!a||l<=0||o<=0){e.visible=!1;return}e.visible=!0,e.position.set(a.position.x,a.position.y),e.rotation=a.rotation,e.scale.set(a.scale.x,a.scale.y);let s=h.current,c=Math.max(1e-4,s?.scale?.x||1),u=Math.max(1e-4,Math.abs(a.scale.x)||1),d=R((.18-c)/.12,0,1);t.clear(),t.rect(-l/2,-o/2,l,o),t.stroke({width:(2.2+ +d)/(u*c),color:6333946,alpha:.9});let f=(9+2*d)/(u*c),m=ey(l,o);for(let e of["tl","tr","br","bl"]){let t=r[e];t&&(t.clear(),t.rect(m[e].x-f/2,m[e].y-f/2,f,f),t.fill(0xf8fafc),t.stroke({width:1.25/(u*c),color:2042167,alpha:.9}),t.__handle={corner:e})}})(),(()=>{let e=Q.current;if(!e)return;let t=D.current;if(!t||t.length<=1)return e.clear();let r=o.scale.x||1,n=2/Math.max(1e-4,r),i=6/Math.max(1e-4,r),a=2/Math.max(1e-4,r);for(let r of(e.clear(),t)){let t=g.current.get(r);if(!t)continue;let l=t.texture?.orig?.width??0,o=t.texture?.orig?.height??0;if(l<=0||o<=0)continue;let s=l*t.scale.x/2+a,c=o*t.scale.y/2+a,u=Math.cos(t.rotation),d=Math.sin(t.rotation),h=(e,r)=>({x:t.position.x+e*u-r*d,y:t.position.y+e*d+r*u}),f=h(-s,-c),m=h(s,-c),p=h(s,c),x=h(-s,c);e.moveTo(f.x,f.y),e.lineTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(f.x,f.y),e.stroke({width:i,color:6333946,alpha:.22}),e.moveTo(f.x,f.y),e.lineTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(f.x,f.y),e.stroke({width:n,color:6333946,alpha:.98})}})(),(()=>{let e=et.current;if(!e)return;e.container.position.set(t.renderer.width-220-12,t.renderer.height-160-12);let r=performance.now();if(ee.current?(e.showUntilMs=1/0,e.targetAlpha=1,e.container.visible=!0):r>e.showUntilMs&&(e.targetAlpha=0),e.container.alpha+=(e.targetAlpha-e.container.alpha)*.18,e.container.alpha<.02&&0===e.targetAlpha){e.container.visible=!1;return}if(!e.container.visible)return;let n=o.toLocal(new l.bRX(0,0)),i=o.toLocal(new l.bRX(t.renderer.width,t.renderer.height)),a=Math.min(n.x,i.x),s=Math.max(n.x,i.x),c=Math.min(n.y,i.y),u=Math.max(n.y,i.y);for(let e of g.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;a=Math.min(a,e.position.x-n),s=Math.max(s,e.position.x+n),c=Math.min(c,e.position.y-i),u=Math.max(u,e.position.y+i)}let d=Math.max(10,.06*Math.max(s-a,u-c));a-=d,s+=d,c-=d,u+=d;let h=Math.max(1,s-a),f=Math.max(1,u-c),m=Math.min(200/h,140/f),p=10+(200-h*m)/2,x=10+(140-f*m)/2,w=e=>p+(e-a)*m,v=e=>x+(e-c)*m;e.map={minX:a,minY:c,maxX:s,maxY:u,s:m,offsetX:p,offsetY:x,pad:10,innerW:200,innerH:140};let y=new Set,b=new Set(D.current??[]);for(let t of g.current.values()){let r=t.__objectId;if(!r)continue;let n=t.texture,i=n?.orig?.width??0,a=n?.orig?.height??0;if(i<=0||a<=0)continue;y.add(r);let o=e.spriteById.get(r);o?o.texture!==n&&(o.texture=n):((o=new l.kxk(n)).anchor.set(.5),o.eventMode="none",e.items.addChild(o),e.spriteById.set(r,o)),o.position.set(w(t.position.x),v(t.position.y)),o.scale.set(t.scale.x*m,t.scale.y*m),o.rotation=t.rotation,o.alpha=b.has(r)?1:.92}for(let[t,r]of e.spriteById.entries())y.has(t)||(r.destroy({children:!1}),e.spriteById.delete(t));if(e.overlay.clear(),b.size>0)for(let t of(e.overlay.lineStyle(2,0xfbbf24,.95),b)){let r=g.current.get(t);if(!r)continue;let n=r.texture,i=n?.orig?.width??0,a=n?.orig?.height??0;if(i<=0||a<=0)continue;let l=i*r.scale.x*m,o=a*r.scale.y*m,s=w(r.position.x),c=v(r.position.y);e.overlay.drawRect(s-l/2,c-o/2,l,o)}e.viewport.clear();let j=w(n.x),M=v(n.y),C=w(i.x),_=v(i.y),z=Math.min(j,C),N=Math.min(M,_),k=Math.abs(C-j),S=Math.abs(_-M),T=210,E=150,I=R(z,10,210),A=R(N,10,E),F=R(z+k,10,T),L=R(N+S,10,E),O=Math.min(I,F),$=Math.min(A,L),B=Math.max(0,Math.abs(F-I)),V=Math.max(0,Math.abs(L-A));e.shade.clear(),e.shade.beginFill(0,eY.current),e.shade.drawRect(10,10,200,Math.max(0,$-10)),e.shade.drawRect(10,$+V,200,Math.max(0,E-($+V))),e.shade.drawRect(10,$,Math.max(0,O-10),V),e.shade.drawRect(O+B,$,Math.max(0,T-(O+B)),V),e.shade.endFill(),e.viewport.beginFill(6333946,.07),e.viewport.drawRect(O,$,B,V),e.viewport.endFill();let P=Math.max(0,B-6),U=Math.max(0,V-6);P>0&&U>0&&(e.viewport.lineStyle(6,6333946,.22),e.viewport.drawRect(O+3,$+3,P,U));let H=Math.max(0,B-2),W=Math.max(0,V-2);H>0&&W>0&&(e.viewport.lineStyle(2,6333946,1),e.viewport.drawRect(O+1,$+1,H,W))})();let f=1===D.current.length?D.current[0]:null,x=f&&I.current.has(f)?f:null,w=O.current;if(w!==x){if(w){let e=E.current.get(w);e&&e.pause()}O.current=x}if(x){let e=E.current.get(x)??null;if(e){e.loop=!0;let t=Date.now(),r=Number($.current.get(x)??0);e.paused&&t-r>250&&($.current.set(x,t),e.play().catch(()=>{}))}}let b=F.current;if(b){let e=g.current.get(b),t=A.current.get(b);if(e&&t){let r=Number(e.texture?.orig?.width??0),n=Number(e.texture?.orig?.height??0);if(r>0&&n>0){let e=E.current.get(b)??null,i=e&&Number.isFinite(e.duration)?Number(e.duration):0,a=e&&Number.isFinite(e.currentTime)?Number(e.currentTime):0,l=i>0?R(a/i,0,1):0,o=Math.min(r,n),s=R(.065*o,10,22),c=R(.045*o,4,10),u=Math.max(10,r-2*s),d=-u/2,h=n/2-s-c,f=Math.min(c/2,6);t.visible=!0,t.clear(),t.roundRect(d,h,u,c,f),t.fill({color:0,alpha:.42}),t.roundRect(d,h,u,c,f),t.stroke({width:1,color:0xffffff,alpha:.1});let m=u*l;if(m>.75){let e=Math.min(f,m/2);t.roundRect(d,h,m,c,e),t.fill({color:6333946,alpha:.92})}}else t.visible=!1}}}),tu(s),ti()})(),()=>{}},[e.projectId]),(0,i.useEffect)(()=>{e.onFocusRequest?.(e=>{let t=h.current,r=d.current;if(!t||!r)return;let n=g.current.get(e);if(!n)return;let i=n.position,a=z(n,r.renderer.width,r.renderer.height,.88)??t.scale.x;ef([e]);let l=r.renderer.width/2-i.x*a,o=r.renderer.height/2-i.y*a;ea(),el({x:l,y:o,zoom:a},{durationMs:340,onComplete:()=>{let e=h.current;e&&(tn({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),ti())}})}),e.onViewportCenterRequest?.(()=>{let e=h.current,t=d.current;if(!e||!t)return{x:0,y:0};let r=new l.bRX(t.renderer.width/2,t.renderer.height/2),n=e.toLocal(r);return{x:n.x,y:n.y}})},[e.projectId]),(0,i.useEffect)(()=>{let e=p.current;e&&tu(e)},[es,ta]);let tu=e=>{let t=new Set(es.map(e=>e.id));for(let[e,r]of g.current.entries())t.has(e)||(r.destroy({children:!0}),g.current.delete(e),E.current.delete(e),I.current.delete(e),A.current.delete(e),V.current.delete(e),P.current.delete(e));for(let[e,r]of y.current.entries())t.has(e)||(r.destroy({children:!0}),y.current.delete(e),E.current.delete(e),I.current.delete(e),A.current.delete(e),V.current.delete(e),P.current.delete(e));for(let t of es){let n=X.current.get(t.id)??1;if(g.current.has(t.id)){let e=g.current.get(t.id);e.position.set(t.x,t.y),e.scale.set(t.scale_x*n,t.scale_y*n),e.rotation=t.rotation,e.zIndex=t.z_index,N(e);let r=y.current.get(t.id);r&&(r.position.set(t.x,t.y),r.scale.set(t.scale_x*n,t.scale_y*n),r.rotation=t.rotation,r.zIndex=t.z_index-.25,V.current.has(t.id)||V.current.set(t.id,{current:0,target:0}));continue}if("image"===t.type&&t.asset_id){var r;let i=ta.get(t.asset_id);if(!i)continue;let a=new l.A1g;a.eventMode="none",a.position.set(t.x,t.y),a.scale.set(t.scale_x*n,t.scale_y*n),a.rotation=t.rotation,a.zIndex=t.z_index-.25,a.__objectId=t.id,y.current.set(t.id,a),V.current.set(t.id,{current:0,target:0}),e.addChild(a);let o=new l.kxk(l.gPd.EMPTY);if(o.eventMode="static",o.cursor="move",o.anchor.set(.5),o.position.set(t.x,t.y),o.scale.set(t.scale_x*n,t.scale_y*n),o.rotation=t.rotation,o.zIndex=t.z_index,o.__objectId=t.id,g.current.set(t.id,o),e.addChild(o),(r=i.mime_type)&&r.startsWith("video/")){I.current.add(t.id);let e=new l.A1g;e.eventMode="none",e.visible=!1,A.current.set(t.id,e),o.addChild(e)}else I.current.delete(t.id);let s=i.storage_url,c=s.startsWith("http")?s:new URL(s,window.location.href).toString(),u=S.current.get(c);if(u){o.texture=u,N(o);let e=C(o.texture);if(e){E.current.set(t.id,e);try{(1===D.current.length?D.current[0]:null)!==t.id&&(e.pause(),Number.isFinite(e.currentTime)&&0!==e.currentTime&&(e.currentTime=0),e.loop=!1)}catch{}}else E.current.delete(t.id);let r=o.texture?.orig?.width??0,n=o.texture?.orig?.height??0;if(r>0&&n>0){let e=Math.min(22,r/2,n/2);k(a,r,n,e,V.current.get(t.id)?.current??0)}eX(t.id,o.texture);continue}let d=T.current.get(c)??l.sP.load(c).then(e=>(S.current.set(c,e),e)).catch(e=>{throw console.error("pixi_texture_load_failed",c,e),e}).finally(()=>{T.current.delete(c)});T.current.set(c,d),d.then(e=>{let r=g.current.get(t.id);if(r){r.texture=e,N(r);let n=C(r.texture);if(n){E.current.set(t.id,n);try{(1===D.current.length?D.current[0]:null)!==t.id&&(n.pause(),Number.isFinite(n.currentTime)&&0!==n.currentTime&&(n.currentTime=0),n.loop=!1)}catch{}}else E.current.delete(t.id);let i=r.texture?.orig?.width??0,a=r.texture?.orig?.height??0;if(i>0&&a>0){let e=Math.min(22,i/2,a/2),r=y.current.get(t.id),n=V.current.get(t.id)?.current??0;r&&k(r,i,a,e,n)}eX(t.id,r.texture)}}).catch(()=>{})}}},td=async t=>{let r;t.preventDefault(),ep(null);let n=d.current,i=h.current;if(!n||!i)return;let a=++H.current,o=Array.from(t.dataTransfer.files||[]);if(0===o.length)return;let s=n.renderer.width/2,c=n.renderer.height/2,u=new FormData;for(let e of o)u.append("files",e,e.name);try{r=await fetch(`/api/projects/${e.projectId}/assets/upload`,{method:"POST",body:u})}catch(e){console.error("upload_failed(fetch)",e),ep("Upload failed (network). If you restarted dev server, refresh the page.");return}if(!r.ok){let e=await r.text().catch(()=>"");console.error("upload_failed(response)",r.status,e),ep(`Upload failed (${r.status}).`);return}let f=(await r.json()).assets||[];ed(e=>{let t=[...f,...e],r=new Set;return t.filter(e=>!r.has(e.id)&&(r.add(e.id),!0))});let m=f.map(()=>globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`);m.length>0&&a===H.current&&(W.current={objectIds:m,fired:!1});let p=new Date().toISOString();ec(t=>{let r=[...t],n=t.reduce((e,t)=>Math.max(e,t.z_index),0)+1;for(let t=0;t<f.length;t++){let a=f[t],o=t%12,u=Math.floor(t/12),d=i.toLocal(new l.bRX(s+28*o+40*u,c+28*o+40*u));r.push({id:m[t],project_id:e.projectId,type:"image",asset_id:a.id,x:d.x,y:d.y,scale_x:1,scale_y:1,rotation:0,width:a.width??null,height:a.height??null,z_index:n++,props_json:null,created_at:p,updated_at:p})}return e9(r),tt(r),r})};return(0,n.jsxs)("div",{onDragOver:e=>e.preventDefault(),onDrop:td,className:"relative h-full w-full",children:[(0,n.jsx)("div",{ref:u,className:"absolute inset-0 "+(eC?"opacity-0 pointer-events-none":"opacity-100")}),ez?(0,n.jsx)("div",{className:"pointer-events-none absolute inset-0 z-40 grid place-items-center",children:(0,n.jsx)("div",{className:"rounded-xl border border-white/10 bg-black/60 px-4 py-3 text-sm text-zinc-200 backdrop-blur",children:"Loading…"})}):null,ek.online?null:(0,n.jsx)("div",{className:"pointer-events-none absolute right-4 top-4 z-50",children:(0,n.jsx)("div",{className:"rounded-full border px-3 py-1 text-[11px] font-medium "+(ek.online?"border-amber-900/40 bg-amber-950/35 text-amber-200":"border-red-900/50 bg-red-950/50 text-red-200"),children:"Offline"})}),em?(0,n.jsx)("div",{className:"pointer-events-none absolute left-1/2 top-10 -translate-x-1/2 rounded-lg border border-red-900/50 bg-red-950/60 px-3 py-2 text-xs text-red-200",children:em}):null,ex?(0,n.jsx)("div",{className:"pointer-events-none absolute left-1/2 top-20 -translate-x-1/2 rounded-lg border border-amber-900/40 bg-amber-950/35 px-3 py-2 text-xs text-amber-200",children:ex}):null,ej&&ta.get(ej)?(0,n.jsx)(c,{projectId:e.projectId,asset:ta.get(ej),originRect:eU,onClose:()=>eM(null)}):null]})}var T=r(5012);function E(e){let[t,r]=(0,i.useState)(!1),[a,l]=(0,i.useState)(""),[o,s]=(0,i.useState)([]),c=(0,i.useRef)(null),u=(0,i.useMemo)(()=>{let t=new Map;for(let r of e.objects)"image"===r.type&&r.asset_id&&t.set(r.asset_id,r.id);return t},[e.objects]);(0,i.useEffect)(()=>{let e=e=>{let t=navigator.platform.toLowerCase().includes("mac")?e.metaKey:e.ctrlKey;"Escape"===e.key&&r(!1);let n=e.key.toLowerCase();if(!e.repeat&&t&&!e.altKey&&"k"===n){e.preventDefault(),r(e=>!e);return}if(!e.repeat&&t&&!e.altKey&&"f"===n){e.preventDefault(),r(!0);return}!function(e){if(!e)return!1;if(e.isContentEditable)return!0;let t=e.tagName?.toLowerCase?.()??"";return!!("input"===t||"textarea"===t||"select"===t||"function"==typeof e.closest&&e.closest('[contenteditable="true"]'))}(e.target)&&(e.repeat||e.altKey||e.metaKey||e.ctrlKey||"f"!==n||(e.preventDefault(),r(!0)))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.useEffect)(()=>{let e=()=>r(e=>!e);return window.addEventListener("moondream:command-palette:toggle",e),()=>window.removeEventListener("moondream:command-palette:toggle",e)},[]),(0,i.useEffect)(()=>{let e=()=>r(!0);return window.addEventListener("moondream:command-palette:open",e),()=>window.removeEventListener("moondream:command-palette:open",e)},[]),(0,i.useEffect)(()=>{if(!t)return;let r=window.setTimeout(async()=>{let t=await fetch(`/api/projects/${e.projectId}/assets/search?q=${encodeURIComponent(a)}&limit=50&mode=hybrid`);t.ok&&s((await t.json()).assets??[])},120);return()=>window.clearTimeout(r)},[t,a,e.projectId]),(0,i.useEffect)(()=>{if(!t)return;let e=window.requestAnimationFrame(()=>{let e=c.current;e&&(e.focus(),e.select())});return()=>window.cancelAnimationFrame(e)},[t]);let d=t?o:[];return(0,n.jsxs)(n.Fragment,{children:[t?(0,n.jsx)("div",{className:"fixed inset-0 z-50 bg-black/40",onClick:()=>r(!1)}):null,(0,n.jsx)("div",{className:t?"fixed left-1/2 top-16 z-50 w-[720px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl":"hidden",children:(0,n.jsxs)(T.uB,{className:"flex flex-col overflow-hidden",children:[(0,n.jsx)("div",{className:"border-b border-zinc-900 p-3",children:(0,n.jsx)(T.uB.Input,{ref:c,autoFocus:!0,value:a,onValueChange:l,placeholder:"Search assets…",className:"w-full bg-transparent text-sm outline-none placeholder:text-zinc-600"})}),(0,n.jsxs)(T.uB.List,{className:"max-h-[420px] overflow-auto p-2",children:[(0,n.jsx)(T.uB.Empty,{className:"p-3 text-sm text-zinc-500",children:"No results."}),d.map(t=>{let i,l=u.get(t.id),o=(i=("done"===t.ai_status?t.ai_caption??"":"").trim())?function(e){let t,r=(e||"").trim();if(!r)return"";let n=(t=[(r=(r=r.replace(/^(the|this)\s+(image|photo|picture|video)\s+(depicts|shows|features|captures)\s+/i,"")).replace(/^(an?|this)\s+(image|photo|picture|video)\s+(of|showing)\s+/i,"")).indexOf("."),r.indexOf(";"),r.indexOf(":"),r.indexOf(" — "),r.indexOf(" – "),r.indexOf(" - "),r.indexOf(", while "),r.indexOf(", with "),r.indexOf(", featuring ")].filter(e=>e>=0)).length?Math.min(...t):-1;n>0&&(r=r.slice(0,n));let i=(r=r.replace(/\s+/g," ").trim()).split(" ").filter(Boolean).slice(0,8).join(" ");return i.length>48&&(i=i.slice(0,48).trimEnd()),i!==r&&(i=i.replace(/[,\-–—:;]+$/g,"").trimEnd()+"…"),i}(i)||i:function(e){let t=(e||"").trim();if(!t)return"";let r=t.lastIndexOf("."),n=r>0?t.slice(0,r):t,i=n.indexOf("--");return(i>0&&(n=n.slice(0,i)),n=(n=n.replace(/-[0-9a-fA-F]{8,}$/g,"")).replace(/[_-]+/g," ").replace(/\s+/g," ").trim())?n.charAt(0).toUpperCase()+n.slice(1):t}(t.original_name)||t.original_name||"Untitled",s=t.ai_status&&"done"!==t.ai_status?t.ai_status:"";return(0,n.jsxs)(T.uB.Item,{value:`${t.original_name} ${t.ai_caption??""}`,onSelect:()=>{r(!1),l?e.onFocusObjectId(l):e.onPlaceAssetAtViewportCenter(t.id);let n=a.trim().split(/\s+/g).filter(Boolean)[0]?.toLowerCase();!n||e.onHighlightAsset&&fetch(`/api/projects/${e.projectId}/assets/${t.id}/segments?term=${encodeURIComponent(n)}`).then(e=>e.ok?e.json():null).then(r=>{r&&e.onHighlightAsset?.({assetId:t.id,term:n,svg:r.svg??null,bboxJson:r.bboxJson??null})}).catch(()=>{})},className:"flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 aria-selected:bg-zinc-900",children:[(0,n.jsx)("div",{className:"h-10 w-10 shrink-0 rounded bg-zinc-900 overflow-hidden",children:t.thumb_url?(0,n.jsx)("img",{src:t.thumb_url,alt:"",className:"h-full w-full object-contain"}):null}),(0,n.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,n.jsx)("div",{className:"truncate",children:o}),s?(0,n.jsx)("div",{className:"truncate text-xs text-zinc-500",children:s}):null]})]},t.id)})]}),(0,n.jsx)("div",{className:"border-t border-zinc-900 p-2 text-xs text-zinc-500"})]})})]})}var I=r(7650),A=r(2374);function F(e){return"undefined"==typeof document?null:(0,I.createPortal)(e.children,document.body)}function L(e){let t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}}function O(e){let t,r=(0,a.useRouter)(),[l,o]=(0,i.useState)(!1),[s,c]=(0,i.useState)([]),[u,d]=(0,i.useState)(null),[h,f]=(0,i.useState)(null),[m,p]=(0,i.useState)(null),[x,w]=(0,i.useState)(null),v=(0,i.useRef)(null),g=(0,i.useRef)(null),[y,b]=(0,i.useState)(!1),[j,M]=(0,i.useState)(null),R=(0,i.useMemo)(()=>s.find(t=>t.id===e.currentProjectId)??null,[s,e.currentProjectId]),C=async()=>{let e=await fetch("/api/projects");e.ok&&c((await e.json()).projects??[])};(0,i.useEffect)(()=>{C()},[]),(0,i.useEffect)(()=>{b(navigator.platform.toLowerCase().includes("mac"))},[]),(0,i.useLayoutEffect)(()=>{l&&v.current&&p(L(v.current))},[l]),(0,i.useLayoutEffect)(()=>{h&&g.current&&w(L(g.current))},[h]);let _=async()=>{if(!j||"new"!==j.type)return;let e=j.name.trim();if(e){d("new");try{let t=await fetch("/api/projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!t.ok)return;let n=await t.json();await C(),o(!1),f(null),M(null),r.push(`/projects/${n.project.id}`)}finally{d(null)}}},z=async e=>{if(!j||"rename"!==j.type||j.project.id!==e.id)return;let t=j.name.trim();if(t){d(e.id);try{if(!(await fetch(`/api/projects/${e.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})})).ok)return;await C(),f(null),M(null)}finally{d(null)}}},N=async t=>{if(j&&"delete"===j.type&&j.project.id===t.id){d(t.id);try{if(!(await fetch(`/api/projects/${t.id}`,{method:"DELETE"})).ok)return;await C(),o(!1),f(null),M(null),t.id===e.currentProjectId&&r.push("/")}finally{d(null)}}};return(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsxs)("button",{ref:v,onClick:()=>{o(e=>!e),f(null)},className:"text"===e.variant?"inline-flex items-center gap-2 px-2 py-1 text-sm font-medium text-zinc-200 hover:text-zinc-50":"inline-flex items-center gap-2 rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{className:"max-w-[220px] truncate",children:R?.name??"Select project"}),(0,n.jsx)("span",{"aria-hidden":!0,className:"text-current",children:(0,n.jsx)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",className:"h-4 w-4",children:(0,n.jsx)("path",{d:"M6 9l6 6 6-6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),(0,n.jsxs)(F,{children:[l&&m?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9998]",onMouseDown:()=>{o(!1),f(null)}}),(0,n.jsxs)("div",{className:"fixed z-[9999] w-[340px] rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl",style:{left:Math.max(8,Math.min(window.innerWidth-340-8,"center"===(t=e.align??"right")?m.left+m.width/2-170:"left"===t?m.left:m.left+m.width-340)),top:m.top+m.height+8},children:[(0,n.jsxs)("div",{className:"flex items-center justify-between border-b border-zinc-900 px-3 py-2",children:[(0,n.jsx)("div",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Projects"}),(0,n.jsx)("button",{onClick:()=>M({type:"new",name:"New project"}),disabled:"new"===u,className:"rounded-md bg-zinc-50 px-2 py-1 text-xs font-medium text-zinc-950 disabled:opacity-60",children:"New"})]}),(0,n.jsx)("div",{className:"max-h-[360px] overflow-auto",children:s.map(t=>{let i=t.id===e.currentProjectId,a=u===t.id;return(0,n.jsxs)("div",{className:`flex items-center gap-2 px-3 py-2 text-sm ${i?"bg-zinc-900/60":"hover:bg-zinc-900"}`,children:[(0,n.jsxs)("button",{disabled:a,onClick:()=>{o(!1),f(null),r.push(`/projects/${t.id}`)},className:"min-w-0 flex-1 text-left flex items-center gap-3",children:[(0,n.jsx)("div",{className:"h-12 w-12 shrink-0 overflow-hidden rounded-lg border border-white/10 bg-zinc-900",children:(0,n.jsx)("img",{src:`/files/projects/${t.id}/preview`,alt:"",className:"h-full w-full object-cover",onError:e=>{e.currentTarget.style.display="none"}})}),(0,n.jsx)("div",{className:"min-w-0 flex-1",children:(0,n.jsx)("div",{className:"truncate text-zinc-200",children:t.name})})]}),(0,n.jsx)("button",{ref:h?.id===t.id?g:null,disabled:a,onClick:e=>{e.stopPropagation(),f(e=>e?.id===t.id?null:t)},className:"rounded-md px-2 py-1 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200",title:"Project actions",children:"⋯"})]},t.id)})}),(0,n.jsxs)("div",{className:"border-t border-zinc-900 p-2",children:[(0,n.jsxs)("button",{onClick:()=>{o(!1),f(null),window.dispatchEvent(new Event("moondream:command-palette:toggle"))},className:"flex w-full items-center justify-between rounded-lg px-2 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{children:"Search board"}),(0,n.jsx)("span",{className:"rounded border border-zinc-800 bg-zinc-900/40 px-1.5 py-0.5 text-[10px] text-zinc-400",children:y?"⌘K":"Ctrl+K"})]}),(0,n.jsxs)("button",{onClick:()=>{o(!1),f(null),(0,A.yl)(),window.setTimeout(()=>{r.push(`/settings?projectId=${encodeURIComponent(e.currentProjectId)}`)},A.aJ)},className:"flex w-full items-center justify-between rounded-lg px-2 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{children:"Settings"}),(0,n.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,n.jsx)("span",{className:"rounded border border-zinc-800 bg-zinc-900/40 px-1.5 py-0.5 text-[10px] text-zinc-400",children:y?"⌘.":"Ctrl+."}),(0,n.jsx)("span",{className:"rounded border border-zinc-800 bg-zinc-900/40 px-1.5 py-0.5 text-[10px] text-zinc-400",children:"."})]})]})]})]})]}):null,h&&x?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9999]",onMouseDown:()=>f(null)}),(0,n.jsxs)("div",{className:"fixed z-[10000] w-40 rounded-lg border border-zinc-800 bg-zinc-950 shadow-xl overflow-hidden",style:{left:Math.min(window.innerWidth-168,x.left+x.width-160),top:x.top+x.height+6},children:[(0,n.jsx)("button",{onClick:()=>M({type:"rename",project:h,name:h.name}),className:"block w-full px-3 py-2 text-left text-sm text-zinc-200 hover:bg-zinc-900",children:"Rename…"}),(0,n.jsx)("button",{onClick:()=>M({type:"delete",project:h}),className:"block w-full px-3 py-2 text-left text-sm text-red-300 hover:bg-zinc-900",children:"Delete…"})]})]}):null,j?(0,n.jsxs)("div",{className:"fixed inset-0 z-[10001]",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/50",onMouseDown:()=>M(null)}),(0,n.jsx)("div",{className:"absolute left-1/2 top-28 w-[420px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 p-4 shadow-2xl",children:"delete"===j.type?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"Delete project?"}),(0,n.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:j.project.name}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>M(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>N(j.project),disabled:u===j.project.id,className:"rounded-md bg-red-500 px-3 py-2 text-sm font-medium text-white disabled:opacity-60",children:"Delete"})]})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"new"===j.type?"New project":"Rename project"}),(0,n.jsx)("input",{autoFocus:!0,value:j.name,onChange:e=>{let t=e.target.value;M(e=>e&&("new"===e.type||"rename"===e.type)?{...e,name:t}:e)},className:"mt-3 w-full rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 outline-none focus:border-zinc-600",placeholder:"Project name"}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>M(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>{"new"===j.type&&_(),"rename"===j.type&&z(j.project)},disabled:"new"===u||"rename"===j.type&&u===j.project.id,className:"rounded-md bg-zinc-50 px-3 py-2 text-sm font-medium text-zinc-950 disabled:opacity-60",children:"Save"})]})]})})]}):null]})]})}function $(e){let{project:t}=e,r=(0,a.useRouter)(),[l,o]=(0,i.useState)(e.initialObjects),[s,c]=(0,i.useState)(null),[u,d]=(0,i.useState)(null),[h,f]=(0,i.useState)(null);return(0,i.useEffect)(()=>{(0,A.TE)();let e=e=>{if("Escape"===e.key||function(e){if(!e)return!1;if(e.isContentEditable)return!0;let t=e.tagName?.toLowerCase?.()??"";return!!("input"===t||"textarea"===t||"select"===t||"function"==typeof e.closest&&e.closest('[contenteditable="true"]'))}(e.target)||e.repeat)return;let n=navigator.platform.toLowerCase().includes("mac")?e.metaKey:e.ctrlKey;"."!==e.key||e.altKey||(e.metaKey||e.ctrlKey)&&!n||(e.preventDefault(),(0,A.yl)(),window.setTimeout(()=>{r.push(`/settings?projectId=${encodeURIComponent(t.id)}`)},A.aJ))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t.id,r]),(0,n.jsxs)("div",{className:"h-screen w-screen bg-zinc-950 text-zinc-50 overflow-hidden",children:[(0,n.jsx)(S,{projectId:t.id,initialAssets:e.initialAssets,initialObjects:l,initialView:e.initialView,initialSync:e.initialSync??null,highlightOverlay:s,onObjectsChange:o,onFocusRequest:e=>d(()=>e),onViewportCenterRequest:e=>f(()=>e)}),(0,n.jsx)("div",{className:"pointer-events-none absolute inset-x-0 top-0 z-40 h-14"}),(0,n.jsx)("div",{className:"absolute left-3 top-3 z-50",children:(0,n.jsx)(O,{currentProjectId:t.id,variant:"text",align:"left"})}),(0,n.jsx)(E,{projectId:t.id,objects:l,onFocusObjectId:e=>u?.(e),onPlaceAssetAtViewportCenter:async e=>{let r=h?.()??{x:0,y:0},n=[...l,{id:globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`,project_id:t.id,type:"image",asset_id:e,x:r.x,y:r.y,scale_x:1,scale_y:1,rotation:0,width:null,height:null,z_index:l.reduce((e,t)=>Math.max(e,t.z_index),0)+1,props_json:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}];o(n),await fetch(`/api/projects/${t.id}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:n})})},onHighlightAsset:e=>c(e)})]})}}},e=>{e.O(0,[22,441,794,358],()=>e(e.s=3135)),_N_E=e.O()}]);