<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reference</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="err" id="err" hidden></div>
      </div>
    </div>

    <script>
      // Optional global injected by Rust (production build).
      // eslint-disable-next-line no-unused-vars
      const __MOONDREAM_PORT__ = 0;
      // Optional log hint injected by Rust (production build).
      // eslint-disable-next-line no-unused-vars
      const __MOONDREAM_LOG_HINT__ = "";
      const errEl = document.getElementById("err");

      function showErr(msg) {
        if (errEl) {
          errEl.hidden = false;
          errEl.textContent = msg;
        }
      }

      async function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      async function getPort() {
        // In production, Rust injects `window.__MOONDREAM_PORT__` via `window.eval(...)`.
        const injected = window.__MOONDREAM_PORT__;
        if (typeof injected === "number" && injected > 0) return injected;

        // Fallback (older builds): if Tauri JS API is present, query via invoke.
        if (!window.__TAURI__?.invoke) return null;
        try {
          return await window.__TAURI__.invoke("server_port");
        } catch {
          return null;
        }
      }

      (async () => {
        // Poll the Rust side until it tells us what port it picked.
        let port = null;
        for (let i = 0; i < 200; i++) {
          port = await getPort();
          if (typeof port === "number" && port > 0) break;
          await sleep(100);
        }
        if (!port) {
          showErr(
            [
              "Failed to start local server (missing port).",
              "",
              "If you're running a dev build, start the web server at http://localhost:3000.",
              __MOONDREAM_LOG_HINT__
                ? `Logs: ${__MOONDREAM_LOG_HINT__}`
                : null,
            ]
              .filter(Boolean)
              .join("\n")
          );
          return;
        }

        // IMPORTANT:
        // The loading page runs on a non-http origin (tauri://), and some WebViews treat
        // `fetch(http://127.0.0.1:PORT/...)` as mixed-content and block it.
        // So we do a direct navigation to the local server; it should be ready quickly.
        const url = `http://127.0.0.1:${port}/`;
        await sleep(150);
        window.location.replace(url);
      })();
    </script>
  </body>
</html>


