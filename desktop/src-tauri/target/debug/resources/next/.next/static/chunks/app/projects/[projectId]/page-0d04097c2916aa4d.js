(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{22:(e,t,r)=>{"use strict";r.d(t,{ProjectWorkspace:()=>D});var n=r(5155),i=r(2115),a=r(3321),l=r(6878);function o(e){if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}}function s(e){let{asset:t,projectId:r,onClose:a}=e,l=!!t.mime_type&&t.mime_type.startsWith("video/"),[s,c]=(0,i.useState)(!1),[d,u]=(0,i.useState)(!!e.originRect),h=(0,i.useRef)(!1),f=(0,i.useRef)(null),m=(0,i.useRef)(null),[p,x]=(0,i.useState)(null),[w,g]=(0,i.useState)(null),[y,v]=(0,i.useState)(null),[b,j]=(0,i.useState)("translate(0px,0px) scale(1,1)"),M=(0,i.useRef)(null);(0,i.useMemo)(()=>(function(e){if(!e)return[];try{let t=JSON.parse(e);if(!Array.isArray(t))return[];return t.map(e=>String(e)).filter(Boolean)}catch{return[]}})(t.ai_tags_json),[t.ai_tags_json]);let _=(0,i.useRef)(null),[N,z]=(0,i.useState)(null),C=(0,i.useMemo)(()=>w?p?.find(e=>e.tag===w)??null:null,[p,w]);(0,i.useEffect)(()=>{let e=window.setTimeout(()=>c(!0),0);return()=>window.clearTimeout(e)},[]),(0,i.useEffect)(()=>()=>{f.current&&window.clearTimeout(f.current),m.current&&window.clearTimeout(m.current)},[]);let k=(0,i.useCallback)(()=>{if(h.current)return;h.current=!0,m.current&&(window.clearTimeout(m.current),m.current=null),c(!1);let t=e.originRect??null;if(!t)return void a();let r=(()=>{let e=document.querySelector("[data-asset-lightbox-target='true']");if(!e)return M.current;let t=e.getBoundingClientRect();return t.width>2&&t.height>2?{left:t.left,top:t.top,width:t.width,height:t.height}:M.current})();if(!r)return void a();u(!0),v({position:"fixed",left:r.left,top:r.top,width:r.width,height:r.height,zIndex:1e4,pointerEvents:"none",transition:"transform 240ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 140ms ease-out",transformOrigin:"center center",opacity:1}),j("translate(0px, 0px) scale(1, 1)");let n=t.left+t.width/2,i=t.top+t.height/2,l=r.left+r.width/2,o=r.top+r.height/2,s=n-l,d=i-o,p=t.width/r.width,x=t.height/r.height;requestAnimationFrame(()=>{requestAnimationFrame(()=>j(`translate(${s}px, ${d}px) scale(${p}, ${x})`))}),f.current=window.setTimeout(()=>a(),260)},[a,e.originRect]);(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&k()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[k]),(0,i.useEffect)(()=>{let e=!1;return x(null),g(null),fetch(`/api/projects/${r}/assets/${t.id}/segments`).then(e=>e.ok?e.json():null).then(t=>{if(e)return;let r=t?.segments??null;x(Array.isArray(r)?r:[])}).catch(()=>{e||x([])}),()=>{e=!0}},[t.id,r]);let R=(0,i.useCallback)(()=>{let e=_.current;if(!e)return;let r=e.clientWidth,n=e.clientHeight,i=e.naturalWidth||t.width||0,a=e.naturalHeight||t.height||0;if(!(r>2&&n>2&&i>2&&a>2))return void z(null);let l=Math.min(r/i,n/a),o=i*l,s=a*l;z({offsetX:(r-o)/2,offsetY:(n-s)/2,drawW:o,drawH:s,scale:l})},[t.height,t.width]);return(0,i.useEffect)(()=>{R();let e=()=>R();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[R]),(0,i.useEffect)(()=>{let e=_.current;if(!e)return;let t=new ResizeObserver(()=>R());return t.observe(e),()=>t.disconnect()},[R]),(0,i.useEffect)(()=>{let t=e.originRect??null;if(!t){u(!1),v(null);return}let r=window.setTimeout(()=>{let e=document.querySelector("[data-asset-lightbox-target='true']");if(!e)return void u(!1);let r=e.getBoundingClientRect();if(!(r.width>2&&r.height>2))return void u(!1);let n={left:r.left,top:r.top,width:r.width,height:r.height};M.current=n,v({position:"fixed",left:n.left,top:n.top,width:n.width,height:n.height,zIndex:1e4,pointerEvents:"none",transition:"transform 240ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 140ms ease-out",transformOrigin:"center center",opacity:1});let i=t.left+t.width/2,a=t.top+t.height/2,l=n.left+n.width/2,o=n.top+n.height/2,s=t.width/n.width,c=t.height/n.height;j(`translate(${i-l}px, ${a-o}px) scale(${s}, ${c})`),requestAnimationFrame(()=>{requestAnimationFrame(()=>j("translate(0px, 0px) scale(1, 1)"))}),m.current=window.setTimeout(()=>{u(!1),v(null),m.current=null},260)},0);return()=>window.clearTimeout(r)},[e.originRect,t.id]),(0,n.jsxs)("div",{className:"fixed inset-0 z-[9999] bg-black/80 backdrop-blur transition-opacity duration-200 "+(s?"opacity-100":"opacity-0"),onClick:()=>k(),"aria-modal":"true",role:"dialog",children:[y?(0,n.jsx)("div",{style:{...y,transform:b},children:l?(0,n.jsx)("video",{src:t.storage_url,className:"h-full w-full object-contain",muted:!0,playsInline:!0}):(0,n.jsx)("img",{src:t.storage_url,alt:"",className:"h-full w-full object-contain",draggable:!1})}):null,(0,n.jsxs)("div",{className:"flex h-full w-full flex-col md:flex-row md:gap-0 transition-transform duration-200 ease-out "+(s?"scale-100":"scale-[0.985]"),onClick:e=>e.stopPropagation(),children:[(0,n.jsx)("div",{className:"flex min-h-0 flex-1 items-center justify-center p-4 md:p-8",children:(0,n.jsxs)("div",{className:"relative h-full w-full max-w-[min(1100px,100%)]",children:[l?(0,n.jsx)("video",{"data-asset-lightbox-target":"true",src:t.storage_url,controls:!0,playsInline:!0,className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100")}):(0,n.jsx)("img",{"data-asset-lightbox-target":"true",ref:_,src:t.storage_url,alt:t.original_name||"asset",className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100"),draggable:!1,onLoad:()=>R()}),!d&&C&&N?(0,n.jsxs)("div",{className:"pointer-events-none absolute inset-0",children:[C.svg&&C.svg.trim().startsWith("<svg")?(0,n.jsx)("img",{alt:"",draggable:!1,src:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(C.svg)}`,style:{position:"absolute",left:N.offsetX,top:N.offsetY,width:N.drawW,height:N.drawH,opacity:.22,mixBlendMode:"screen",filter:"drop-shadow(0px 0px 10px rgba(124, 58, 237, 0.65))"}}):null,o(C.bboxJson).map((e,t)=>{let r=e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5,i=r?e.x*N.drawW:e.x*N.scale,a=r?e.y*N.drawH:e.y*N.scale,l=r?e.w*N.drawW:e.w*N.scale,o=r?e.h*N.drawH:e.h*N.scale;return(0,n.jsx)("div",{style:{position:"absolute",left:N.offsetX+i,top:N.offsetY+a,width:l,height:o},className:"rounded-sm border-2 border-violet-400/90 bg-violet-500/10 shadow-[0_0_18px_rgba(124,58,237,0.55)]"},`${C.tag}-${t}`)})]}):null]})}),(0,n.jsxs)("aside",{className:"w-full shrink-0 border-t border-white/10 bg-zinc-950/60 backdrop-blur md:w-[420px] md:border-l md:border-t-0",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between gap-3 border-b border-white/10 p-4",children:[(0,n.jsxs)("div",{className:"min-w-0",children:[(0,n.jsx)("div",{className:"truncate text-sm font-medium text-zinc-100",children:t.original_name}),(0,n.jsxs)("div",{className:"truncate text-xs text-zinc-400",children:[t.width&&t.height?`${t.width}\xd7${t.height}`:"",t.mime_type?t.width&&t.height?` \xb7 ${t.mime_type}`:t.mime_type:"",Number.isFinite(t.byte_size)?` \xb7 ${function(e){if(!Number.isFinite(e)||e<=0)return"0 B";let t=["B","KB","MB","GB","TB"],r=Math.min(t.length-1,Math.floor(Math.log(e)/Math.log(1024))),n=e/Math.pow(1024,r);return`${n.toFixed(n>=10||0===r?0:1)} ${t[r]}`}(t.byte_size)}`:""]})]}),(0,n.jsx)("button",{onClick:()=>k(),className:"inline-flex h-10 w-10 shrink-0 items-center justify-center rounded-full border border-white/10 bg-black/30 text-zinc-200 hover:bg-black/50 focus:outline-none focus:ring-2 focus:ring-violet-400/50","aria-label":"Close",children:(0,n.jsx)("span",{"aria-hidden":"true",className:"text-lg leading-none",children:"\xd7"})})]}),(0,n.jsx)("div",{className:"max-h-[45vh] overflow-auto p-4 md:max-h-none md:h-[calc(100%-57px)]",children:(0,n.jsxs)("div",{className:"space-y-5",children:[(0,n.jsx)("section",{children:(0,n.jsx)("div",{className:"mt-2 space-y-2 text-sm text-zinc-100",children:t.ai_caption?(0,n.jsx)("div",{className:"rounded-lg border border-white/10 bg-black/20 p-3 text-sm text-zinc-100",children:t.ai_caption}):null})}),p?.length?(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"Segments"}),(0,n.jsxs)("div",{className:"mt-2",children:[(0,n.jsxs)("div",{className:"mb-2 flex items-center justify-between gap-2",children:[(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"Click a tag to highlight it on the image."}),w?(0,n.jsx)("button",{onClick:()=>g(null),className:"rounded-md border border-white/10 bg-black/30 px-2 py-1 text-[11px] text-zinc-200 hover:bg-black/50",children:"Clear"}):null]}),(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:p.slice(0,80).map(e=>{let t=e.tag===w;return(0,n.jsx)("button",{type:"button",onClick:()=>g(t=>t===e.tag?null:e.tag),className:"rounded-full border px-2 py-1 text-xs "+(t?"border-violet-400/60 bg-violet-500/15 text-zinc-100":"border-white/10 bg-black/20 text-zinc-200 hover:bg-black/30"),title:e.updatedAt,children:e.tag},e.tag)})}),!w||C?.svg||o(C?.bboxJson??null).length?null:(0,n.jsxs)("div",{className:"mt-2 text-xs text-zinc-500",children:["No overlay data cached for"," ",(0,n.jsx)("span",{className:"text-zinc-300",children:w}),"."]})]})]}):null,(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"File"}),(0,n.jsxs)("div",{className:"mt-2 space-y-2 text-xs text-zinc-300",children:[(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"Created:"})," ",t.created_at]}),t.ai_updated_at?(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"AI Updated:"})," ",t.ai_updated_at]}):null]})]})]})})]})]})]})}let c="projectDrafts",d=new Map,u=new Set,h=null;function f(){return h||(h=new Promise((e,t)=>{let r=indexedDB.open("moondream",1);r.onupgradeneeded=()=>{let e=r.result;e.objectStoreNames.contains(c)||e.createObjectStore(c,{keyPath:"projectId"})},r.onsuccess=()=>e(r.result),r.onerror=()=>{let e=r.error??Error("indexedDB.open failed");h=null,t(e)}}))}function m(e){return new Promise((t,r)=>{e.oncomplete=()=>t(),e.onerror=()=>r(e.error??Error("IDB transaction failed")),e.onabort=()=>r(e.error??Error("IDB transaction aborted"))})}async function p(e){var t,r;let n,i,a=d.get(e)??null;if(u.has(e))return a;let l=(await f()).transaction(c,"readonly"),o=l.objectStore(c).get(e),s=await new Promise((e,t)=>{o.onsuccess=()=>e(o.result??null),o.onerror=()=>t(o.error??Error("IDB get failed"))});if(await m(l),u.add(e),!s)return a;if(!a)return d.set(e,s),s;let h=(t=s,n=(r=a).canvas??t.canvas,i=r.view??t.view,{...t,...r,projectId:r.projectId,updatedAt:Math.max(t.updatedAt,r.updatedAt),canvas:n,view:i,dirtyCanvas:null===r.canvas?t.dirtyCanvas:r.dirtyCanvas,dirtyView:null===r.view?t.dirtyView:r.dirtyView});return d.set(e,h),h}async function x(e){d.set(e.projectId,e);let t=(await f()).transaction(c,"readwrite");t.objectStore(c).put(e),await m(t)}let w=new Map,g=globalThis.requestIdleCallback??((e,t)=>globalThis.setTimeout(()=>e({didTimeout:!0,timeRemaining:()=>0}),Math.max(0,t?.timeout??200)));async function y(e){let t=w.get(e);if(t&&!t.inFlight){t.inFlight=!0;try{let r=t.next;if(await x(r),t.inFlight=!1,t.next===r){t.resolve(r),w.delete(e);return}t.scheduled||(t.scheduled=!0,g(()=>{let t=w.get(e);t&&(t.scheduled=!1,y(e))},{timeout:t.timeoutMs}))}catch(r){t.inFlight=!1,t.reject(r),w.delete(e)}}}async function v(e,t){return await function(e,t,r){let n={...d.get(e)??{projectId:e,updatedAt:0,canvas:null,view:null,dirtyCanvas:!1,dirtyView:!1},...t,projectId:e,updatedAt:t.updatedAt??Date.now()};d.set(e,n);let i=w.get(e);if(i)i.next=n,i.timeoutMs=r?.timeoutMs??i.timeoutMs;else{let t,a,l=new Promise((e,r)=>{t=e,a=r});i={next:n,timeoutMs:r?.timeoutMs??300,scheduled:!1,inFlight:!1,promise:l,resolve:t,reject:a},w.set(e,i)}return i.scheduled||i.inFlight||(i.scheduled=!0,g(()=>{(i=w.get(e))&&(i.scheduled=!1),y(e)},{timeout:i.timeoutMs})),i.promise}(e,t,{timeoutMs:300})}let b="#0a0a0a",j={bgHex:592139,bgAlpha:.88,strokeHex:0xffffff,strokeAlpha:.1,shadeAlpha:.28};function M(e,t,r){return Math.max(t,Math.min(r,e))}function _(e){for(let t of[e?.source?.resource,e?.source?.resource?.source,e?.source?.resource?.domElement,e?.baseTexture?.resource,e?.baseTexture?.resource?.source,e?.baseTexture?.resource?.domElement,e?.baseTexture?.source?.resource,e?.baseTexture?.source?.resource?.source])if(t){if("undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement)return t;if("undefined"!=typeof HTMLVideoElement&&t?.source instanceof HTMLVideoElement)return t.source;if("undefined"!=typeof HTMLVideoElement&&t?.domElement instanceof HTMLVideoElement)return t.domElement;if("undefined"!=typeof HTMLVideoElement&&t?.element instanceof HTMLVideoElement)return t.element}return null}function N(e,t){e.clear(),e.roundRect(0,0,220,160,10),e.fill({color:t.bgHex,alpha:t.bgAlpha}),e.stroke({color:t.strokeHex,width:1,alpha:t.strokeAlpha})}function z(e,t,r,n){let i=e.texture?.orig?.width??0,a=e.texture?.orig?.height??0;if(i<=0||a<=0||t<=0||r<=0)return null;let l=Math.abs(i*(e.scale?.x??1)),o=Math.abs(a*(e.scale?.y??1));if(l<=0||o<=0)return null;let s=e.rotation??0,c=Math.abs(Math.cos(s)),d=Math.abs(Math.sin(s)),u=c*l+d*o,h=d*l+c*o;if(u<=0||h<=0)return null;let f=M(n,.1,.98);return M(Math.min(t*f/u,r*f/h),.01,1)}function C(e){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)return;let n=Math.min(22,t/2,r/2),i=e.__roundMask;i||((i=new l.A1g).eventMode="none",i.visible=!0,e.__roundMask=i,e.addChild(i),e.mask=i),i.clear(),i.roundRect(-t/2,-r/2,t,r,n),i.fill(0xffffff)}function k(e,t,r,n,i){e.clear();let a=M(i,0,1),l=.1+.06*a,o=6+4*a,s=18+10*a;for(let i=0;i<8;i++){let a=i/7,c=s*(.2+1.05*a),d=(1-a)*(1-a)*l*.45,u=Math.min(n+c,(t+2*c)/2,(r+2*c)/2);e.roundRect(-t/2-c+o,-r/2-c+o,t+2*c,r+2*c,u),e.fill({color:0,alpha:d})}}function R(e){let t=e.projectId,r=e.initialObjects,a=e.initialView??null,o=e.onObjectsChange,c=(0,i.useRef)(null),d=(0,i.useRef)(null),u=(0,i.useRef)(null),h=(0,i.useRef)(null),f=(0,i.useRef)(null),m=(0,i.useRef)(null),x=(0,i.useRef)(null),w=(0,i.useRef)(new Set),g=(0,i.useRef)(new Map),y=(0,i.useRef)(new Map),R=(0,i.useRef)(new Map),T=(0,i.useRef)(new Map),S=(0,i.useRef)(new Map),E=(0,i.useRef)(new Set),I=(0,i.useRef)(new Map),A=(0,i.useRef)(null),F=(0,i.useRef)(!1),L=(0,i.useRef)(null),D=(0,i.useRef)(new Map),$=(0,i.useRef)([]),B=(0,i.useRef)(new Map),P=(0,i.useRef)(new Map),O=(0,i.useRef)(new Set),U=(0,i.useRef)(null),V=(0,i.useRef)(new l.bRX(.5,.5)),H=(0,i.useRef)(0),X=(0,i.useRef)(null),W=(0,i.useRef)(null),q=(0,i.useRef)(null),J=(0,i.useRef)(null),K=(0,i.useRef)({}),Y=(0,i.useRef)(null),G=(0,i.useRef)(!1),Q=(0,i.useRef)(null),Z=(0,i.useRef)(null),ee=(0,i.useRef)(null),et=(0,i.useRef)(null),er=()=>{et.current=null},en=(e,t)=>{let r=u.current;if(!r)return!1;let n={x:r.position.x,y:r.position.y,zoom:r.scale.x||1},i=M(t?.durationMs??280,80,1200);return .01>Math.abs(n.x-e.x)&&.01>Math.abs(n.y-e.y)&&1e-6>Math.abs(n.zoom-e.zoom)?(r.position.set(e.x,e.y),r.scale.set(e.zoom),t?.onComplete?.()):et.current={startMs:performance.now(),durationMs:i,from:n,to:e,onComplete:t?.onComplete},!0},ei=(e,t)=>Math.hypot(e.x-t.x,e.y-t.y,(e.zoom-t.zoom)*650),[ea,el]=(0,i.useState)(r),[eo,es]=(0,i.useState)(e.initialAssets),[ec,ed]=(0,i.useState)([]),[eu,eh]=(0,i.useState)(null),[ef,em]=(0,i.useState)(null),ep=(0,i.useRef)(null),[ex,ew]=(0,i.useState)(!0),[eg,ey]=(0,i.useState)(!1),[ev,eb]=(0,i.useState)(()=>({online:!0,dirtyCanvas:!1,dirtyView:!1,syncing:!1})),ej=(0,i.useRef)({canvas:!1,view:!1}),eM=(0,i.useRef)(null),e_=(0,i.useRef)(null),eN=(0,i.useRef)(null),[ez,eC]=(0,i.useState)(null),ek=(e,t,r)=>{let n=d.current,i=h.current,a=U.current;if(!n||!i||!a)return;let l=i.filterArea??n.screen,o=Math.max(1,Number(l?.width??n.renderer.width)),s=Math.max(1,Number(l?.height??n.renderer.height)),c=Number(l?.x??0),u=Number(l?.y??0),f=M((e-c)/o,0,1),m=M((t-u)/s,0,1);V.current.set(f,m),a.active=!0,a.timeSec=0,a.uniforms.uniforms.uTime=0,a.uniforms.uniforms.uCenter.set(f,m),a.uniforms.uniforms.uAspect=o/s,a.uniforms.uniforms.uShapeAspect=M(Number(r?.shapeAspect??1)||1,.05,20),a.uniforms.uniforms.uShapeRotation=Number(r?.shapeRotation??0)||0,i.filters&&0!==i.filters.length?i.filters.includes(a.filter)||(i.filters=[a.filter,...i.filters]):i.filters=[a.filter]},eR=(e,t)=>{let r=X.current;if(!r||r.fired||r.objectId!==e)return;let n=Number(t?.orig?.width??0),i=Number(t?.orig?.height??0);if(!(n>0&&i>0))return;r.fired=!0;let a=g.current.get(e),l=n*(Math.abs(a?.scale?.x??1)||1)/Math.max(1e-6,i*(Math.abs(a?.scale?.y??1)||1)),o=Number(a?.rotation??0)||0;if(a){let t,r=u.current,n=f.current;r&&n&&(n.position.set(r.position.x,r.position.y),n.scale.set(r.scale.x,r.scale.y),n.rotation=r.rotation??0);let i=x.current;if(i){let t=y.current.get(e);t&&i.addChild(t),i.addChild(a),w.current.add(e)}let{rx:s,ry:c}={rx:(t=a.getBounds()).x+t.width/2,ry:t.y+t.height/2};ek(s,c,{shapeAspect:l,shapeRotation:o}),X.current=null}else ek(r.rx,r.ry,{shapeAspect:l,shapeRotation:o}),X.current=null},eT=(0,i.useRef)(r);(0,i.useEffect)(()=>{eT.current=ea},[ea]);let eS=(0,i.useRef)(j),eE=(0,i.useRef)(j.shadeAlpha);(0,i.useEffect)(()=>{$.current=ec},[ec]),(0,i.useEffect)(()=>es(e.initialAssets),[e.initialAssets]),(0,i.useEffect)(()=>{el(r),ep.current=null,ej.current={canvas:!1,view:!1},ew(!0),eb(e=>({...e,dirtyCanvas:!1,dirtyView:!1,syncing:!1}))},[t]),(0,i.useEffect)(()=>{if(!ex)return void ey(!1);let e=window.setTimeout(()=>ey(!0),150);return()=>window.clearTimeout(e)},[ex,t]);let eI=e=>{ej.current.canvas!==e&&(ej.current.canvas=e,eb(t=>({...t,dirtyCanvas:e})))},eA=e=>{ej.current.view!==e&&(ej.current.view=e,eb(t=>({...t,dirtyView:e})))};(0,i.useEffect)(()=>{let e=()=>eb(e=>({...e,online:navigator.onLine}));return e(),window.addEventListener("online",e),window.addEventListener("offline",e),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",e)}},[]),(0,i.useEffect)(()=>{let e=!1;return(async()=>{let n=!1;try{let i=await p(t);if(e)return;if(!i){eI(!1),eA(!1),v(t,{canvas:r,view:a,dirtyCanvas:!1,dirtyView:!1}).catch(()=>{});return}eI(!!i.dirtyCanvas),eA(!!i.dirtyView),n=(i.dirtyCanvas||i.dirtyView)&&"undefined"!=typeof navigator&&navigator.onLine;let l=Math.max(0,...r.map(e=>Date.parse(e.updated_at||e.created_at||"")).filter(e=>Number.isFinite(e)));if(i.canvas&&(i.dirtyCanvas||i.updatedAt>l)&&(el(i.canvas),o?.(i.canvas)),i.view){ep.current=i.view;let e=u.current;if(e){e.position.set(i.view.world_x,i.view.world_y);let t=Number.isFinite(i.view.zoom)?i.view.zoom:1;e.scale.set(M(t,.01,1))}}}catch{}finally{if(!e&&n)try{await Promise.race([eF(),new Promise(e=>window.setTimeout(e,250))])}catch{}e||ew(!1)}})(),()=>{e=!0}},[t,r,o]);let eF=async()=>{if(eM.current)return eM.current;if(!("undefined"!=typeof navigator?navigator.onLine:ev.online))return;let e=(async()=>{eb(e=>({...e,syncing:!0}));try{let e=await p(t);if(!e)return;let r=!!e.dirtyCanvas,n=!!e.dirtyView;if(r&&e.canvas)try{let n=await fetch(`/api/projects/${t}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:e.canvas})});if(!n.ok)throw Error(`canvas_sync_failed:${n.status}`);r=!1,await v(t,{canvas:e.canvas,dirtyCanvas:!1}).catch(()=>{})}catch{}if(n&&e.view)try{let r=await fetch(`/api/projects/${t}/view`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.view)});if(!r.ok)throw Error(`view_sync_failed:${r.status}`);n=!1,await v(t,{view:e.view,dirtyView:!1}).catch(()=>{})}catch{}eI(r),eA(n)}finally{eb(e=>({...e,syncing:!1})),eM.current=null}})();return eM.current=e,e};(0,i.useEffect)(()=>{if(!ev.online||!ev.dirtyCanvas&&!ev.dirtyView)return;eF();let e=window.setInterval(()=>void eF(),3e3);return()=>window.clearInterval(e)},[t,ev.online,ev.dirtyCanvas,ev.dirtyView]);let eL=(0,i.useRef)(null),eD=(0,i.useRef)(null),e$=(0,i.useRef)(null),eB=(0,i.useRef)(null),eP=(0,i.useRef)(null),eO=e=>{!o||(eP.current=e,eB.current||(eB.current=window.setTimeout(()=>{eB.current=null;let e=eP.current;eP.current=null,e&&o?.(e)},0)))},eU=r=>{e_.current&&window.clearTimeout(e_.current),e_.current=window.setTimeout(()=>{v(t,{canvas:r,dirtyCanvas:!0}).catch(()=>{})},40),eI(!0),eL.current&&window.clearTimeout(eL.current),eL.current=window.setTimeout(async()=>{try{let n=await fetch(`/api/projects/${e.projectId}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:r})});if(!n.ok)throw Error(`canvas_save_failed:${n.status}`);v(t,{canvas:r,dirtyCanvas:!1}).catch(()=>{}),eI(!1)}catch{eI(!0)}},250),eX()},eV=async r=>{e_.current&&(window.clearTimeout(e_.current),e_.current=null),v(t,{canvas:r,dirtyCanvas:!0}).catch(()=>{}),eI(!0),eL.current&&(window.clearTimeout(eL.current),eL.current=null);try{let n=await fetch(`/api/projects/${e.projectId}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:r})});if(!n.ok)throw Error(`canvas_save_failed:${n.status}`);v(t,{canvas:r,dirtyCanvas:!1}).catch(()=>{}),eI(!1)}catch{eI(!0)}},eH=r=>{eN.current&&window.clearTimeout(eN.current),eN.current=window.setTimeout(()=>{v(t,{view:r,dirtyView:!0}).catch(()=>{})},60),eA(!0),eD.current&&window.clearTimeout(eD.current),eD.current=window.setTimeout(async()=>{try{let n=await fetch(`/api/projects/${e.projectId}/view`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!n.ok)throw Error(`view_save_failed:${n.status}`);v(t,{view:r,dirtyView:!1}).catch(()=>{}),eA(!1)}catch{eA(!0)}},250)},eX=()=>{e$.current&&window.clearTimeout(e$.current),e$.current=window.setTimeout(async()=>{let t=d.current,r=W.current;if(!t||!r)return;let n=r.content,i=r.spriteById,a=1/0,o=1/0,s=-1/0,c=-1/0;for(let e of g.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;a=Math.min(a,e.position.x-n),s=Math.max(s,e.position.x+n),o=Math.min(o,e.position.y-i),c=Math.max(c,e.position.y+i)}if(!Number.isFinite(a)||!Number.isFinite(o)||!Number.isFinite(s)||!Number.isFinite(c))return;let u=Math.max(Math.max(1,s-a),Math.max(1,c-o)),h=Math.max(24,.08*u),f=(a+s)/2,m=(o+c)/2,p=new Set;for(let e of g.current.values()){let t=e.__objectId;if(!t)continue;let r=e.texture,a=r?.orig?.width??0,o=r?.orig?.height??0;if(a<=0||o<=0)continue;p.add(t);let s=i.get(t);s?s.texture!==r&&(s.texture=r):((s=new l.kxk(r)).anchor.set(.5),s.eventMode="none",n.addChild(s),i.set(t,s)),s.position.copyFrom(e.position),s.scale.copyFrom(e.scale),s.rotation=e.rotation,s.alpha=1}for(let[e,t]of i.entries())p.has(e)||(t.destroy({children:!0,texture:!1}),i.delete(e));let x=256/(u+2*h);n.scale.set(x),n.position.set(128-f*x,128-m*x),t.renderer.render({container:r.root,target:r.rt,clear:!0,clearColor:657930});let w=t.renderer.extract.canvas({target:r.rt}),y=null;if(w?.convertToBlob?(y=await w.convertToBlob({type:"image/webp",quality:.75}).catch(()=>null))||(y=await w.convertToBlob({type:"image/png"}).catch(()=>null)):w?.toBlob&&(y=await new Promise(e=>w.toBlob(e,"image/webp",.75))??await new Promise(e=>w.toBlob(e,"image/png"))),!y)return;let v=await y.arrayBuffer();await fetch(`/api/projects/${e.projectId}/preview`,{method:"PUT",headers:{"Content-Type":y.type||"image/webp"},body:v}).catch(()=>{})},1200)},eW=(0,i.useMemo)(()=>{let e=new Map;for(let t of eo)e.set(t.id,t);return e},[eo]);(0,i.useMemo)(()=>new Set(ec),[ec]),1===ec.length&&ec[0];let eq=e=>{let t=A.current;if(t!==e){if(A.current=e,t){let e=I.current.get(t);e&&(e.visible=!1)}if(e){let t=I.current.get(e);t&&(t.visible=!0)}}},eJ=()=>{for(let[e,t]of B.current.entries()){try{t.destroy({children:!0})}catch{}B.current.delete(e)}},eK=(e,t)=>{let r=M(t,0,1);for(let t of e){let e=P.current.get(t)??{current:0,target:0};e.target=r,P.current.set(t,e),O.current.add(t)}},eY=(t,r)=>{let n=g.current.get(t);if(!n)return;let i=e.highlightOverlay;if(!i||i.assetId!==r)return;let a=n.texture?.orig?.width??0,o=n.texture?.orig?.height??0;if((a<=0||o<=0)&&eW.get(r)){let e=eW.get(r);a=e.width??0,o=e.height??0}if(a<=0||o<=0)return;let s=new l.mcf;if(s.eventMode="none",i.svg&&i.svg.trim().startsWith("<svg")){let e=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(i.svg)}`,t=l.gPd.from(e),r=new l.kxk(t);r.anchor.set(.5),r.width=a,r.height=o,r.alpha=.22,r.tint=6333946,r.blendMode="screen",s.addChild(r)}let c=(e=>{if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}})(i.bboxJson);if(c.length){let e=c.every(e=>e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5),t=new l.A1g;for(let r of(t.eventMode="none",c)){let n=e?r.x*a:r.x,i=e?r.y*o:r.y,l=e?r.w*a:r.w,s=e?r.h*o:r.h,c=-a/2+n,d=-o/2+i;t.rect(c,d,l,s),t.fill({color:6333946,alpha:.1}),t.stroke({color:6333946,alpha:.85,width:3})}s.addChild(t)}n.addChild(s),B.current.set(t,s)};(0,i.useEffect)(()=>{eJ();let t=e.highlightOverlay;if(t){for(let e of ea)"image"===e.type&&e.asset_id&&e.asset_id===t.assetId&&eY(e.id,e.asset_id);return()=>{eJ()}}},[e.highlightOverlay,ea,eW]),(0,i.useEffect)(()=>{let e=()=>{let e=document.activeElement;return!!(e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.isContentEditable))},t=()=>{let e=d.current,t=u.current;if(!e||!t)return;let r=new l.bRX(e.renderer.width/2,e.renderer.height/2),n=t.toLocal(r),i=M(.1,.01,1),a=r.x-n.x*i,o=r.y-n.y*i;er(),en({x:a,y:o,zoom:i},{durationMs:260,onComplete:()=>{let e=u.current;e&&(eH({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eX())}})},r=e=>{let t=d.current,r=u.current;if(!t||!r||e.requireHover&&!F.current)return;let n=1===$.current.length?$.current[0]:null;if(!n)return;let i=g.current.get(n);if(!i)return;let a=r.scale.x||1,o=M(Math.max(1.6*a,z(i,t.renderer.width,t.renderer.height,.88)??null??0,a),.01,1),s=i.position,c=t.renderer.width/2-s.x*o,h=t.renderer.height/2-s.y*o,f={x:r.position.x,y:r.position.y,zoom:r.scale.x||1},m={x:c,y:h,zoom:o},p=new l.bRX(t.renderer.width/2,t.renderer.height/2),x=r.toLocal(p),w=M(.1,.01,1),y={x:p.x-x.x*w,y:p.y-x.y*w,zoom:w},v=ei(f,m)<=ei(f,y)?y:m;er(),en(v,{durationMs:320,onComplete:()=>{let e=u.current;e&&(eH({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eX())}})},n=async()=>{let e=$.current;if(!e||0===e.length)return;let t=eT.current??[],r=new Set(e),n=t.filter(e=>r.has(e.id)&&"image"===e.type);if(n.length>0){let e=new Set;for(let t of n)t.asset_id&&e.add(t.asset_id);let i=new Set;for(let e of t)!r.has(e.id)&&"image"===e.type&&e.asset_id&&i.add(e.asset_id);let a=[...e].filter(e=>!i.has(e)),l=a.length>0?`Delete ${n.length} image(s) from the board?

This will also permanently delete ${a.length} asset(s) from the project because nothing else is using them.`:`Delete ${n.length} image(s) from the board?`;if(!window.confirm(l))return}ed([]);let i=null,a=[];el(t=>{let r=new Set(e),n=t.filter(e=>!r.has(e.id)),l=new Set;for(let e of t)r.has(e.id)&&"image"===e.type&&e.asset_id&&l.add(e.asset_id);let o=new Set;for(let e of n)"image"===e.type&&e.asset_id&&o.add(e.asset_id);return a=[...l].filter(e=>!o.has(e)),i=n,eO(n),n}),window.setTimeout(async()=>{if(i&&(await eV(i),eX(),a.length)){for(let e of a)await fetch(`/api/assets/${e}`,{method:"DELETE"}).catch(()=>{});es(e=>e.filter(e=>!a.includes(e.id)))}},0)},i=i=>{let a=e();if(!a&&("r"===i.key||"R"===i.key)){let e=d.current;if(!e)return;i.preventDefault();let t=h.current,r=t?.filterArea??e.screen;ek(Number(r?.x??0)+Number(r?.width??e.renderer.width)/2,Number(r?.y??0)+Number(r?.height??e.renderer.height)/2,{shapeAspect:3.2,shapeRotation:0});return}if(!a&&("m"===i.key||"M"===i.key)){i.preventDefault(),G.current=!G.current;let e=Q.current;e&&(G.current?(e.showUntilMs=1/0,e.targetAlpha=1,e.container.visible=!0):(e.showUntilMs=0,e.targetAlpha=0));return}if(!a&&("0"===i.key||"Digit0"===i.code||"Numpad0"===i.code)){i.preventDefault(),t();return}if(!a&&F.current&&("Space"===i.code||" "===i.key||"Spacebar"===i.key)){i.preventDefault(),r({requireHover:!0});return}if(!a){if("ArrowLeft"===i.key||"ArrowRight"===i.key||"ArrowUp"===i.key||"ArrowDown"===i.key){i.preventDefault(),(e=>{let t=d.current,r=u.current;if(!t||!r)return;let n=1===$.current.length?$.current[0]:null;if(!n)return;let i=g.current.get(n);if(!i)return;let a=i.position.x,l=i.position.y,o=eT.current??[],s=null,c=1/0;for(let t of o){if(t.id===n)continue;let r=g.current.get(t.id);if(!r)continue;let i=r.position.x-a,o=r.position.y-l;if("left"===e&&!(i<-1e-6)||"right"===e&&!(i>1e-6)||"up"===e&&!(o<-1e-6)||"down"===e&&!(o>1e-6))continue;let d=("left"===e||"right"===e?Math.abs(i):Math.abs(o))+.45*("left"===e||"right"===e?Math.abs(o):Math.abs(i));d<c&&(c=d,s=t.id)}if(!s)return;let h=g.current.get(s);if(!h)return;ed([s]);let f=r.scale.x||1,m=z(h,t.renderer.width,t.renderer.height,.96)??null,p=m?Math.min(f,m):f,x=h.position,w=t.renderer.width/2-x.x*p,y=t.renderer.height/2-x.y*p;er(),en({x:w,y:y,zoom:p},{durationMs:220,onComplete:()=>{let e=u.current;e&&(eH({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eX())}})})("ArrowLeft"===i.key?"left":"ArrowRight"===i.key?"right":"ArrowUp"===i.key?"up":"down");return}("Backspace"===i.key||"Delete"===i.key)&&(i.preventDefault(),n())}};window.addEventListener("keydown",i);let a=()=>t(),o=()=>r({requireHover:!1}),s=()=>{e()||n()};return window.addEventListener("moondream:canvas:reset-zoom",a),window.addEventListener("moondream:canvas:focus-toggle",o),window.addEventListener("moondream:canvas:delete-selection",s),()=>{window.removeEventListener("keydown",i),window.removeEventListener("moondream:canvas:reset-zoom",a),window.removeEventListener("moondream:canvas:focus-toggle",o),window.removeEventListener("moondream:canvas:delete-selection",s)}},[]),(0,i.useEffect)(()=>{let e=c.current;if(!e||d.current)return;let t=new l.lgM;return d.current=t,(async()=>{e.style.backgroundColor=b,await t.init({resizeTo:e,background:b,antialias:!0,autoDensity:!0,resolution:window.devicePixelRatio||1}),e.appendChild(t.canvas);let r=new l.mcf;t.stage.addChild(r);let n=new l.mcf;h.current=n,n.filterArea=t.screen,r.addChild(n);let i=new l.mcf;r.addChild(i);let o=new l.mcf;o.sortableChildren=!0,u.current=o,n.addChild(o);let s=new l.mcf;s.sortableChildren=!0,m.current=s,o.addChild(s);let c=new l.mcf;c.sortableChildren=!0,f.current=c,i.addChild(c);let p=new l.mcf;p.sortableChildren=!0,x.current=p,c.addChild(p);let v=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;

    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}`,j=`
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;

uniform float uTime;
uniform vec2 uCenter;     // 0..1 within filterArea (screen-space)
uniform float uAmplitude; // UV offset scale
uniform float uFrequency; // wave frequency
uniform float uSpeed;     // ring expansion speed (in UV/sec)
uniform float uWidth;     // ring thickness (in UV)
uniform float uDecay;     // spatial decay
uniform float uAspect;    // width/height
uniform float uShapeAspect;   // image aspect (w/h) for elliptical ripples
uniform float uShapeRotation; // radians (align ellipse to image rotation)
uniform float uDuration;  // seconds

float heightAt(float dist, float radius, float w, float timeFade, float distFade)
{
    float x = dist - radius;

    // Front band: a smooth "impact ring".
    float frontBand = exp(-(x * x) / (w * w));

    // Behind band: trailing ripples that decay behind the front.
    float behindBand = step(x, 0.0) * exp(x / (w * 2.0));

    // Ahead of the front, fade out quickly.
    float aheadFade = smoothstep(w * 3.0, 0.0, x);

    float band = (0.25 * frontBand + 0.75 * behindBand) * aheadFade;

    // Two harmonics reads as "watery" vs a single sine.
    float phase = x * uFrequency;
    float wave = sin(phase) + 0.35 * sin(phase * 2.15 + 1.3);

    // Global gain (keeps the effect subtle even with higher frequency content).
    return wave * band * timeFade * distFade * 0.35;
}

void main()
{
    vec2 uv = vTextureCoord;
    vec2 pUv = uv - uCenter;
    // Convert to screen-corrected space (so circles are circles on screen).
    vec2 pScreen = pUv;
    pScreen.x *= uAspect;

    // Rotate into the image-aligned frame.
    float cs = cos(uShapeRotation);
    float sn = sin(uShapeRotation);
    mat2 rot = mat2(cs, -sn, sn, cs);
    vec2 pr = rot * pScreen;

    // Elliptical metric based on the image aspect ratio (w/h).
    float sAspect = max(uShapeAspect, 0.0001);
    vec2 pm = vec2(pr.x / sAspect, pr.y);
    float dist = length(pm);

    float timeFade = clamp(1.0 - (uTime / max(uDuration, 0.001)), 0.0, 1.0);
    float distFade = exp(-uDecay * dist);

    float radius = uTime * uSpeed;
    float w = max(uWidth, 0.0005);

    // Radial direction in UV space for an ellipse:
    // - compute direction in metric space (pm), then map back to UV.
    vec2 dm = dist > 0.00001 ? (pm / dist) : vec2(0.0, 0.0);
    vec2 dr = vec2(dm.x * sAspect, dm.y); // undo metric scaling (back to rotated screen space)
    mat2 rotInv = mat2(cs, sn, -sn, cs);
    vec2 dScreen = rotInv * dr;
    vec2 dir = dScreen;
    dir.x /= max(uAspect, 0.00001);
    float dirLen = length(dir);
    dir = dirLen > 0.00001 ? (dir / dirLen) : vec2(0.0, 0.0);

    // Finite-difference slope -> "refraction normal" feel.
    float eps = 0.004;
    float h0 = heightAt(dist, radius, w, timeFade, distFade);
    float h1 = heightAt(dist + eps, radius, w, timeFade, distFade);
    float h2 = heightAt(max(0.0, dist - eps), radius, w, timeFade, distFade);
    float dh = (h1 - h2) / (2.0 * eps);
    float dhClamped = clamp(dh, -1.0, 1.0);
    float hClamped = clamp(h0, -1.0, 1.0);

    // Refraction: use slope + a tiny rotational component.
    vec2 perp = vec2(-dir.y, dir.x);
    vec2 disp = (dir * dhClamped + perp * (hClamped * 0.08)) * uAmplitude;

    vec2 uv2 = uv + disp;
    uv2 = clamp(uv2, vec2(0.0), vec2(1.0));

    finalColor = texture(uTexture, uv2);
}`,_=new l.k2S({uTime:{value:0,type:"f32"},uCenter:{value:new l.bRX(.5,.5),type:"vec2<f32>"},uAmplitude:{value:.0026,type:"f32"},uFrequency:{value:28,type:"f32"},uSpeed:{value:.36,type:"f32"},uWidth:{value:.18,type:"f32"},uDecay:{value:1.4,type:"f32"},uAspect:{value:1,type:"f32"},uShapeAspect:{value:1,type:"f32"},uShapeRotation:{value:0,type:"f32"},uDuration:{value:1.85,type:"f32"}});U.current={filter:new l.dJT({glProgram:l.M2g.from({vertex:v,fragment:j,name:"workspace-ripple-filter"}),resources:{rippleUniforms:_},padding:0}),uniforms:_,active:!1,timeSec:0};let C=new l.mcf,R=new l.mcf;C.addChild(R),W.current={rt:l.Y7R.create({width:256,height:256,resolution:1}),root:C,content:R,spriteById:new Map};let T=ep.current??a;if(T){o.position.set(T.world_x,T.world_y);let e=Number.isFinite(T.zoom)?T.zoom:1;o.scale.set(M(e,.01,1))}let B=new l.mcf;B.eventMode="none",B.visible=!1,B.alpha=0,t.stage.addChild(B);let V=new l.A1g;N(V,eS.current),B.addChild(V);let H=new l.A1g;H.roundRect(0,0,220,160,10),H.fill(0xffffff),H.visible=!0,B.addChild(H);let X=new l.mcf;X.mask=H,B.addChild(X);let ei=new l.mcf;X.addChild(ei);let ea=new l.A1g;X.addChild(ea);let eo=new l.A1g;X.addChild(eo);let es=new l.A1g;X.addChild(es);let ec=new l.A1g;X.addChild(ec),Q.current={container:B,bg:V,items:ei,spriteById:new Map,shade:ea,overlay:eo,viewport:es,interact:ec,map:null,showUntilMs:0,targetAlpha:0},N(V,eS.current);let eu=new l.mcf;eu.zIndex=1e9,q.current=eu,c.addChild(eu);let eh=new l.A1g;J.current=eh,eu.addChild(eh);let ef=new l.A1g;ef.eventMode="none",ef.zIndex=0x3b9ac9ff,Y.current=ef,c.addChild(ef);let ex=e=>{let t=new l.A1g;return t.eventMode="static",t.cursor="nwse-resize",t.__handle={corner:e},eu.addChild(t),t};K.current={tl:ex("tl"),tr:ex("tr"),br:ex("br"),bl:ex("bl")};let ew=new l.bRX(0,0),eg=(e,r)=>{let n=t.canvas.getBoundingClientRect(),i=(e-n.left)*t.renderer.width/n.width,a=(r-n.top)*t.renderer.height/n.height;return new l.bRX(i,a)},ey=(e,t)=>({tl:new l.bRX(-e/2,-t/2),tr:new l.bRX(e/2,-t/2),br:new l.bRX(e/2,t/2),bl:new l.bRX(-e/2,t/2)});t.canvas.addEventListener("pointerdown",e=>{F.current=!0,er(),t.canvas.setPointerCapture(e.pointerId),eq(null),ew=eg(e.clientX,e.clientY);{let e=Q.current;if(e&&e.container.visible&&e.container.alpha>.25&&e.map){let t=eb(ew.x,ew.y);if(t&&t.x>=0&&t.y>=0&&t.x<=220&&t.y<=160){ev(),e.showUntilMs=performance.now()+1e4,Z.current={kind:"minimap",start:t,cur:t},ee.current=null,eM(t,t);return}}}let r=t.renderer.events.rootBoundary.hitTest(ew.x,ew.y);ee.current={pointerId:e.pointerId,button:e.button??0,startRx:ew.x,startRy:ew.y,moved:!1,objectId:r&&!r.__handle&&r.__objectId?r.__objectId:null,isHandle:!!(r&&r.__handle),shift:e.shiftKey};let n=1===$.current.length?$.current[0]:null;if(r&&r.__handle&&n){let e=r.__handle.corner,t=g.current.get(n),i=t?.texture?.orig?.width??0,a=t?.texture?.orig?.height??0;if(t&&i>0&&a>0){let r=ey(i,a),o="tl"===e?"br":"tr"===e?"bl":"br"===e?"tl":"tr",s=r[e],c=r[o];Z.current={kind:"resize",objectId:n,corner:e,fixedWorld:new l.bRX(t.position.x+t.scale.x*c.x,t.position.y+t.scale.y*c.y),localFixed:c,localHandle:s,baseW:i,baseH:a};return}}if(r&&r.__objectId){let t,n=r.__objectId,i=e.shiftKey,a=$.current??[];if(i){let e=new Set(a);e.has(n)?e.delete(n):e.add(n),t=Array.from(e)}else t=[n];ed(t),el(e=>{let r=function(e,t){if(!t.length)return e;let r=new Set(t),n=[...e].sort((e,t)=>e.z_index!==t.z_index?e.z_index-t.z_index:e.id.localeCompare(t.id)),i=[...n.filter(e=>!r.has(e.id)),...n.filter(e=>r.has(e.id))],a=new Date().toISOString();return i.map((e,t)=>e.z_index===t?e:{...e,z_index:t,updated_at:a})}(e,t);return eO(r),eU(r),r});let l=$.current,o=l&&l.length>0&&(i||l.includes(n))&&l.includes(n)?l:[n];Z.current={kind:"move",objectIds:t.length?t:o,last:ew},eK(t.length?t:o,1);return}e.shiftKey||ed([]),Z.current={kind:"pan",last:ew}}),t.canvas.addEventListener("pointermove",e=>{F.current=!0;let r=eg(e.clientX,e.clientY),n=ee.current;n&&n.pointerId===e.pointerId&&!n.moved&&Math.hypot(r.x-n.startRx,r.y-n.startRy)>6&&(n.moved=!0);let i=Z.current;if(!i){let e=t.renderer.events.rootBoundary.hitTest(r.x,r.y);if(e&&e.__handle)return void eq(null);let n=(e&&e.__objectId?e.__objectId:null)??null;return void(n&&E.current.has(n)?eq(n):eq(null))}if("minimap"===i.kind){ev();let e=Q.current;if(!e||!e.map)return;e.showUntilMs=performance.now()+1e4;let t=eb(r.x,r.y);if(!t)return;let n={kind:"minimap",start:i.start,cur:t};Z.current=n,eM(n.start,n.cur);return}if("pan"===i.kind){ev();let e=r.x-i.last.x,t=r.y-i.last.y;o.position.x+=e,o.position.y+=t,Z.current={kind:"pan",last:r},eH({world_x:o.position.x,world_y:o.position.y,zoom:o.scale.x});return}if("move"===i.kind){let e=i.objectIds.map(e=>[e,g.current.get(e)]).filter(([,e])=>!!e);if(0===e.length)return;let t=r.x-i.last.x,n=r.y-i.last.y,a=1/(o.scale.x||1);for(let[r,i]of e){i.position.x+=t*a,i.position.y+=n*a;let e=y.current.get(r);e&&(e.position.x=i.position.x,e.position.y=i.position.y)}Z.current={kind:"move",objectIds:i.objectIds,last:r},el(t=>{let r=new Map(e),n=t.map(e=>{let t=r.get(e.id);return t?{...e,x:t.position.x,y:t.position.y,updated_at:new Date().toISOString()}:e});return eO(n),eU(n),n});return}if("resize"===i.kind){let e=g.current.get(i.objectId);if(!e)return;let t=o.toLocal(r),n=t.x-i.fixedWorld.x,a=t.y-i.fixedWorld.y,l=i.localHandle.x-i.localFixed.x,s=i.localHandle.y-i.localFixed.y,c=n/l,d=a/s,u=Math.max(Math.abs(c),Math.abs(d));c=u,d=u,c=Math.max(.05,c),d=Math.max(.05,d),e.scale.set(c,d),e.position.x=i.fixedWorld.x-c*i.localFixed.x,e.position.y=i.fixedWorld.y-d*i.localFixed.y,el(t=>{let r=t.map(t=>t.id===i.objectId?{...t,x:e.position.x,y:e.position.y,scale_x:e.scale.x,scale_y:e.scale.y,width:i.baseW*e.scale.x,height:i.baseH*e.scale.y,updated_at:new Date().toISOString()}:t);return eO(r),eU(r),r})}}),t.canvas.addEventListener("pointerup",e=>{let t=Z.current;if(t&&"move"===t.kind&&eK(t.objectIds,0),t&&"minimap"===t.kind){let e=Q.current,r=u.current,n=d.current;if(e&&e.interact.clear(),e&&e.map&&r&&n){let i=t.start,a=t.cur,o=Math.abs(i.x-a.x),s=Math.abs(i.y-a.y),c=e.map,d=M(Math.min(i.x,a.x),c.pad,c.pad+c.innerW),h=M(Math.min(i.y,a.y),c.pad,c.pad+c.innerH),f=M(Math.max(i.x,a.x),c.pad,c.pad+c.innerW),m=M(Math.max(i.y,a.y),c.pad,c.pad+c.innerH),p=ej(new l.bRX(d,h)),x=ej(new l.bRX(f,m));if(p&&x){let e=Math.min(p.x,x.x),t=Math.max(p.x,x.x),i=Math.min(p.y,x.y),a=Math.max(p.y,x.y),l=Math.max(.001,t-e),c=Math.max(.001,a-i),d=o<10&&s<10,h=d?M(r.scale.x||1,.01,1):M(Math.min(.94*n.renderer.width/l,.94*n.renderer.height/c),.01,1),f=n.renderer.width/2-(e+t)/2*h,m=n.renderer.height/2-(i+a)/2*h;er(),en({x:f,y:m,zoom:h},{durationMs:d?220:300,onComplete:()=>{let e=u.current;e&&(eH({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eX())}})}}}Z.current=null,eX();let r=ee.current;if((ee.current=null,r&&!r.moved&&0===r.button)&&!r.shift&&!r.objectId)return}),t.canvas.addEventListener("wheel",e=>{let t;F.current=!0,er(),e.preventDefault(),ev();let r=eg(e.clientX,e.clientY),n=o.toLocal(r),i=Math.pow(1.16,(e.deltaY>0?-1:1)*M(Math.abs(1===e.deltaMode?16*e.deltaY:2===e.deltaMode?800*e.deltaY:e.deltaY)/100,.35,6)),a=o.scale.x,l=.12+(t=M(i>1?(1-a)/.99:(a-.01)/.99,0,1))*t*(3-2*t)*.88,s=M(a+(a*i-a)*l,.01,1);o.scale.set(s);let c=o.toLocal(r);o.position.x+=(c.x-n.x)*o.scale.x,o.position.y+=(c.y-n.y)*o.scale.y,eH({world_x:o.position.x,world_y:o.position.y,zoom:o.scale.x}),eX()},{passive:!1}),t.canvas.addEventListener("contextmenu",e=>e.preventDefault()),t.canvas.addEventListener("pointerenter",()=>{F.current=!0}),t.canvas.addEventListener("pointerleave",()=>{F.current=!1,eq(null)}),t.canvas.addEventListener("dblclick",e=>{if(Z.current)return;let r=eg(e.clientX,e.clientY),n=t.renderer.events.rootBoundary.hitTest(r.x,r.y);if(!n||n.__handle)return;let i=n.__objectId;if(!i)return;let a=eT.current.find(e=>e.id===i);if(!a||"image"!==a.type||!a.asset_id)return;let l=u.current,o=l?.scale.x||1,s=g.current.get(i),c=s?z(s,t.renderer.width,t.renderer.height,.88)??null:null;if(o<(c?M(.75*c,.25,.75):.35))return;let d=t.canvas.getBoundingClientRect(),h=null;if(s&&d.width>0&&d.height>0&&t.renderer.width>0&&t.renderer.height>0)try{let e=s.getBounds(),r=d.left+e.x/t.renderer.width*d.width,n=d.top+e.y/t.renderer.height*d.height,i=e.width/t.renderer.width*d.width,a=e.height/t.renderer.height*d.height;Number.isFinite(r)&&Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(a)&&i>2&&a>2&&(h={left:r,top:n,width:i,height:a})}catch{h=null}eC(h),em(a.asset_id)});let ev=()=>{let e=Q.current;e&&(e.showUntilMs=performance.now()+2500,e.targetAlpha=1,e.container.visible=!0)},eb=(e,t)=>{let r=Q.current;return r?new l.bRX(e-r.container.position.x,t-r.container.position.y):null},ej=e=>{let t=Q.current;if(!t||!t.map)return null;let r=t.map,n=Math.max(1e-6,r.s),i=r.minX+(e.x-r.offsetX)/n,a=r.minY+(e.y-r.offsetY)/n;return new l.bRX(i,a)},eM=(e,t)=>{let r=Q.current;if(!r||!r.map)return;let n=r.map,i=M(Math.min(e.x,t.x),n.pad,n.pad+n.innerW),a=M(Math.min(e.y,t.y),n.pad,n.pad+n.innerH),l=M(Math.max(e.x,t.x),n.pad,n.pad+n.innerW),o=M(Math.max(e.y,t.y),n.pad,n.pad+n.innerH),s=Math.max(0,l-i),c=Math.max(0,o-a);r.interact.clear(),s<=0||c<=0||(r.interact.beginFill(6333946,.1),r.interact.drawRect(i,a,s,c),r.interact.endFill(),r.interact.lineStyle(2,6333946,.95),r.interact.drawRect(i+1,a+1,Math.max(0,s-2),Math.max(0,c-2)))};t.ticker.add(e=>{f.current&&(f.current.position.set(o.position.x,o.position.y),f.current.scale.set(o.scale.x,o.scale.y),f.current.rotation=o.rotation??0);let r=U.current;if(r&&r.active){r.timeSec+=(e.deltaMS??16.6667)/1e3,r.uniforms.uniforms.uTime=r.timeSec,r.uniforms.uniforms.uAspect=t.renderer.width/Math.max(1,t.renderer.height);let i=Number(r.uniforms.uniforms.uDuration)||1;if(r.timeSec>=i){r.active=!1,r.timeSec=0,n.filters&&n.filters.includes(r.filter)&&(n.filters=n.filters.filter(e=>e!==r.filter)),n.filters&&0===n.filters.length&&(n.filters=[]);let e=w.current,t=m.current;if(t&&e.size){for(let r of[...e]){let e=y.current.get(r),n=g.current.get(r);e&&t.addChild(e),n&&t.addChild(n)}e.clear()}}}let i=et.current;if(i){var a,s,c;let e,t=performance.now(),r=i.durationMs>0?(t-i.startMs)/i.durationMs:1,n=(e=M(r,0,1))*e*(3-2*e),l=(a=i.from.zoom,a+(i.to.zoom-a)*n);o.scale.set(l),o.position.x=(s=i.from.x,s+(i.to.x-s)*n),o.position.y=(c=i.from.y,c+(i.to.y-c)*n),r>=1&&(et.current=null,i.onComplete?.())}let d=O.current;if(d.size)for(let e of[...d]){let t=P.current.get(e);if(!t){d.delete(e);continue}let r=t.target-t.current;t.current+=.12*r,.001>Math.abs(r)&&(t.current=t.target,d.delete(e));let n=g.current.get(e),i=y.current.get(e);if(!n||!i)continue;let a=n.texture?.orig?.width??0,l=n.texture?.orig?.height??0;if(a<=0||l<=0)continue;let o=Math.min(22,a/2,l/2);k(i,a,l,o,t.current)}(()=>{let e=q.current,t=J.current;if(!e||!t)return;let r=K.current,n=$.current,i=1===n.length?n[0]:null,a=i?g.current.get(i):null,l=a?.texture?.orig?.width??0,o=a?.texture?.orig?.height??0;if(!a||l<=0||o<=0){e.visible=!1;return}e.visible=!0,e.position.set(a.position.x,a.position.y),e.rotation=a.rotation,e.scale.set(a.scale.x,a.scale.y);let s=u.current,c=Math.max(1e-4,s?.scale?.x||1),d=Math.max(1e-4,Math.abs(a.scale.x)||1),h=M((.18-c)/.12,0,1);t.clear(),t.rect(-l/2,-o/2,l,o),t.stroke({width:(2.2+ +h)/(d*c),color:6333946,alpha:.9});let f=(9+2*h)/(d*c),m=ey(l,o);for(let e of["tl","tr","br","bl"]){let t=r[e];t&&(t.clear(),t.rect(m[e].x-f/2,m[e].y-f/2,f,f),t.fill(0xf8fafc),t.stroke({width:1.25/(d*c),color:2042167,alpha:.9}),t.__handle={corner:e})}})(),(()=>{let e=Y.current;if(!e)return;let t=$.current;if(!t||t.length<=1)return e.clear();let r=o.scale.x||1,n=2/Math.max(1e-4,r),i=6/Math.max(1e-4,r),a=2/Math.max(1e-4,r);for(let r of(e.clear(),t)){let t=g.current.get(r);if(!t)continue;let l=t.texture?.orig?.width??0,o=t.texture?.orig?.height??0;if(l<=0||o<=0)continue;let s=l*t.scale.x/2+a,c=o*t.scale.y/2+a,d=Math.cos(t.rotation),u=Math.sin(t.rotation),h=(e,r)=>({x:t.position.x+e*d-r*u,y:t.position.y+e*u+r*d}),f=h(-s,-c),m=h(s,-c),p=h(s,c),x=h(-s,c);e.lineStyle(i,6333946,.22),e.moveTo(f.x,f.y),e.lineTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(f.x,f.y),e.lineStyle(n,6333946,.98),e.moveTo(f.x,f.y),e.lineTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(f.x,f.y)}})(),(()=>{let e=Q.current;if(!e)return;e.container.position.set(t.renderer.width-220-12,t.renderer.height-160-12);let r=performance.now();if(G.current?(e.showUntilMs=1/0,e.targetAlpha=1,e.container.visible=!0):r>e.showUntilMs&&(e.targetAlpha=0),e.container.alpha+=(e.targetAlpha-e.container.alpha)*.18,e.container.alpha<.02&&0===e.targetAlpha){e.container.visible=!1;return}if(!e.container.visible)return;let n=o.toLocal(new l.bRX(0,0)),i=o.toLocal(new l.bRX(t.renderer.width,t.renderer.height)),a=Math.min(n.x,i.x),s=Math.max(n.x,i.x),c=Math.min(n.y,i.y),d=Math.max(n.y,i.y);for(let e of g.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;a=Math.min(a,e.position.x-n),s=Math.max(s,e.position.x+n),c=Math.min(c,e.position.y-i),d=Math.max(d,e.position.y+i)}let u=Math.max(10,.06*Math.max(s-a,d-c));a-=u,s+=u,c-=u,d+=u;let h=Math.max(1,s-a),f=Math.max(1,d-c),m=Math.min(200/h,140/f),p=10+(200-h*m)/2,x=10+(140-f*m)/2,w=e=>p+(e-a)*m,y=e=>x+(e-c)*m;e.map={minX:a,minY:c,maxX:s,maxY:d,s:m,offsetX:p,offsetY:x,pad:10,innerW:200,innerH:140};let v=new Set,b=new Set($.current??[]);for(let t of g.current.values()){let r=t.__objectId;if(!r)continue;let n=t.texture,i=n?.orig?.width??0,a=n?.orig?.height??0;if(i<=0||a<=0)continue;v.add(r);let o=e.spriteById.get(r);o?o.texture!==n&&(o.texture=n):((o=new l.kxk(n)).anchor.set(.5),o.eventMode="none",e.items.addChild(o),e.spriteById.set(r,o)),o.position.set(w(t.position.x),y(t.position.y)),o.scale.set(t.scale.x*m,t.scale.y*m),o.rotation=t.rotation,o.alpha=b.has(r)?1:.92}for(let[t,r]of e.spriteById.entries())v.has(t)||(r.destroy({children:!1}),e.spriteById.delete(t));if(e.overlay.clear(),b.size>0)for(let t of(e.overlay.lineStyle(2,0xfbbf24,.95),b)){let r=g.current.get(t);if(!r)continue;let n=r.texture,i=n?.orig?.width??0,a=n?.orig?.height??0;if(i<=0||a<=0)continue;let l=i*r.scale.x*m,o=a*r.scale.y*m,s=w(r.position.x),c=y(r.position.y);e.overlay.drawRect(s-l/2,c-o/2,l,o)}e.viewport.clear();let j=w(n.x),_=y(n.y),N=w(i.x),z=y(i.y),C=Math.min(j,N),k=Math.min(_,z),R=Math.abs(N-j),T=Math.abs(z-_),S=210,E=150,I=M(C,10,210),A=M(k,10,E),F=M(C+R,10,S),L=M(k+T,10,E),D=Math.min(I,F),B=Math.min(A,L),P=Math.max(0,Math.abs(F-I)),O=Math.max(0,Math.abs(L-A));e.shade.clear(),e.shade.beginFill(0,eE.current),e.shade.drawRect(10,10,200,Math.max(0,B-10)),e.shade.drawRect(10,B+O,200,Math.max(0,E-(B+O))),e.shade.drawRect(10,B,Math.max(0,D-10),O),e.shade.drawRect(D+P,B,Math.max(0,S-(D+P)),O),e.shade.endFill(),e.viewport.beginFill(6333946,.07),e.viewport.drawRect(D,B,P,O),e.viewport.endFill();let U=Math.max(0,P-6),V=Math.max(0,O-6);U>0&&V>0&&(e.viewport.lineStyle(6,6333946,.22),e.viewport.drawRect(D+3,B+3,U,V));let H=Math.max(0,P-2),X=Math.max(0,O-2);H>0&&X>0&&(e.viewport.lineStyle(2,6333946,1),e.viewport.drawRect(D+1,B+1,H,X))})();let h=1===$.current.length?$.current[0]:null,p=h&&E.current.has(h)?h:null,x=L.current;if(x!==p){if(x){let e=S.current.get(x);e&&e.pause()}L.current=p}if(p){let e=S.current.get(p)??null;if(e){e.loop=!0;let t=Date.now(),r=Number(D.current.get(p)??0);e.paused&&t-r>250&&(D.current.set(p,t),e.play().catch(()=>{}))}}let v=A.current;if(v){let e=g.current.get(v),t=I.current.get(v);if(e&&t){let r=Number(e.texture?.orig?.width??0),n=Number(e.texture?.orig?.height??0);if(r>0&&n>0){let e=S.current.get(v)??null,i=e&&Number.isFinite(e.duration)?Number(e.duration):0,a=e&&Number.isFinite(e.currentTime)?Number(e.currentTime):0,l=i>0?M(a/i,0,1):0,o=Math.min(r,n),s=M(.065*o,10,22),c=M(.045*o,4,10),d=Math.max(10,r-2*s),u=-d/2,h=n/2-s-c,f=Math.min(c/2,6);t.visible=!0,t.clear(),t.roundRect(u,h,d,c,f),t.fill({color:0,alpha:.42}),t.roundRect(u,h,d,c,f),t.stroke({width:1,color:0xffffff,alpha:.1});let m=d*l;if(m>.75){let e=Math.min(f,m/2);t.roundRect(u,h,m,c,e),t.fill({color:6333946,alpha:.92})}}else t.visible=!1}}}),eG(s),eX()})(),()=>{}},[e.projectId]),(0,i.useEffect)(()=>{e.onFocusRequest?.(e=>{let t=u.current,r=d.current;if(!t||!r)return;let n=g.current.get(e);if(!n)return;let i=n.position,a=z(n,r.renderer.width,r.renderer.height,.88)??t.scale.x;ed([e]);let l=r.renderer.width/2-i.x*a,o=r.renderer.height/2-i.y*a;er(),en({x:l,y:o,zoom:a},{durationMs:340,onComplete:()=>{let e=u.current;e&&(eH({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eX())}})}),e.onViewportCenterRequest?.(()=>{let e=u.current,t=d.current;if(!e||!t)return{x:0,y:0};let r=new l.bRX(t.renderer.width/2,t.renderer.height/2),n=e.toLocal(r);return{x:n.x,y:n.y}})},[e.projectId]),(0,i.useEffect)(()=>{let e=m.current;e&&eG(e)},[ea,eW]);let eG=e=>{let t=new Set(ea.map(e=>e.id));for(let[e,r]of g.current.entries())t.has(e)||(r.destroy({children:!0}),g.current.delete(e),S.current.delete(e),E.current.delete(e),I.current.delete(e),P.current.delete(e),O.current.delete(e));for(let[e,r]of y.current.entries())t.has(e)||(r.destroy({children:!0}),y.current.delete(e),S.current.delete(e),E.current.delete(e),I.current.delete(e),P.current.delete(e),O.current.delete(e));for(let t of ea){if(g.current.has(t.id)){let e=g.current.get(t.id);e.position.set(t.x,t.y),e.scale.set(t.scale_x,t.scale_y),e.rotation=t.rotation,e.zIndex=t.z_index,C(e);let r=y.current.get(t.id);r&&(r.position.set(t.x,t.y),r.scale.set(t.scale_x,t.scale_y),r.rotation=t.rotation,r.zIndex=t.z_index-.25,P.current.has(t.id)||P.current.set(t.id,{current:0,target:0}));continue}if("image"===t.type&&t.asset_id){var r;let n=eW.get(t.asset_id);if(!n)continue;let i=new l.A1g;i.eventMode="none",i.position.set(t.x,t.y),i.scale.set(t.scale_x,t.scale_y),i.rotation=t.rotation,i.zIndex=t.z_index-.25,i.__objectId=t.id,y.current.set(t.id,i),P.current.set(t.id,{current:0,target:0}),e.addChild(i);let a=new l.kxk(l.gPd.EMPTY);if(a.eventMode="static",a.cursor="move",a.anchor.set(.5),a.position.set(t.x,t.y),a.scale.set(t.scale_x,t.scale_y),a.rotation=t.rotation,a.zIndex=t.z_index,a.__objectId=t.id,g.current.set(t.id,a),e.addChild(a),(r=n.mime_type)&&r.startsWith("video/")){E.current.add(t.id);let e=new l.A1g;e.eventMode="none",e.visible=!1,I.current.set(t.id,e),a.addChild(e)}else E.current.delete(t.id);let o=n.storage_url,s=o.startsWith("http")?o:new URL(o,window.location.href).toString(),c=R.current.get(s);if(c){a.texture=c,C(a);let e=_(a.texture);if(e){S.current.set(t.id,e);try{(1===$.current.length?$.current[0]:null)!==t.id&&(e.pause(),Number.isFinite(e.currentTime)&&0!==e.currentTime&&(e.currentTime=0),e.loop=!1)}catch{}}else S.current.delete(t.id);let r=a.texture?.orig?.width??0,n=a.texture?.orig?.height??0;if(r>0&&n>0){let e=Math.min(22,r/2,n/2);k(i,r,n,e,P.current.get(t.id)?.current??0)}eR(t.id,a.texture);continue}let d=T.current.get(s)??l.sP.load(s).then(e=>(R.current.set(s,e),e)).catch(e=>{throw console.error("pixi_texture_load_failed",s,e),e}).finally(()=>{T.current.delete(s)});T.current.set(s,d),d.then(e=>{let r=g.current.get(t.id);if(r){r.texture=e,C(r);let n=_(r.texture);if(n){S.current.set(t.id,n);try{(1===$.current.length?$.current[0]:null)!==t.id&&(n.pause(),Number.isFinite(n.currentTime)&&0!==n.currentTime&&(n.currentTime=0),n.loop=!1)}catch{}}else S.current.delete(t.id);let i=r.texture?.orig?.width??0,a=r.texture?.orig?.height??0;if(i>0&&a>0){let e=Math.min(22,i/2,a/2),r=y.current.get(t.id),n=P.current.get(t.id)?.current??0;r&&k(r,i,a,e,n)}eR(t.id,r.texture)}}).catch(()=>{})}}},eQ=async t=>{let r;t.preventDefault(),eh(null);let n=d.current,i=u.current;if(!n||!i)return;let a=++H.current,o=Array.from(t.dataTransfer.files||[]);if(0===o.length)return;let s=n.canvas.getBoundingClientRect(),c=(t.clientX-s.left)*n.renderer.width/s.width,h=(t.clientY-s.top)*n.renderer.height/s.height,f=28*n.renderer.width/s.width,m=28*n.renderer.height/s.height,p=40*n.renderer.width/s.width,x=40*n.renderer.height/s.height,w=new FormData;for(let e of o)w.append("files",e,e.name);try{r=await fetch(`/api/projects/${e.projectId}/assets/upload`,{method:"POST",body:w})}catch(e){console.error("upload_failed(fetch)",e),eh("Upload failed (network). If you restarted dev server, refresh the page.");return}if(!r.ok){let e=await r.text().catch(()=>"");console.error("upload_failed(response)",r.status,e),eh(`Upload failed (${r.status}).`);return}let g=(await r.json()).assets||[];es(e=>{let t=[...g,...e],r=new Set;return t.filter(e=>!r.has(e.id)&&(r.add(e.id),!0))});let y=g.map(()=>globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`);y.length>0&&a===H.current&&(X.current={objectId:y[0],rx:c,ry:h,fired:!1});let v=new Date().toISOString();el(t=>{let r=[...t],n=t.reduce((e,t)=>Math.max(e,t.z_index),0)+1;for(let t=0;t<g.length;t++){let a=g[t],o=t%12,s=Math.floor(t/12),d=i.toLocal(new l.bRX(c+o*f+s*p,h+o*m+s*x));r.push({id:y[t],project_id:e.projectId,type:"image",asset_id:a.id,x:d.x,y:d.y,scale_x:1,scale_y:1,rotation:0,width:a.width??null,height:a.height??null,z_index:n++,props_json:null,created_at:v,updated_at:v})}return eO(r),eU(r),r})};return(0,n.jsxs)("div",{onDragOver:e=>e.preventDefault(),onDrop:eQ,className:"relative h-full w-full",children:[(0,n.jsx)("div",{ref:c,className:"absolute inset-0 "+(ex?"opacity-0 pointer-events-none":"opacity-100")}),eg?(0,n.jsx)("div",{className:"pointer-events-none absolute inset-0 z-40 grid place-items-center",children:(0,n.jsx)("div",{className:"rounded-xl border border-white/10 bg-black/60 px-4 py-3 text-sm text-zinc-200 backdrop-blur",children:"Loading"})}):null,ev.online?null:(0,n.jsx)("div",{className:"pointer-events-none absolute right-4 top-4 z-50",children:(0,n.jsx)("div",{className:"rounded-full border px-3 py-1 text-[11px] font-medium "+(ev.online?"border-amber-900/40 bg-amber-950/35 text-amber-200":"border-red-900/50 bg-red-950/50 text-red-200"),children:"Offline"})}),eu?(0,n.jsx)("div",{className:"pointer-events-none absolute left-1/2 top-10 -translate-x-1/2 rounded-lg border border-red-900/50 bg-red-950/60 px-3 py-2 text-xs text-red-200",children:eu}):null,ef&&eW.get(ef)?(0,n.jsx)(s,{projectId:e.projectId,asset:eW.get(ef),originRect:ez,onClose:()=>em(null)}):null]})}var T=r(5012);function S(e){let[t,r]=(0,i.useState)(!1),[a,l]=(0,i.useState)(""),[o,s]=(0,i.useState)([]),c=(0,i.useRef)(null),d=(0,i.useMemo)(()=>{let t=new Map;for(let r of e.objects)"image"===r.type&&r.asset_id&&t.set(r.asset_id,r.id);return t},[e.objects]);(0,i.useEffect)(()=>{let e=e=>{let t=navigator.platform.toLowerCase().includes("mac")?e.metaKey:e.ctrlKey;"Escape"===e.key&&r(!1);let n=e.key.toLowerCase();if(!e.repeat&&t&&!e.altKey&&"k"===n){e.preventDefault(),r(e=>!e);return}if(!e.repeat&&t&&!e.altKey&&"f"===n){e.preventDefault(),r(!0);return}!function(e){if(!e)return!1;if(e.isContentEditable)return!0;let t=e.tagName?.toLowerCase?.()??"";return!!("input"===t||"textarea"===t||"select"===t||"function"==typeof e.closest&&e.closest('[contenteditable="true"]'))}(e.target)&&(e.repeat||e.altKey||e.metaKey||e.ctrlKey||"f"!==n||(e.preventDefault(),r(!0)))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.useEffect)(()=>{let e=()=>r(e=>!e);return window.addEventListener("moondream:command-palette:toggle",e),()=>window.removeEventListener("moondream:command-palette:toggle",e)},[]),(0,i.useEffect)(()=>{let e=()=>r(!0);return window.addEventListener("moondream:command-palette:open",e),()=>window.removeEventListener("moondream:command-palette:open",e)},[]),(0,i.useEffect)(()=>{if(!t)return;let r=window.setTimeout(async()=>{let t=await fetch(`/api/projects/${e.projectId}/assets/search?q=${encodeURIComponent(a)}&limit=50&mode=hybrid`);t.ok&&s((await t.json()).assets??[])},120);return()=>window.clearTimeout(r)},[t,a,e.projectId]),(0,i.useEffect)(()=>{if(!t)return;let e=window.requestAnimationFrame(()=>{let e=c.current;e&&(e.focus(),e.select())});return()=>window.cancelAnimationFrame(e)},[t]);let u=t?o:[];return(0,n.jsxs)(n.Fragment,{children:[t?(0,n.jsx)("div",{className:"fixed inset-0 z-50 bg-black/40",onClick:()=>r(!1)}):null,(0,n.jsx)("div",{className:t?"fixed left-1/2 top-16 z-50 w-[720px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl":"hidden",children:(0,n.jsxs)(T.uB,{className:"flex flex-col overflow-hidden",children:[(0,n.jsx)("div",{className:"border-b border-zinc-900 p-3",children:(0,n.jsx)(T.uB.Input,{ref:c,autoFocus:!0,value:a,onValueChange:l,placeholder:"Search assets",className:"w-full bg-transparent text-sm outline-none placeholder:text-zinc-600"})}),(0,n.jsxs)(T.uB.List,{className:"max-h-[420px] overflow-auto p-2",children:[(0,n.jsx)(T.uB.Empty,{className:"p-3 text-sm text-zinc-500",children:"No results."}),u.map(t=>{let i=d.get(t.id),l="done"===t.ai_status?t.ai_caption:t.ai_status?t.ai_status:"";return(0,n.jsxs)(T.uB.Item,{value:`${t.original_name} ${t.ai_caption??""}`,onSelect:()=>{r(!1),i?e.onFocusObjectId(i):e.onPlaceAssetAtViewportCenter(t.id);let n=a.trim().split(/\s+/g).filter(Boolean)[0]?.toLowerCase();!n||e.onHighlightAsset&&fetch(`/api/projects/${e.projectId}/assets/${t.id}/segments?term=${encodeURIComponent(n)}`).then(e=>e.ok?e.json():null).then(r=>{r&&e.onHighlightAsset?.({assetId:t.id,term:n,svg:r.svg??null,bboxJson:r.bboxJson??null})}).catch(()=>{})},className:"flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 aria-selected:bg-zinc-900",children:[(0,n.jsx)("div",{className:"h-10 w-10 shrink-0 rounded bg-zinc-900 overflow-hidden",children:t.thumb_url?(0,n.jsx)("img",{src:t.thumb_url,alt:"",className:"h-full w-full object-contain"}):null}),(0,n.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,n.jsx)("div",{className:"truncate",children:t.original_name}),l?(0,n.jsx)("div",{className:"truncate text-xs text-zinc-500",children:l}):null]})]},t.id)})]}),(0,n.jsx)("div",{className:"border-t border-zinc-900 p-2 text-xs text-zinc-500"})]})})]})}var E=r(7650),I=r(2374);function A(e){return"undefined"==typeof document?null:(0,E.createPortal)(e.children,document.body)}function F(e){let t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}}function L(e){let t,r=(0,a.useRouter)(),[l,o]=(0,i.useState)(!1),[s,c]=(0,i.useState)([]),[d,u]=(0,i.useState)(null),[h,f]=(0,i.useState)(null),[m,p]=(0,i.useState)(null),[x,w]=(0,i.useState)(null),g=(0,i.useRef)(null),y=(0,i.useRef)(null),[v,b]=(0,i.useState)(!1),[j,M]=(0,i.useState)(null),_=(0,i.useMemo)(()=>s.find(t=>t.id===e.currentProjectId)??null,[s,e.currentProjectId]),N=async()=>{let e=await fetch("/api/projects");e.ok&&c((await e.json()).projects??[])};(0,i.useEffect)(()=>{N()},[]),(0,i.useEffect)(()=>{b(navigator.platform.toLowerCase().includes("mac"))},[]),(0,i.useLayoutEffect)(()=>{l&&g.current&&p(F(g.current))},[l]),(0,i.useLayoutEffect)(()=>{h&&y.current&&w(F(y.current))},[h]);let z=async()=>{if(!j||"new"!==j.type)return;let e=j.name.trim();if(e){u("new");try{let t=await fetch("/api/projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!t.ok)return;let n=await t.json();await N(),o(!1),f(null),M(null),r.push(`/projects/${n.project.id}`)}finally{u(null)}}},C=async e=>{if(!j||"rename"!==j.type||j.project.id!==e.id)return;let t=j.name.trim();if(t){u(e.id);try{if(!(await fetch(`/api/projects/${e.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})})).ok)return;await N(),f(null),M(null)}finally{u(null)}}},k=async t=>{if(j&&"delete"===j.type&&j.project.id===t.id){u(t.id);try{if(!(await fetch(`/api/projects/${t.id}`,{method:"DELETE"})).ok)return;await N(),o(!1),f(null),M(null),t.id===e.currentProjectId&&r.push("/")}finally{u(null)}}};return(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsxs)("button",{ref:g,onClick:()=>{o(e=>!e),f(null)},className:"text"===e.variant?"inline-flex items-center gap-2 px-2 py-1 text-sm font-medium text-zinc-200 hover:text-zinc-50":"inline-flex items-center gap-2 rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{className:"max-w-[220px] truncate",children:_?.name??"Select project"}),(0,n.jsx)("span",{"aria-hidden":!0,className:"text-current",children:(0,n.jsx)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",className:"h-4 w-4",children:(0,n.jsx)("path",{d:"M6 9l6 6 6-6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),(0,n.jsxs)(A,{children:[l&&m?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9998]",onMouseDown:()=>{o(!1),f(null)}}),(0,n.jsxs)("div",{className:"fixed z-[9999] w-[340px] rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl",style:{left:Math.max(8,Math.min(window.innerWidth-340-8,"center"===(t=e.align??"right")?m.left+m.width/2-170:"left"===t?m.left:m.left+m.width-340)),top:m.top+m.height+8},children:[(0,n.jsxs)("div",{className:"flex items-center justify-between border-b border-zinc-900 px-3 py-2",children:[(0,n.jsx)("div",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Projects"}),(0,n.jsx)("button",{onClick:()=>M({type:"new",name:"New project"}),disabled:"new"===d,className:"rounded-md bg-zinc-50 px-2 py-1 text-xs font-medium text-zinc-950 disabled:opacity-60",children:"New"})]}),(0,n.jsx)("div",{className:"max-h-[360px] overflow-auto",children:s.map(t=>{let i=t.id===e.currentProjectId,a=d===t.id;return(0,n.jsxs)("div",{className:`flex items-center gap-2 px-3 py-2 text-sm ${i?"bg-zinc-900/60":"hover:bg-zinc-900"}`,children:[(0,n.jsxs)("button",{disabled:a,onClick:()=>{o(!1),f(null),r.push(`/projects/${t.id}`)},className:"min-w-0 flex-1 text-left flex items-center gap-3",children:[(0,n.jsx)("div",{className:"h-12 w-12 shrink-0 overflow-hidden rounded-lg border border-white/10 bg-zinc-900",children:(0,n.jsx)("img",{src:`/files/projects/${t.id}/preview`,alt:"",className:"h-full w-full object-cover",onError:e=>{e.currentTarget.style.display="none"}})}),(0,n.jsx)("div",{className:"min-w-0 flex-1",children:(0,n.jsx)("div",{className:"truncate text-zinc-200",children:t.name})})]}),(0,n.jsx)("button",{ref:h?.id===t.id?y:null,disabled:a,onClick:e=>{e.stopPropagation(),f(e=>e?.id===t.id?null:t)},className:"rounded-md px-2 py-1 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200",title:"Project actions",children:""})]},t.id)})}),(0,n.jsxs)("div",{className:"border-t border-zinc-900 p-2",children:[(0,n.jsxs)("button",{onClick:()=>{o(!1),f(null),window.dispatchEvent(new Event("moondream:command-palette:toggle"))},className:"flex w-full items-center justify-between rounded-lg px-2 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{children:"Search board"}),(0,n.jsx)("span",{className:"rounded border border-zinc-800 bg-zinc-900/40 px-1.5 py-0.5 text-[10px] text-zinc-400",children:v?"K":"Ctrl+K"})]}),(0,n.jsxs)("button",{onClick:()=>{o(!1),f(null),(0,I.yl)(),window.setTimeout(()=>{r.push(`/settings?projectId=${encodeURIComponent(e.currentProjectId)}`)},I.aJ)},className:"flex w-full items-center justify-between rounded-lg px-2 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{children:"Settings"}),(0,n.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,n.jsx)("span",{className:"rounded border border-zinc-800 bg-zinc-900/40 px-1.5 py-0.5 text-[10px] text-zinc-400",children:v?".":"Ctrl+."}),(0,n.jsx)("span",{className:"rounded border border-zinc-800 bg-zinc-900/40 px-1.5 py-0.5 text-[10px] text-zinc-400",children:"."})]})]})]})]})]}):null,h&&x?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9999]",onMouseDown:()=>f(null)}),(0,n.jsxs)("div",{className:"fixed z-[10000] w-40 rounded-lg border border-zinc-800 bg-zinc-950 shadow-xl overflow-hidden",style:{left:Math.min(window.innerWidth-168,x.left+x.width-160),top:x.top+x.height+6},children:[(0,n.jsx)("button",{onClick:()=>M({type:"rename",project:h,name:h.name}),className:"block w-full px-3 py-2 text-left text-sm text-zinc-200 hover:bg-zinc-900",children:"Rename"}),(0,n.jsx)("button",{onClick:()=>M({type:"delete",project:h}),className:"block w-full px-3 py-2 text-left text-sm text-red-300 hover:bg-zinc-900",children:"Delete"})]})]}):null,j?(0,n.jsxs)("div",{className:"fixed inset-0 z-[10001]",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/50",onMouseDown:()=>M(null)}),(0,n.jsx)("div",{className:"absolute left-1/2 top-28 w-[420px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 p-4 shadow-2xl",children:"delete"===j.type?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"Delete project?"}),(0,n.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:j.project.name}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>M(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>k(j.project),disabled:d===j.project.id,className:"rounded-md bg-red-500 px-3 py-2 text-sm font-medium text-white disabled:opacity-60",children:"Delete"})]})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"new"===j.type?"New project":"Rename project"}),(0,n.jsx)("input",{autoFocus:!0,value:j.name,onChange:e=>{let t=e.target.value;M(e=>e&&("new"===e.type||"rename"===e.type)?{...e,name:t}:e)},className:"mt-3 w-full rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 outline-none focus:border-zinc-600",placeholder:"Project name"}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>M(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>{"new"===j.type&&z(),"rename"===j.type&&C(j.project)},disabled:"new"===d||"rename"===j.type&&d===j.project.id,className:"rounded-md bg-zinc-50 px-3 py-2 text-sm font-medium text-zinc-950 disabled:opacity-60",children:"Save"})]})]})})]}):null]})]})}function D(e){let{project:t}=e,r=(0,a.useRouter)(),[l,o]=(0,i.useState)(e.initialObjects),[s,c]=(0,i.useState)(null),[d,u]=(0,i.useState)(null),[h,f]=(0,i.useState)(null);return(0,i.useEffect)(()=>{(0,I.TE)();let e=e=>{if("Escape"===e.key||function(e){if(!e)return!1;if(e.isContentEditable)return!0;let t=e.tagName?.toLowerCase?.()??"";return!!("input"===t||"textarea"===t||"select"===t||"function"==typeof e.closest&&e.closest('[contenteditable="true"]'))}(e.target)||e.repeat)return;let n=navigator.platform.toLowerCase().includes("mac")?e.metaKey:e.ctrlKey;"."!==e.key||e.altKey||(e.metaKey||e.ctrlKey)&&!n||(e.preventDefault(),(0,I.yl)(),window.setTimeout(()=>{r.push(`/settings?projectId=${encodeURIComponent(t.id)}`)},I.aJ))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t.id,r]),(0,n.jsxs)("div",{className:"h-screen w-screen bg-zinc-950 text-zinc-50 overflow-hidden",children:[(0,n.jsx)(R,{projectId:t.id,initialAssets:e.initialAssets,initialObjects:l,initialView:e.initialView,highlightOverlay:s,onObjectsChange:o,onFocusRequest:e=>u(()=>e),onViewportCenterRequest:e=>f(()=>e)}),(0,n.jsx)("div",{className:"pointer-events-none absolute inset-x-0 top-0 z-40 h-14 bg-gradient-to-b from-black/50 to-transparent"}),(0,n.jsx)("div",{className:"absolute left-3 top-3 z-50",children:(0,n.jsx)(L,{currentProjectId:t.id,variant:"text",align:"left"})}),(0,n.jsx)(S,{projectId:t.id,objects:l,onFocusObjectId:e=>d?.(e),onPlaceAssetAtViewportCenter:async e=>{let r=h?.()??{x:0,y:0},n=[...l,{id:globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`,project_id:t.id,type:"image",asset_id:e,x:r.x,y:r.y,scale_x:1,scale_y:1,rotation:0,width:null,height:null,z_index:l.reduce((e,t)=>Math.max(e,t.z_index),0)+1,props_json:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}];o(n),await fetch(`/api/projects/${t.id}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:n})})},onHighlightAsset:e=>c(e)})]})}},945:(e,t,r)=>{Promise.resolve().then(r.bind(r,22))},2374:(e,t,r)=>{"use strict";r.d(t,{J0:()=>i,TE:()=>o,aJ:()=>n,w9:()=>a,yl:()=>l});let n=220,i="moondream:route-fade:start",a="moondream:route-fade:end";function l(){window.dispatchEvent(new Event(i))}function o(){window.dispatchEvent(new Event(a))}}},e=>{e.O(0,[679,441,794,358],()=>e(e.s=945)),_N_E=e.O()}]);