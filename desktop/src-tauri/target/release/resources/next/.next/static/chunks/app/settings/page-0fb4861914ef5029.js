(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[662],{2374:(e,t,n)=>{"use strict";n.d(t,{J0:()=>s,TE:()=>l,aJ:()=>i,w9:()=>a,yl:()=>r});let i=220,s="moondream:route-fade:start",a="moondream:route-fade:end";function r(){window.dispatchEvent(new Event(s))}function l(){window.dispatchEvent(new Event(a))}},3321:(e,t,n)=>{"use strict";var i=n(4645);n.o(i,"useRouter")&&n.d(t,{useRouter:function(){return i.useRouter}}),n.o(i,"useSearchParams")&&n.d(t,{useSearchParams:function(){return i.useSearchParams}})},6943:(e,t,n)=>{Promise.resolve().then(n.bind(n,9689))},9689:(e,t,n)=>{"use strict";n.d(t,{default:()=>l});var i=n(5155),s=n(2115),a=n(3321),r=n(2374);function l(){let e=(0,a.useRouter)(),t=(0,a.useSearchParams)(),n=t?.get("projectId")??null,[l,o]=(0,s.useState)("enter"),c=(0,s.useRef)(null),d=(0,s.useRef)(!1),x=(0,s.useRef)(n),[m,u]=(0,s.useState)(!1),[p,h]=(0,s.useState)(!1),[g,v]=(0,s.useState)(!1),[f,b]=(0,s.useState)(null),[j,y]=(0,s.useState)(null),[z,N]=(0,s.useState)(!1),[w,k]=(0,s.useState)(null),[S,E]=(0,s.useState)(null),[_,T]=(0,s.useState)(!1),[C,P]=(0,s.useState)(null),[R,A]=(0,s.useState)({storage:{mode:"local"},ai:{provider:"local_station"}}),[F,I]=(0,s.useState)({icloudDir:null,moondreamEndpoint:"http://localhost:2023/v1",hfEndpointUrl:"https://api-inference.huggingface.co/models/moondream/moondream3-preview",hfTokenSet:!1}),[D,L]=(0,s.useState)(""),U=(0,s.useMemo)(()=>"icloud"!==R.storage.mode?null:R.storage.icloudPath||F.icloudDir,[R.storage.mode,R.storage.icloudPath,F.icloudDir]);(0,s.useEffect)(()=>{let e=!1;return(async()=>{let t=await fetch("/api/settings");if(!t.ok)return;let n=await t.json();e||(A({...n.settings,ai:{...n.settings.ai,endpoint:"local_station"===n.settings.ai.provider?n.settings.ai.endpoint?.trim()||n.defaults.moondreamEndpoint:n.settings.ai.endpoint}}),I(n.defaults),u(!0))})().catch(()=>u(!0)),()=>{e=!0}},[]);let H=async(e,t)=>{let n=window;if(!n?.__TAURI__?.invoke)throw Error("Tauri API not available (not running in desktop app).");return await n.__TAURI__.invoke(e,t??{})};(0,s.useEffect)(()=>{let e=window;if(!e?.__TAURI__?.invoke)return;let t=!1,n=null,i=async()=>{try{let e="local_station"===R.ai.provider&&R.ai.endpoint?.trim()||F.moondreamEndpoint,n=await H("station_status",{endpoint:e});if(t)return;E(n)}catch{}finally{if(t)return;n=window.setTimeout(i,2500)}};return i(),()=>{t=!0,n&&window.clearTimeout(n)}},[R.ai.provider,R.ai.endpoint,F.moondreamEndpoint]),(0,s.useEffect)(()=>{let e=!1,t=null,n=async()=>{try{let t=await fetch("/api/ai/progress",{cache:"no-store"});if(!t.ok)return;let n=await t.json();if(e)return;k(n)}catch{}finally{if(e)return;t=window.setTimeout(n,2e3)}};return n(),()=>{e=!0,t&&window.clearTimeout(t)}},[]),(0,s.useEffect)(()=>{x.current=n},[n]),(0,s.useEffect)(()=>{(0,r.TE)()},[]),(0,s.useEffect)(()=>{let e=window.requestAnimationFrame(()=>o("entered"));return()=>window.cancelAnimationFrame(e)},[]);let M=()=>{d.current||(d.current=!0,(0,r.yl)(),o("exit"),c.current&&window.clearTimeout(c.current),c.current=window.setTimeout(()=>{let t,n;c.current=null,n=(t=x.current)?`/projects/${t}`:"/",e.push(n)},r.aJ))};(0,s.useEffect)(()=>()=>{c.current&&window.clearTimeout(c.current),c.current=null},[]),(0,s.useEffect)(()=>{let e=e=>{"Escape"===e.key&&(e.preventDefault(),M())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);let O=async e=>{h(!0),v(!1),b(null);try{let t=R.ai.provider,n=R.ai.endpoint?.trim()||void 0,i=D.trim(),s={storage:{mode:R.storage.mode,icloudPath:"icloud"===R.storage.mode&&R.storage.icloudPath?.trim()||void 0},ai:{provider:t,endpoint:n,...e?.clearHfToken?{hfToken:null}:i.length>0?{hfToken:i}:{}}};if(!(await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).ok)throw Error("Failed to save settings");v(!0),e?.clearHfToken?(I(e=>({...e,hfTokenSet:!1})),L("")):i.length>0&&(I(e=>({...e,hfTokenSet:!0})),L(""))}catch(e){b(e.message)}finally{h(!1)}};return(0,i.jsxs)("div",{className:"fixed inset-0 overflow-auto text-zinc-50",children:[(0,i.jsx)("div",{className:`pointer-events-none fixed inset-0 bg-black transition-opacity duration-200 ease-out motion-reduce:transition-none ${"entered"===l||"exit"===l?"opacity-100":"opacity-0"}`}),(0,i.jsxs)("div",{className:`relative mx-auto max-w-3xl px-6 py-10 transition-[opacity,transform] duration-200 ease-out motion-reduce:transition-none ${"entered"===l?"opacity-100 translate-y-0":"opacity-0 translate-y-1"}`,children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-lg font-semibold",children:"Settings"}),(0,i.jsx)("div",{className:"mt-1 text-sm text-zinc-500",children:"Desktop settings apply after restart."})]}),(0,i.jsx)("button",{onClick:()=>{M()},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900",children:"Back"})]}),(0,i.jsxs)("div",{className:"mt-8 rounded-xl border border-zinc-800 bg-zinc-950 p-4",children:[(0,i.jsx)("div",{className:"text-sm font-medium",children:"Storage"}),(0,i.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:"Default is local. Switching storage will move your library (DB + assets) on next app launch. iCloud sync is convenient but SQLite can misbehave if you open the app on two Macs at the same time."}),(0,i.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"storage",checked:"local"===R.storage.mode,onChange:()=>A(e=>({...e,storage:{...e.storage,mode:"local"}})),className:"mt-1"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"Local (recommended)"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Stores data in Application Support on this Mac."})]})]}),(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"storage",checked:"icloud"===R.storage.mode,onChange:()=>{A(e=>({...e,storage:{...e.storage,mode:"icloud",icloudPath:(e.storage.icloudPath??F.icloudDir??void 0)||void 0}}))},className:"mt-1"}),(0,i.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"iCloud Drive"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Stores data in iCloud Drive for syncing between Macs (avoid running on two Macs concurrently)."}),(0,i.jsxs)("div",{className:"mt-3",children:[(0,i.jsx)("div",{className:"text-xs text-zinc-500 mb-1",children:"iCloud path"}),(0,i.jsx)("input",{disabled:"icloud"!==R.storage.mode,value:R.storage.icloudPath??"",onChange:e=>A(t=>({...t,storage:{...t.storage,icloudPath:e.target.value}})),placeholder:F.icloudDir??"iCloud Drive path",className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none disabled:opacity-60"}),(0,i.jsxs)("div",{className:"mt-2 text-[11px] text-zinc-600",children:["Leave blank to use the default: ",(0,i.jsx)("span",{className:"text-zinc-400",children:F.icloudDir??"N/A"})]})]})]})]})]}),f?(0,i.jsx)("div",{className:"mt-4 text-sm text-red-400",children:f}):null,g?(0,i.jsx)("div",{className:"mt-4 rounded-lg border border-amber-900/40 bg-amber-950/20 px-3 py-2 text-sm text-amber-200",children:"Saved. Close and reopen the app to apply storage changes (and move your library if you changed storage)."}):null,(0,i.jsxs)("div",{className:"mt-4 flex items-center gap-3",children:[(0,i.jsx)("button",{disabled:!m||p,onClick:()=>O(),className:"rounded-lg bg-zinc-50 px-4 py-2 text-sm font-medium text-zinc-950 disabled:opacity-60",children:p?"Saving…":"Save"}),"icloud"===R.storage.mode&&U?(0,i.jsxs)("div",{className:"text-xs text-zinc-500",children:["Effective path: ",(0,i.jsx)("span",{className:"text-zinc-300",children:U})]}):null]})]}),(0,i.jsxs)("div",{className:"mt-8 rounded-xl border border-zinc-800 bg-zinc-950 p-4",children:[(0,i.jsx)("div",{className:"text-sm font-medium",children:"AI"}),(0,i.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:"Configure the AI endpoint used by the bundled worker. If you see “failed”, it often means the app couldn’t reach the endpoint at the time."}),(0,i.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"mb-2 text-xs text-zinc-500",children:"Provider"}),(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"ai_provider",checked:"local_station"===R.ai.provider,onChange:()=>A(e=>({...e,ai:{...e.ai,provider:"local_station"}})),className:"mt-1"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"Local Station"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Uses Moondream Station running on your machine."})]})]}),(0,i.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("input",{type:"radio",name:"ai_provider",checked:"huggingface"===R.ai.provider,onChange:()=>A(e=>({...e,ai:{...e.ai,provider:"huggingface",endpoint:(e.ai.endpoint||"").trim()?e.ai.endpoint:F.hfEndpointUrl}})),className:"mt-1"}),(0,i.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,i.jsx)("div",{className:"text-sm text-zinc-200",children:"Hugging Face Endpoint"}),(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Uses a Hugging Face Inference Endpoint (requires endpoint URL + API token)."})]})]})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"mb-1 text-xs text-zinc-500",children:"huggingface"===R.ai.provider?"Hugging Face endpoint URL":"Moondream Station endpoint"}),(0,i.jsx)("input",{value:R.ai.endpoint??"",onChange:e=>A(t=>({...t,ai:{...t.ai,endpoint:e.target.value}})),placeholder:"huggingface"===R.ai.provider?F.hfEndpointUrl:F.moondreamEndpoint,className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none"}),(0,i.jsx)("div",{className:"mt-2 text-[11px] text-zinc-600",children:"huggingface"===R.ai.provider?(0,i.jsx)(i.Fragment,{children:"Paste the full endpoint URL for your Hugging Face Inference Endpoint."}):(0,i.jsxs)(i.Fragment,{children:["Examples: ",(0,i.jsx)("span",{className:"text-zinc-400",children:"http://127.0.0.1:2021/v1"})," or"," ",(0,i.jsx)("span",{className:"text-zinc-400",children:"http://localhost:2023/v1"})," (the worker accepts both and normalizes). If ",(0,i.jsx)("span",{className:"text-zinc-400",children:"localhost"})," gives issues, prefer"," ",(0,i.jsx)("span",{className:"text-zinc-400",children:"127.0.0.1"}),"."]})})]}),"huggingface"===R.ai.provider?(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{className:"mb-1 flex items-center justify-between",children:[(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:"Hugging Face API token"}),F.hfTokenSet?(0,i.jsx)("div",{className:"text-[11px] text-zinc-500",children:"Token saved"}):null]}),(0,i.jsx)("input",{value:D,onChange:e=>L(e.target.value),placeholder:F.hfTokenSet?"•••••••••• (leave blank to keep existing)":"hf_...",type:"password",autoComplete:"off",className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none"}),(0,i.jsx)("div",{className:"mt-2 text-[11px] text-zinc-600",children:"Stored locally in your app settings. The worker uses it as a Bearer token."}),F.hfTokenSet?(0,i.jsx)("div",{className:"mt-2",children:(0,i.jsx)("button",{disabled:!m||p,onClick:()=>O({clearHfToken:!0}),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:"Clear saved token"})}):null]}):null,(0,i.jsxs)("div",{className:"flex items-center gap-3",children:[(0,i.jsx)("button",{disabled:!m||p,onClick:()=>O(),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:p?"Saving…":"Save endpoint"}),(0,i.jsx)("button",{disabled:!n,onClick:async()=>{if(n){b(null),y(null),N(!0);try{let e=await fetch(`/api/projects/${n}/ai/retry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!e.ok)throw Error("Retry failed");let t=await e.json().catch(()=>null),i=t?.changes??0;y(i>0?`Retried ${i} asset(s).`:"No failed assets to retry.")}catch(e){b(e.message)}finally{N(!1)}}},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:z?"Retrying…":"Retry failed AI (this project)"}),n?null:(0,i.jsx)("div",{className:"text-xs text-zinc-600",children:"Open Settings from inside a project to enable this."})]}),j?(0,i.jsx)("div",{className:"text-xs text-zinc-500",children:j}):null,(0,i.jsxs)("div",{className:"mt-6 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("div",{className:"text-xs font-medium text-zinc-200",children:"Worker activity"}),(0,i.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-x-6 gap-y-1 text-xs text-zinc-500",children:[(0,i.jsxs)("div",{children:["Pending: ",(0,i.jsx)("span",{className:"text-zinc-200",children:w?w.counts.pending:"—"})]}),(0,i.jsxs)("div",{children:["Processing: ",(0,i.jsx)("span",{className:"text-zinc-200",children:w?w.counts.processing:"—"})]}),(0,i.jsxs)("div",{children:["Done: ",(0,i.jsx)("span",{className:"text-zinc-200",children:w?w.counts.done:"—"})]}),(0,i.jsxs)("div",{children:["Failed: ",(0,i.jsx)("span",{className:"text-zinc-200",children:w?w.counts.failed:"—"})]})]}),(0,i.jsx)("div",{className:"mt-2 text-xs text-zinc-500",children:w?.worker.currentFile?(0,i.jsxs)(i.Fragment,{children:["Currently processing: ",(0,i.jsx)("span",{className:"text-zinc-200",children:w.worker.currentFile})]}):w?.worker.logAvailable?(0,i.jsx)(i.Fragment,{children:"Worker is idle (no “processing …” line in recent logs)."}):(0,i.jsx)(i.Fragment,{children:"Worker log not found (desktop-only; this is expected in some dev setups)."})}),w?.worker.lastLogAt?(0,i.jsxs)("div",{className:"mt-1 text-[11px] text-zinc-600",children:["Last worker output: ",(0,i.jsx)("span",{className:"text-zinc-400",children:w.worker.lastLogAt})]}):null,w?.worker.logAvailable?(0,i.jsxs)("details",{className:"mt-3",children:[(0,i.jsx)("summary",{className:"cursor-pointer text-xs text-zinc-400 hover:text-zinc-200",children:"Recent worker log"}),(0,i.jsx)("pre",{className:"mt-2 max-h-56 overflow-auto rounded-md border border-zinc-900 bg-black/40 p-2 text-[11px] leading-relaxed text-zinc-300",children:(w?.worker.recentLines||[]).join("\n")})]}):null]}),window?.__TAURI__?.invoke?(0,i.jsxs)("div",{className:"mt-4 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,i.jsx)("div",{className:"text-xs font-medium text-zinc-200",children:"Moondream Station"}),(0,i.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:"If you normally run Station from Terminal, the desktop app can start it for you."}),(0,i.jsxs)("div",{className:"mt-2 text-xs text-zinc-500",children:["Endpoint:"," ",(0,i.jsx)("span",{className:"text-zinc-200",children:("local_station"===R.ai.provider&&R.ai.endpoint?.trim()||F.moondreamEndpoint).trim()})]}),(0,i.jsxs)("div",{className:"mt-2 flex items-center gap-3",children:[(0,i.jsx)("button",{disabled:_,onClick:async()=>{P(null),T(!0);try{let e="local_station"===R.ai.provider&&R.ai.endpoint?.trim()||F.moondreamEndpoint,t=await H("station_start",{endpoint:e});E(t)}catch(e){P(e.message)}finally{T(!1)}},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:_?"Starting…":"Start Station"}),(0,i.jsx)("button",{disabled:_,onClick:async()=>{P(null),T(!0);try{let e=await H("station_stop");E(e)}catch(e){P(e.message)}finally{T(!1)}},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:"Stop (if started by app)"})]}),(0,i.jsxs)("div",{className:"mt-2 text-xs text-zinc-500",children:["Status:"," ",(0,i.jsx)("span",{className:S?.reachable?"text-emerald-300":"text-zinc-300",children:S?.reachable?"Reachable":"Not reachable"}),S?.installed===!1?(0,i.jsxs)(i.Fragment,{children:[" ",(0,i.jsx)("span",{className:"text-amber-300",children:"(`moondream-station` not found)"})]}):null]}),S?.logPath?(0,i.jsxs)("div",{className:"mt-1 text-[11px] text-zinc-600",children:["Station logs: ",(0,i.jsx)("span",{className:"text-zinc-400",children:S.logPath})]}):null,S?.installed?null:(0,i.jsxs)("div",{className:"mt-2 text-[11px] text-zinc-600",children:["Install (once):"," ",(0,i.jsx)("span",{className:"text-zinc-400",children:"python3 -m pip install --user moondream-station"})]}),C?(0,i.jsx)("div",{className:"mt-2 text-xs text-red-400",children:C}):null]}):null]})]})]})]})}}},e=>{e.O(0,[441,794,358],()=>e(e.s=6943)),_N_E=e.O()}]);