(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[662],{2374:(e,t,n)=>{"use strict";n.d(t,{J0:()=>i,TE:()=>c,aJ:()=>s,w9:()=>a,yl:()=>r});let s=220,i="moondream:route-fade:start",a="moondream:route-fade:end";function r(){window.dispatchEvent(new Event(i))}function c(){window.dispatchEvent(new Event(a))}},3321:(e,t,n)=>{"use strict";var s=n(4645);n.o(s,"useRouter")&&n.d(t,{useRouter:function(){return s.useRouter}}),n.o(s,"useSearchParams")&&n.d(t,{useSearchParams:function(){return s.useSearchParams}})},6943:(e,t,n)=>{Promise.resolve().then(n.bind(n,9689))},9689:(e,t,n)=>{"use strict";n.d(t,{default:()=>c});var s=n(5155),i=n(2115),a=n(3321),r=n(2374);function c(){let e=(0,a.useRouter)(),t=(0,a.useSearchParams)(),n=t?.get("projectId")??null,[c,o]=(0,i.useState)("enter"),l=(0,i.useRef)(null),d=(0,i.useRef)(!1),x=(0,i.useRef)(n),[u,m]=(0,i.useState)(!1),[h,p]=(0,i.useState)(!1),[g,v]=(0,i.useState)(!1),[f,j]=(0,i.useState)(null),[b,y]=(0,i.useState)(null),[N,z]=(0,i.useState)(!1),[w,k]=(0,i.useState)(null),[S,E]=(0,i.useState)({storage:{mode:"local"},ai:{provider:"local_station"}}),[C,T]=(0,i.useState)({icloudDir:null,moondreamEndpoint:"http://127.0.0.1:2020",hfEndpointUrl:"https://api-inference.huggingface.co/models/moondream/moondream3-preview",hfTokenSet:!1}),[P,F]=(0,i.useState)(""),R=(0,i.useMemo)(()=>"icloud"!==S.storage.mode?null:S.storage.icloudPath||C.icloudDir,[S.storage.mode,S.storage.icloudPath,C.icloudDir]);(0,i.useEffect)(()=>{let e=!1;return(async()=>{let t=await fetch("/api/settings");if(!t.ok)return;let n=await t.json();e||(E(n.settings),T(n.defaults),m(!0))})().catch(()=>m(!0)),()=>{e=!0}},[]),(0,i.useEffect)(()=>{let e=!1,t=null,n=async()=>{try{let t=await fetch("/api/ai/progress",{cache:"no-store"});if(!t.ok)return;let n=await t.json();if(e)return;k(n)}catch{}finally{if(e)return;t=window.setTimeout(n,2e3)}};return n(),()=>{e=!0,t&&window.clearTimeout(t)}},[]),(0,i.useEffect)(()=>{x.current=n},[n]),(0,i.useEffect)(()=>{(0,r.TE)()},[]),(0,i.useEffect)(()=>{let e=window.requestAnimationFrame(()=>o("entered"));return()=>window.cancelAnimationFrame(e)},[]);let D=()=>{d.current||(d.current=!0,(0,r.yl)(),o("exit"),l.current&&window.clearTimeout(l.current),l.current=window.setTimeout(()=>{let t,n;l.current=null,n=(t=x.current)?`/projects/${t}`:"/",e.push(n)},r.aJ))};(0,i.useEffect)(()=>()=>{l.current&&window.clearTimeout(l.current),l.current=null},[]),(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&(e.preventDefault(),D())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);let A=async e=>{p(!0),v(!1),j(null);try{let t=S.ai.provider,n=S.ai.endpoint?.trim()||void 0,s=P.trim(),i={storage:{mode:S.storage.mode,icloudPath:"icloud"===S.storage.mode&&S.storage.icloudPath?.trim()||void 0},ai:{provider:t,endpoint:n,...e?.clearHfToken?{hfToken:null}:s.length>0?{hfToken:s}:{}}};if(!(await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok)throw Error("Failed to save settings");v(!0),e?.clearHfToken?(T(e=>({...e,hfTokenSet:!1})),F("")):s.length>0&&(T(e=>({...e,hfTokenSet:!0})),F(""))}catch(e){j(e.message)}finally{p(!1)}};return(0,s.jsxs)("div",{className:"fixed inset-0 overflow-auto text-zinc-50",children:[(0,s.jsx)("div",{className:`pointer-events-none fixed inset-0 bg-black transition-opacity duration-200 ease-out motion-reduce:transition-none ${"entered"===c||"exit"===c?"opacity-100":"opacity-0"}`}),(0,s.jsxs)("div",{className:`relative mx-auto max-w-3xl px-6 py-10 transition-[opacity,transform] duration-200 ease-out motion-reduce:transition-none ${"entered"===c?"opacity-100 translate-y-0":"opacity-0 translate-y-1"}`,children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-lg font-semibold",children:"Settings"}),(0,s.jsx)("div",{className:"mt-1 text-sm text-zinc-500",children:"Desktop settings apply after restart."})]}),(0,s.jsx)("button",{onClick:()=>{D()},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900",children:"Back"})]}),(0,s.jsxs)("div",{className:"mt-8 rounded-xl border border-zinc-800 bg-zinc-950 p-4",children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:"Storage"}),(0,s.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:"Default is local. Switching storage will move your library (DB + assets) on next app launch. iCloud sync is convenient but SQLite can misbehave if you open the app on two Macs at the same time."}),(0,s.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,s.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,s.jsx)("input",{type:"radio",name:"storage",checked:"local"===S.storage.mode,onChange:()=>E(e=>({...e,storage:{...e.storage,mode:"local"}})),className:"mt-1"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm text-zinc-200",children:"Local (recommended)"}),(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"Stores data in Application Support on this Mac."})]})]}),(0,s.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,s.jsx)("input",{type:"radio",name:"storage",checked:"icloud"===S.storage.mode,onChange:()=>{E(e=>({...e,storage:{...e.storage,mode:"icloud",icloudPath:(e.storage.icloudPath??C.icloudDir??void 0)||void 0}}))},className:"mt-1"}),(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsx)("div",{className:"text-sm text-zinc-200",children:"iCloud Drive"}),(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"Stores data in iCloud Drive for syncing between Macs (avoid running on two Macs concurrently)."}),(0,s.jsxs)("div",{className:"mt-3",children:[(0,s.jsx)("div",{className:"text-xs text-zinc-500 mb-1",children:"iCloud path"}),(0,s.jsx)("input",{disabled:"icloud"!==S.storage.mode,value:S.storage.icloudPath??"",onChange:e=>E(t=>({...t,storage:{...t.storage,icloudPath:e.target.value}})),placeholder:C.icloudDir??"iCloud Drive path",className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none disabled:opacity-60"}),(0,s.jsxs)("div",{className:"mt-2 text-[11px] text-zinc-600",children:["Leave blank to use the default: ",(0,s.jsx)("span",{className:"text-zinc-400",children:C.icloudDir??"N/A"})]})]})]})]})]}),f?(0,s.jsx)("div",{className:"mt-4 text-sm text-red-400",children:f}):null,g?(0,s.jsx)("div",{className:"mt-4 rounded-lg border border-amber-900/40 bg-amber-950/20 px-3 py-2 text-sm text-amber-200",children:"Saved. Close and reopen the app to apply storage changes (and move your library if you changed storage)."}):null,(0,s.jsxs)("div",{className:"mt-4 flex items-center gap-3",children:[(0,s.jsx)("button",{disabled:!u||h,onClick:()=>A(),className:"rounded-lg bg-zinc-50 px-4 py-2 text-sm font-medium text-zinc-950 disabled:opacity-60",children:h?"Saving…":"Save"}),"icloud"===S.storage.mode&&R?(0,s.jsxs)("div",{className:"text-xs text-zinc-500",children:["Effective path: ",(0,s.jsx)("span",{className:"text-zinc-300",children:R})]}):null]})]}),(0,s.jsxs)("div",{className:"mt-8 rounded-xl border border-zinc-800 bg-zinc-950 p-4",children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:"AI"}),(0,s.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:"Configure the AI endpoint used by the bundled worker. If you see “failed”, it often means the app couldn’t reach the endpoint at the time."}),(0,s.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"mb-2 text-xs text-zinc-500",children:"Provider"}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,s.jsx)("input",{type:"radio",name:"ai_provider",checked:"local_station"===S.ai.provider,onChange:()=>E(e=>({...e,ai:{...e.ai,provider:"local_station"}})),className:"mt-1"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm text-zinc-200",children:"Local Station"}),(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"Uses Moondream Station running on your machine."})]})]}),(0,s.jsxs)("label",{className:"flex items-start gap-3 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,s.jsx)("input",{type:"radio",name:"ai_provider",checked:"huggingface"===S.ai.provider,onChange:()=>E(e=>({...e,ai:{...e.ai,provider:"huggingface",endpoint:(e.ai.endpoint||"").trim()?e.ai.endpoint:C.hfEndpointUrl}})),className:"mt-1"}),(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsx)("div",{className:"text-sm text-zinc-200",children:"Hugging Face Endpoint"}),(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"Uses a Hugging Face Inference Endpoint (requires endpoint URL + API token)."})]})]})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"mb-1 text-xs text-zinc-500",children:"huggingface"===S.ai.provider?"Hugging Face endpoint URL":"Moondream Station endpoint"}),(0,s.jsx)("input",{value:S.ai.endpoint??"",onChange:e=>E(t=>({...t,ai:{...t.ai,endpoint:e.target.value}})),placeholder:"huggingface"===S.ai.provider?C.hfEndpointUrl:C.moondreamEndpoint,className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none"}),(0,s.jsx)("div",{className:"mt-2 text-[11px] text-zinc-600",children:"huggingface"===S.ai.provider?(0,s.jsx)(s.Fragment,{children:"Paste the full endpoint URL for your Hugging Face Inference Endpoint."}):(0,s.jsxs)(s.Fragment,{children:["Examples: ",(0,s.jsx)("span",{className:"text-zinc-400",children:"http://127.0.0.1:2021/v1"})," or"," ",(0,s.jsx)("span",{className:"text-zinc-400",children:"http://127.0.0.1:2020"})," (the worker accepts both and normalizes). If ",(0,s.jsx)("span",{className:"text-zinc-400",children:"localhost"})," gives issues, prefer"," ",(0,s.jsx)("span",{className:"text-zinc-400",children:"127.0.0.1"}),"."]})})]}),"huggingface"===S.ai.provider?(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"mb-1 flex items-center justify-between",children:[(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"Hugging Face API token"}),C.hfTokenSet?(0,s.jsx)("div",{className:"text-[11px] text-zinc-500",children:"Token saved"}):null]}),(0,s.jsx)("input",{value:P,onChange:e=>F(e.target.value),placeholder:C.hfTokenSet?"•••••••••• (leave blank to keep existing)":"hf_...",type:"password",autoComplete:"off",className:"w-full rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-xs text-zinc-200 outline-none"}),(0,s.jsx)("div",{className:"mt-2 text-[11px] text-zinc-600",children:"Stored locally in your app settings. The worker uses it as a Bearer token."}),C.hfTokenSet?(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)("button",{disabled:!u||h,onClick:()=>A({clearHfToken:!0}),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:"Clear saved token"})}):null]}):null,(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("button",{disabled:!u||h,onClick:()=>A(),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:h?"Saving…":"Save endpoint"}),(0,s.jsx)("button",{disabled:!n,onClick:async()=>{if(n){j(null),y(null),z(!0);try{let e=await fetch(`/api/projects/${n}/ai/retry`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!e.ok)throw Error("Retry failed");let t=await e.json().catch(()=>null),s=t?.changes??0;y(s>0?`Retried ${s} asset(s).`:"No failed assets to retry.")}catch(e){j(e.message)}finally{z(!1)}}},className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-900 disabled:opacity-50",children:N?"Retrying…":"Retry failed AI (this project)"}),n?null:(0,s.jsx)("div",{className:"text-xs text-zinc-600",children:"Open Settings from inside a project to enable this."})]}),b?(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:b}):null,(0,s.jsxs)("div",{className:"mt-6 rounded-lg border border-zinc-900 bg-zinc-950 px-3 py-3",children:[(0,s.jsx)("div",{className:"text-xs font-medium text-zinc-200",children:"Worker activity"}),(0,s.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-x-6 gap-y-1 text-xs text-zinc-500",children:[(0,s.jsxs)("div",{children:["Pending: ",(0,s.jsx)("span",{className:"text-zinc-200",children:w?w.counts.pending:"—"})]}),(0,s.jsxs)("div",{children:["Processing: ",(0,s.jsx)("span",{className:"text-zinc-200",children:w?w.counts.processing:"—"})]}),(0,s.jsxs)("div",{children:["Done: ",(0,s.jsx)("span",{className:"text-zinc-200",children:w?w.counts.done:"—"})]}),(0,s.jsxs)("div",{children:["Failed: ",(0,s.jsx)("span",{className:"text-zinc-200",children:w?w.counts.failed:"—"})]})]}),(0,s.jsx)("div",{className:"mt-2 text-xs text-zinc-500",children:w?.worker.currentFile?(0,s.jsxs)(s.Fragment,{children:["Currently processing: ",(0,s.jsx)("span",{className:"text-zinc-200",children:w.worker.currentFile})]}):w?.worker.logAvailable?(0,s.jsx)(s.Fragment,{children:"Worker is idle (no “processing …” line in recent logs)."}):(0,s.jsx)(s.Fragment,{children:"Worker log not found (desktop-only; this is expected in some dev setups)."})}),w?.worker.lastLogAt?(0,s.jsxs)("div",{className:"mt-1 text-[11px] text-zinc-600",children:["Last worker output: ",(0,s.jsx)("span",{className:"text-zinc-400",children:w.worker.lastLogAt})]}):null,w?.worker.logAvailable?(0,s.jsxs)("details",{className:"mt-3",children:[(0,s.jsx)("summary",{className:"cursor-pointer text-xs text-zinc-400 hover:text-zinc-200",children:"Recent worker log"}),(0,s.jsx)("pre",{className:"mt-2 max-h-56 overflow-auto rounded-md border border-zinc-900 bg-black/40 p-2 text-[11px] leading-relaxed text-zinc-300",children:(w?.worker.recentLines||[]).join("\n")})]}):null]})]})]})]})]})}}},e=>{e.O(0,[441,794,358],()=>e(e.s=6943)),_N_E=e.O()}]);